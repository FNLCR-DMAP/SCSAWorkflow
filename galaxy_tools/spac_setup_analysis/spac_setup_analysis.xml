<tool id="spac_setup_analysis" name="Setup Analysis [SPAC] [DMAP]" version="1.0.0" profile="21.05">
        <description>Convert the pre-processed dataset to the analysis object for downstream analysis.</description>
        
        <requirements>
            <container type="docker">nciccbr/spac:v1</container>
        </requirements>
        
        <environment_variables>
            <variable name="SPAC_PYTHON">python3</variable>
        </environment_variables>
        
        <command detect_errors="exit_code"><![CDATA[
            ## Ensure log file exists
            : > tool_stdout.txt &&
            
            ## Run the universal wrapper (template name without .py extension)
            bash $__tool_directory__/run_spac_template.sh "$params_json" setup_analysis
        ]]></command>
        
        <configfiles>
            <!-- Galaxy serializes all inputs including hidden 'outputs' to this JSON -->
            <inputs name="params_json" filename="params.json" data_style="paths"/>
        </configfiles>
        
        <inputs>
            <param name="Upstream_Dataset" type="data" format="csv,tabular" label="Upstream Dataset" help="Link to prior processed dataset in the analysis."/>
        <param name="X_Coordinate_Column" type="data_column" data_ref="Upstream_Dataset" multiple="false" numerical="true" use_header_names="true" optional="false" label="X Coordinate Column" help="The name of the column containing the X coordinate, default if XMax."/>
        <param name="Y_Coordinate_Column" type="data_column" data_ref="Upstream_Dataset" multiple="false" numerical="true" use_header_names="true" optional="false" label="Y Coordinate Column" help="The name of the column containing the Y coordinate, default if YMax."/>
        <param name="Annotation_s_" type="data_column" data_ref="Upstream_Dataset" multiple="true" numerical="false" use_header_names="true" optional="false" label="Annotation(s)" help="The annotation(s) of interest to include in downstream analysis."/>
        <param name="Features_to_Analyze" type="data_column" data_ref="Upstream_Dataset" multiple="true" numerical="true" use_header_names="true" optional="false" label="Features to Analyze" help="A list of feature name(s) for downstream analysis."/>
        <param name="Feature_Regex" type="text" area="true" value="[]" label="Feature Regex" help="A list of regex pattern(s) to search for features for downstream analysis. Regex example, if all features of interest ending with &quot;Intensity&quot;, use .*Intensity$, The .* means anything before the target pattern, and $ means the end of the string. (Enter as comma-separated list or one per line)"/>

        <!-- Hidden parameter to pass outputs specification to wrapper -->
        <param name="outputs" type="hidden" value='{"analysis": "transform_output.pickle"}'/>
        </inputs>
        
        <outputs>
            <data name="analysis" format="pickle" from_work_dir="transform_output.pickle" label="${tool.name} on ${on_string}: Analysis"/>
        <data name="config_used" format="json" from_work_dir="config_used.json" label="${tool.name} on ${on_string}: Parameters Used"/>
        <data name="execution_log" format="txt" from_work_dir="tool_stdout.txt" label="${tool.name} on ${on_string}: Execution Log"/>
        </outputs>
        
        <help><![CDATA[
            **Setup Analysis [SPAC] [DMAP]**
            
            Convert the pre-processed dataset to the analysis object for downstream analysis.
[GitHub Documentation](https://fnlcr-dmap.github.io/SCSAWorkflow/spac.html#spac.data_utils.ingest_cells) for further information.
            
            This tool is part of the SPAC (SPAtial single-Cell analysis) toolkit.
            
            **Input Format Notes:**
            - For list parameters: Use comma-separated values or one item per line
            - To select all items: Enter "All"
        ]]></help>
        
        <citations>
            <citation type="bibtex">
    @misc{spac_toolkit,
        author = {FNLCR DMAP Team},
        title = {SPAC: SPAtial single-Cell analysis},
        year = {2024},
        url = {https://github.com/FNLCR-DMAP/SCSAWorkflow}
    }
            </citation>
        </citations>
    </tool>