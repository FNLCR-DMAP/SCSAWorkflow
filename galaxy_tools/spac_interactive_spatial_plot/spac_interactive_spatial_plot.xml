<tool id="spac_interactive_spatial_plot" name="Interactive Spatial Plot [SPAC] [DMAP]" version="1.0.1" profile="21.05">
    <description>Creates interactive, real-time visual explorations of single-cell spatial data for in-depth analysis.</description>
    
    <requirements>
        <container type="docker">nciccbr/spac:v1</container>
    </requirements>
    
    <environment_variables>
        <variable name="SPAC_PYTHON">python3</variable>
    </environment_variables>
    
    <command detect_errors="exit_code"><![CDATA[
        ## Make sure Galaxy will always have a log file to display
        : > tool_stdout.txt &&
        
        ## Run the universal wrapper
        bash $__tool_directory__/run_spac_template.sh "$params_json" interactive_spatial_plot
    ]]></command>
    
    <configfiles>
        <inputs name="params_json" filename="params.json" data_style="paths"/>
    </configfiles>
    
    <inputs>
        <param name="Upstream_Analysis" type="data" format="h5ad,binary,pickle" label="Upstream Analysis" help="Link to prior processed dataset in the analysis."/>
        <param name="Stratify_By" type="text" value="None" label="Stratify By" help="The annotation to stratify the dataset when generating interaction plots. If single annotation is passed, the dataset will be stratified by the unique labels in the annotation column. Use &quot;None&quot; without quotes to disable."/>
        <param name="Color_By" type="select" label="Color By" help="Color the points in the plot by either their corresponding feature or annotation">
            <option value="Annotation" selected="true">Annotation</option>
            <option value="Feature">Feature</option>
        </param>
        <param name="Annotation_s_to_Highlight" type="text" area="true" value="[&quot;&quot;]" label="Annotation(s) to Highlight" help="Annotation(s) to visualize in the analysis. The interactive plot will show all the labels in the annotation(s) passed. (Enter as comma-separated list, JSON array, or one per line)"/>
        <param name="Feature_to_Highlight" type="text" value="None" label="Feature to Highlight" help="Feature name in the analysis to use for coloring the cells in the scatter plot based on the feature value. Can&apos;t be used with Annotation."/>
        <param name="Table" type="text" value="Original" label="Table" help="Source table to perform the visualization. Default is Original, referring to the raw dataset."/>
        <param name="Font_Size" type="float" value="12" label="Font Size" help="Font size for the plot."/>
        <param name="Dot_Size" type="float" value="1.5" label="Dot Size" help="Size of dot in the plot."/>
        <param name="Dot_Transparency" type="float" value="0.75" label="Dot Transparency" help="Transparency of the dot in the plot."/>
        <param name="Flip_Vertical_Axis" type="boolean" truevalue="True" falsevalue="False" checked="false" label="Flip Vertical Axis" help="If True, flip the vertical axis."/>
        <param name="Figure_Width" type="float" value="6" label="Figure Width" help="Figure width in inch."/>
        <param name="Figure_Height" type="float" value="4" label="Figure Height" help="Figure height in inch."/>
        <param name="Define_Label_Color_Mapping" type="text" value="None" label="Define Label Color Mapping" help="Name of the color map to use for labels in the plot. The color map should be appended through the Append Pin Color Rule template prior to the current visualization. The default &quot;None&quot; will allow the visualization to determine the color of labels automatically."/>
        <param name="Figure_DPI" type="float" value="200" label="Figure DPI" help="The higher the DPI, the higher the image resolution."/>
        <param name="Feature_Color_Scale" type="select" label="Feature Color Scale" help="Color scale to use when dot colors are defined by features. Check the link in the template description.">
            <option value="balance" selected="true">balance</option>
            <option value="Picnic">Picnic</option>
        </param>
        <param name="Lower_Colorbar_Bound" type="float" value="999" label="Lower Colorbar Bound" help="The lower bound of the colorbar scale. The default 999 will set to the minimum of the dataset."/>
        <param name="Upper_Colorbar_Bound" type="float" value="-999" label="Upper Colorbar Bound" help="The upper bound of the colorbar scale. The default -999 will set to the maximum of the dataset."/>
        
        <param name="outputs" type="hidden" value='{"html":"html_folder"}'/>
    </inputs>
    
    <outputs>
        <!-- Primary output: unsanitized HTML for interactive content -->
        <data name="html_output" format="html" from_work_dir="html_folder/interactive_spatial_plot.html" 
              label="${tool.name} on ${on_string}: Interactive Plot">
            <!-- Allow unsanitized HTML for interactive content -->
            <sanitize sanitize="False"/>
        </data>
        
        <!-- Collection for multiple HTML files if generated -->
        <collection name="html_outputs" type="list" label="${tool.name} on ${on_string}: HTML Reports">
            <discover_datasets pattern="(?P&lt;name&gt;.+)\.html" directory="html_folder" format="html"/>
        </collection>
        <data name="config_used" format="json" from_work_dir="config_used.json" label="${tool.name} on ${on_string}: Parameters Used"/>
        <data name="execution_log" format="txt" from_work_dir="tool_stdout.txt" label="${tool.name} on ${on_string}: Execution Log"/>
    </outputs>
    
    <help><![CDATA[
        **Interactive Spatial Plot [SPAC] [DMAP]**
        
        Creates interactive, real-time visual explorations of single-cell spatial data for in-depth analysis. For color map strings, please refer to [Built-in Continuous Color Scales in Python](https://plotly.com/python/builtin-colorscales/).
        
        This tool is part of the SPAC (Spatial Analysis Collection) toolkit.
        
        **Input Format Notes:**
        - For manual list entry: Use comma-separated values (e.g., CD25, CD20)
        - Or use JSON array format: ["CD25", "CD20"]
        - Or enter one item per line
        - To select all items: Enter "All"
    ]]></help>
    
    <citations>
        <citation type="bibtex">
@misc{spac_toolkit,
    author = {FNLCR DMAP Team},
    title = {SPAC: SPAtial single-Cell analysis},
    year = {2023},
    url = {https://github.com/FNLCR-DMAP/SCSAWorkflow}
}
        </citation>
    </citations>
</tool>