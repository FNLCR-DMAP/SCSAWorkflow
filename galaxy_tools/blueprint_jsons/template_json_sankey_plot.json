{
  "rid": "ri.vector.main.template.c8d8efaa-d3a6-4a29-9ac2-4e240581cdb9",
  "title": "Sankey Plot [SPAC] [DMAP]",
  "description": "Generates a static and an interactive Sankey plot to visualize annotation relationships.  A relationship is defined as a unique pair of values, one from the source annotation and one from the target annotation.\\\nPlease refer to [DUET Documentation](https://nidap.nih.gov/workspace/notepad/view/ri.notepad.main.notepad.54846ff7-2aa1-4d6b-ac9e-791696c18e63) and [GitHub Documentation](https://fnlcr-dmap.github.io/SCSAWorkflow/spac.html#spac.visualization.sankey_plot) for further information.",
  "createdBy": "391048e4-979e-4237-a0f4-9f34b125a427",
  "createdAt": "2024-10-31T16:36:00.388592875Z",
  "commitMessage": "update text_to_value",
  "status": "RELEASED",
  "inputDatasets": [
    {
      "key": "Upstream_Analysis",
      "displayName": "Upstream Analysis",
      "description": "Link to prior processed dataset in the analysis.",
      "paramGroup": null,
      "anchorDataset": null,
      "dataType": "PYTHON_TRANSFORM_INPUT",
      "tags": []
    }
  ],
  "parameters": [
    {
      "key": "Source_Annotation_Name",
      "displayName": "Source Annotation Name",
      "description": "Name of the source annotation column. Display at the left of the Sankey plot.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "None",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Target_Annotation_Name",
      "displayName": "Target Annotation Name",
      "description": "Name of the target annotation column. Display at the right of the Sankey plot.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "None",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Source_Annotation_Color_Map",
      "displayName": "Source Annotation Color Map",
      "description": "Colormap of source annotation, default is tab20. Please refer to [Matplotlib Colormap](https://matplotlib.org/stable/users/explain/colors/colormaps.html) for further information",
      "paramType": "SELECT",
      "paramGroup": null,
      "paramValues": [
        "Pastel1",
        "Pastel2",
        "Paired",
        "Accent",
        "Dark2",
        "Set1",
        "Set2",
        "Set3",
        "tab10",
        "tab20",
        "tab20b",
        "tab20c",
        "binary",
        "gist_yarg",
        "gist_gray",
        "gray",
        "bone",
        "viridis",
        "plasma",
        "inferno",
        "magma",
        "cividis",
        "pink",
        "spring",
        "summer",
        "autumn",
        "winter",
        "cool",
        "Wistia",
        "hot",
        "afmhot",
        "gist_heat",
        "copper",
        "Greys",
        "Purples",
        "Blues",
        "Greens",
        "Oranges",
        "Reds",
        "YlOrBr",
        "YlOrRd",
        "OrRd",
        "PuRd",
        "RdPu",
        "BuPu",
        "GnBu",
        "PuBu",
        "YlGnBu",
        "PuBuGn",
        "BuGn",
        "YlGn"
      ],
      "defaultValue": "tab20",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Target_Annotation_Color_Map",
      "displayName": "Target Annotation Color Map",
      "description": "Colormap of target annotation, default is tab20b. Please refer to [Matplotlib Colormap](https://matplotlib.org/stable/users/explain/colors/colormaps.html) for further information",
      "paramType": "SELECT",
      "paramGroup": null,
      "paramValues": [
        "Pastel1",
        "Pastel2",
        "Paired",
        "Accent",
        "Dark2",
        "Set1",
        "Set2",
        "Set3",
        "tab10",
        "tab20",
        "tab20b",
        "tab20c",
        "binary",
        "gist_yarg",
        "gist_gray",
        "gray",
        "bone",
        "viridis",
        "plasma",
        "inferno",
        "magma",
        "cividis",
        "pink",
        "spring",
        "summer",
        "autumn",
        "winter",
        "cool",
        "Wistia",
        "hot",
        "afmhot",
        "gist_heat",
        "copper",
        "Greys",
        "Purples",
        "Blues",
        "Greens",
        "Oranges",
        "Reds",
        "YlOrBr",
        "YlOrRd",
        "OrRd",
        "PuRd",
        "RdPu",
        "BuPu",
        "GnBu",
        "PuBu",
        "YlGnBu",
        "PuBuGn",
        "BuGn",
        "YlGn"
      ],
      "defaultValue": "tab20b",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Figure_Width_inch",
      "displayName": "Figure Width, inch",
      "description": "Figure Width, inch",
      "paramType": "NUMBER",
      "paramGroup": "Figure Configuration parameters",
      "paramValues": null,
      "defaultValue": "6",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Figure_Height_inch",
      "displayName": "Figure Height, inch",
      "description": "Figure Height, inch",
      "paramType": "NUMBER",
      "paramGroup": "Figure Configuration parameters",
      "paramValues": null,
      "defaultValue": "6",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Figure_DPI",
      "displayName": "Figure DPI",
      "description": "Dots Per squared Inch, higher the value, better the image quality",
      "paramType": "NUMBER",
      "paramGroup": "Figure Configuration parameters",
      "paramValues": null,
      "defaultValue": "300",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Font_Size",
      "displayName": "Font Size",
      "description": "Font Size",
      "paramType": "NUMBER",
      "paramGroup": "Figure Configuration parameters",
      "paramValues": null,
      "defaultValue": "12",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    }
  ],
  "columns": [],
  "orderedMustacheKeys": [
    "Upstream_Analysis",
    "Source_Annotation_Name",
    "Target_Annotation_Name",
    "Source_Annotation_Color_Map",
    "Target_Annotation_Color_Map",
    "Figure_Width_inch",
    "Figure_Height_inch",
    "Figure_DPI",
    "Font_Size"
  ],
  "contents": {
    "type": "code",
    "code": {
      "codeLanguage": "PYTHON",
      "codeTemplate": "@synchronous_node_execution\ndef unnamed_12({{{Upstream_Analysis}}}):\n\n    ## --------- ##\n    ## Libraries ##\n    ## --------- ##\n\n    from spac.visualization import sankey_plot\n    import matplotlib.pyplot as plt    \n    import pickle\n    import plotly.io as pio \n    from code_workbook_utils.utils import text_to_value\n\n    ## -------------------------------- ##\n    ## User-Defined Template Parameters ##\n    ## -------------------------------- ##\n    NIDAP_dataset = {{{Upstream_Analysis}}}.filesystem()\n    with NIDAP_dataset.open(\"transform_output.pickle\", \"rb\") as input_file:\n        adata = pickle.load(input_file)\n\n    annotation_columns = ['{{{Source_Annotation_Name}}}', '{{{Target_Annotation_Name}}}']\n    dpi = {{{Figure_DPI}}}\n    width_num = {{{Figure_Width_inch}}}\n    scale = dpi / 96\n    width_in_pixels = width_num / scale * dpi\n\n    height_num = {{{Figure_Height_inch}}}\n    height_in_pixels = height_num / scale * dpi\n\n    sort_asscend = True\n    source_color_map = '{{{Source_Annotation_Color_Map}}}'\n    target_color_map = '{{{Target_Annotation_Color_Map}}}'\n\n    sankey_font = {{{Font_Size}}}\n\n    ##--------------- ##\n    ## Error Messages ##\n    ## -------------- ##\n\n    ## --------- ##\n    ## Functions ##\n    ## --------- ##\n\n\n    ## --------------- ##\n    ## Main Code Block ##\n    ## --------------- ##\n    ################################\n\n    target_annotation = text_to_value(annotation_columns[1])\n    source_annotation = text_to_value(annotation_columns[0])\n\n    fig = sankey_plot(\n            adata=adata,\n            source_annotation=source_annotation,\n            target_annotation=target_annotation,\n            source_color_map=source_color_map,\n            target_color_map=target_color_map,\n            sankey_font=sankey_font\n        )\n\n    # Customize the Sankey diagram layout\n    fig.update_layout(\n        width=width_in_pixels,  # Specify the width in pixels\n        height=height_in_pixels   # Specify the height in pixels\n    )\n\n    # Show the plot with the specified display options\n    print(fig)\n\n    image_path = 'sankey_diagram.png'\n\n    pio.write_image(\n        fig,\n        image_path,\n        width=width_in_pixels,  # Specify the width in pixels\n        height=height_in_pixels,\n        engine='kaleido',  # Use the 'kaleido' engine for high DPI images\n        scale=scale\n    )\n\n    img = plt.imread(image_path)\n    static, axs = plt.subplots(1, 1, figsize=(width_num, height_num), dpi=dpi) \n\n    # Load and display the image using Matplotlib\n    axs.imshow(img)\n    axs.axis('off')\n    plt.show()\n\n\n    fig.show()\n\n    return(None)\n\n#################################################\n## Global imports and functions included below ##\n#################################################\n\n\n",
      "shouldPersist": true
    }
  },
  "version": 12,
  "externalId": null,
  "canEditTemplate": true,
  "path": "/NIDAP/NCI-Wide Analysis & Visualization Resources/SPAC/SPAC Templates/Sankey Plot [SPAC] [DMAP]",
  "tags": [
    {
      "rid": "ri.compass.main.tag.02094a7d-d869-4dff-bc31-78ad8676d1ad",
      "name": "Code Templates:DMAP"
    },
    {
      "rid": "ri.compass.main.tag.ebb2ab0f-e354-4bd4-9f3a-e78dc8452986",
      "name": "Code Templates:SPAC"
    }
  ],
  "favorite": false,
  "namedCollections": [],
  "isDefault": true,
  "condaDependencies": [
    "python=3.6"
  ],
  "outputDatasetName": "New Dataset",
  "outputs": {
    "figures": {"type": "directory", "name": "figures_dir"},
    "html": {"type": "directory", "name": "html_dir"}
  }
}