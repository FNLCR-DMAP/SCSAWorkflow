{
  "rid": "ri.vector.main.template.fea96dbd-f5a4-41b4-b3e5-6e32fea5ef4a",
  "title": "UTAG Clustering [SPAC] [DMAP]",
  "description": "Discover spatial tissue domains (tissue micro\u2011environments) by combining phenotypes (feature intensities) and spatial proximity of cells with UTAG (Unsupervised discovery of Tissue Architecture by Graph message passing). Clusters are stored in the analysis as the annotation \u201cUTAG\u201d.\\\nPlease refer to [DUET Documentation](https://nidap.nih.gov/workspace/notepad/view/ri.notepad.main.notepad.d210952f-f342-4342-9e31-464572cf7b18), [GitHub Documentation](https://fnlcr-dmap.github.io/SCSAWorkflow/modules/spac.transformations.run_utag_clustering.html#spac.transformations.run_utag_clustering) for further information.",
  "createdBy": "391048e4-979e-4237-a0f4-9f34b125a427",
  "createdAt": "2025-05-30T18:47:08.244512611Z",
  "commitMessage": "spac v0.9.0 correct github link",
  "status": "RELEASED",
  "inputDatasets": [
    {
      "key": "Upstream_Analysis",
      "displayName": "Upstream Analysis",
      "description": "Link to prior processed dataset in the analysis.",
      "paramGroup": null,
      "anchorDataset": null,
      "dataType": "PYTHON_TRANSFORM_INPUT",
      "tags": []
    }
  ],
  "parameters": [
    {
      "key": "Table_to_Process",
      "displayName": "Table to Process",
      "description": "Source table to perform the computation. The default value \"Original\" will use the raw dataset.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "Original",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Features",
      "displayName": "Features",
      "description": "List specific features for clustering. Default \"All\" will use all features",
      "paramType": "LIST",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "All",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Slide_Annotation",
      "displayName": "Slide Annotation",
      "description": "Name of the annotation column that identifies each image/slide. Default is \"None\" if not applicable.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "None",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "PCA_Components",
      "displayName": "PCA Components",
      "description": "Number of principal components to keep. Default is \"None\" to skip PCA (good for small datasets).",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "None",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "K_Nearest_Neighbors",
      "displayName": "K-Nearest Neighbors",
      "description": "Number of nearest neighbors used when building the graph for clustering.",
      "paramType": "INTEGER",
      "paramMin": "1",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "15",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Resolution_Parameter",
      "displayName": "Resolution Parameter",
      "description": "Higher values give more, smaller clusters; lower values give fewer, larger clusters.",
      "paramType": "NUMBER",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "1",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Distance_Threshold",
      "displayName": "Distance Threshold",
      "description": "How far (in micrometres) two cells can be apart and still be considered neighbors.",
      "paramType": "NUMBER",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "20.0",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Random_Seed",
      "displayName": "Random Seed",
      "description": "Ensures results are reproducible when re\u2011run the template.",
      "paramType": "INTEGER",
      "paramMin": "1",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "42",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Leiden_Iterations",
      "displayName": "Leiden Iterations",
      "description": "How many times the Leiden algorithm refines the clusters.",
      "paramType": "INTEGER",
      "paramMin": "1",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "5",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Output_Annotation_Name",
      "displayName": "Output Annotation Name",
      "description": "The new column that will store the UTAG domain labels.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "UTAG",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Parellel_Processes",
      "displayName": "Parellel Processes",
      "description": "For multiple slides (images) and several CPU cores, split the data by Slide and run the message\u2011passing step for each slide in parallel. Default is False.",
      "paramType": "BOOLEAN",
      "paramGroup": "Parellel Jobs parameters",
      "paramValues": null,
      "defaultValue": "False",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "N_Jobs",
      "displayName": "N-Jobs",
      "description": "When Parallel Processes is True,  the number of jobs to run in parallel. Default is 1.",
      "paramType": "INTEGER",
      "paramMin": "1",
      "paramGroup": "Parellel Jobs parameters",
      "paramValues": null,
      "defaultValue": "1",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    }
  ],
  "columns": [],
  "orderedMustacheKeys": [
    "Upstream_Analysis",
    "Table_to_Process",
    "Features",
    "Slide_Annotation",
    "PCA_Components",
    "K_Nearest_Neighbors",
    "Resolution_Parameter",
    "Distance_Threshold",
    "Random_Seed",
    "Leiden_Iterations",
    "Output_Annotation_Name",
    "Parellel_Processes",
    "N_Jobs"
  ],
  "contents": {
    "type": "code",
    "code": {
      "codeLanguage": "PYTHON",
      "codeTemplate": "# DEV - UTAG Clustering [SPAC] [DMAP] (fea96dbd-f5a4-41b4-b3e5-6e32fea5ef4a): v2\ndef utag_clustering({{{Upstream_Analysis}}}):\n\n    ## --------- ##\n    ## Libraries ##\n    ## --------- ##\n    from spac.transformations import run_utag_clustering\n    import pickle\n    from code_workbook_utils.utils import text_to_value \n\n    ## ----------------------------- ##\n    ## User\u2011friendly parameters      ##\n    ## ----------------------------- ##\n    NIDAP_dataset = {{{Upstream_Analysis}}}.filesystem()\n    with NIDAP_dataset.open(\"transform_output.pickle\", \"rb\") as input_file:\n        adata = pickle.load(input_file)\n\n    layer = \"{{{Table_to_Process}}}\"            # Which layer to analyse (\u201cOriginal\u201d \u2192 None)\n    features = {{{Features}}}                   # e.g. ['CD3','CD4']; [\"All\"] \u2192 all features\n    slide = \"{{{Slide_Annotation}}}\"                    # Batch column (\u201cNone\u201d \u2192 None)\n    Distance_threshold = {{{Distance_Threshold}}}       # \u00b5m radius for neighbour graph\n    K_neighbors = {{{K_Nearest_Neighbors}}}             # k in k\u2011NN graph\n    resolution = {{{Resolution_Parameter}}}             # Leiden resolution\n    principal_components = \"{{{PCA_Components}}}\"       # None skips PCA for tiny datasets\n    random_seed = {{{Random_Seed}}}\n    n_jobs = {{{N_Jobs}}}                               # Number of jobs to run in parallel. \n    N_iterations = {{{Leiden_Iterations}}}              # Leiden iterations\n    Parallel_processes = {{{Parellel_Processes}}}                   \n    output_annotation = \"{{{Output_Annotation_Name}}}\"   # Column name to be added\n\n    ## --------------- ##\n    ## Main Code Block ##\n    ## --------------- ##\n\n    # layer: convert \"Original\" \u2192 None\n    layer_arg = None if layer.lower().strip() == \"original\" else layer\n\n    # features: [\"All\"] \u2192 None, else leave list and print selection\n    if isinstance(features, list) and any(item == \"All\" for item in features):\n        print(\"Clustering all features\")\n        features_arg = None\n    else:\n        feature_str = \"\\n\".join(features)\n        print(f\"Clustering features:\\n{feature_str}\")\n        features_arg = features\n\n    # slide: \"None\" \u2192 None\n    slide_arg = text_to_value(\n        slide,\n        default_none_text=\"None\",\n        value_to_convert_to=None\n    )\n\n    # principal_components: \"None\" or integer string \u2192 None or int\n    principal_components_arg = text_to_value(\n        principal_components,\n        default_none_text=\"None\",\n        value_to_convert_to=None,\n        to_int=True,\n        param_name=\"principal_components\"\n    )\n\n    print(\"\\nBefore UTAG Clustering: \\n\", adata)\n\n    run_utag_clustering(\n        adata,\n        features = features_arg,\n        k = K_neighbors,\n        resolution = resolution,\n        max_dist = Distance_threshold,\n        n_pcs = principal_components_arg,\n        random_state = random_seed,\n        n_jobs = n_jobs,\n        n_iterations = N_iterations,\n        slide_key = slide_arg,\n        layer = layer_arg,\n        output_annotation = output_annotation,\n        parallel = Parallel_processes,\n    )\n\n    print(\"\\nAfter UTAG Clustering: \\n\", \n        adata)\n\n    print(\"\\nUTAG Cluster Count: \\n\", \n        len(adata.obs[output_annotation].unique().tolist()))\n\n    print(\"\\nUTAG Cluster Names: \\n\", \n        adata.obs[output_annotation].unique().tolist())\n\n    # Count and display occurrences of each label in the annotation\n    print(f'\\nCount of cells in the output annotation:\"{output_annotation}\":')\n    label_counts = adata.obs[output_annotation].value_counts()\n    print(label_counts)\n    print(\"\\n\")\n\n    output = Transforms.get_output()\n    output_fs = output.filesystem()\n    with output_fs.open('transform_output.pickle', 'wb') as f:\n        pickle.dump(adata, f)\n\n    return None\n\n\n#################################################\n## Global imports and functions included below ##\n#################################################\n\n\n",
      "shouldPersist": true
    }
  },
  "version": 8,
  "externalId": null,
  "canEditTemplate": true,
  "path": "/NIDAP/NCI-Wide Analysis & Visualization Resources/SPAC/SPAC Templates/UTAG Clustering [SPAC] [DMAP]",
  "tags": [],
  "favorite": false,
  "namedCollections": [],
  "isDefault": true,
  "condaDependencies": [
    "python=3.6"
  ],
  "outputDatasetName": "UTAG_clustering",
  "outputs": {
    "analysis": {"type": "file", "name": "output.pickle"}
  }
}