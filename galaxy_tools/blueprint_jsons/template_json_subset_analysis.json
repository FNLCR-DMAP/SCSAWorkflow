{
  "rid": "ri.vector.main.template.b5045e24-be0f-4927-b448-109f65d6f94a",
  "title": "Subset Analysis [SPAC] [DMAP]",
  "description": "Chooses cells that either include or exclude specific label(s) within a designated annotation for downstream analysis.\\\nPlease refer to [DUET Documentation](https://nidap.nih.gov/workspace/notepad/view/ri.notepad.main.notepad.e83a8a7c-fa9d-4bcf-86c9-a43a9185d1f8), [GitHub Documentation](https://fnlcr-dmap.github.io/SCSAWorkflow/spac.html#spac.data_utils.select_values)",
  "createdBy": "391048e4-979e-4237-a0f4-9f34b125a427",
  "createdAt": "2025-01-22T16:46:42.140182008Z",
  "commitMessage": "released spac v0.8.2",
  "status": "RELEASED",
  "inputDatasets": [
    {
      "key": "Upstream_Analysis",
      "displayName": "Upstream Analysis",
      "description": "Link to prior processed dataset in the analysis",
      "paramGroup": null,
      "anchorDataset": null,
      "dataType": "PYTHON_TRANSFORM_INPUT",
      "tags": []
    }
  ],
  "parameters": [
    {
      "key": "Annotation_of_interest",
      "displayName": "Annotation of interest",
      "description": "Annotation of interest to select labels from.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": null,
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Labels",
      "displayName": "Labels",
      "description": "Label(s) of interest to be included/excluded from the selected annotation.",
      "paramType": "LIST",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "[\"\"]",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Include_Exclude",
      "displayName": "Include / Exclude",
      "description": "Set the functionality to either \"Include\" or \"Exclude\" selected labels",
      "paramType": "SELECT",
      "paramGroup": null,
      "paramValues": [
        "Include Selected Labels",
        "Exclude Selected Labels"
      ],
      "defaultValue": "Include Selected Labels",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    }
  ],
  "columns": [],
  "orderedMustacheKeys": [
    "Upstream_Analysis",
    "Annotation_of_interest",
    "Labels",
    "Include_Exclude"
  ],
  "contents": {
    "type": "code",
    "code": {
      "codeLanguage": "PYTHON",
      "codeTemplate": "# Select Values [SPAC] [DMAP] (344dc026-20f6-4c0a-be43-0e820738e7a7): v14\ndef subset_cell_labels({{{Upstream_Analysis}}}):\n    ## --------- ##\n    ## Libraries ##\n    ## --------- ##\n\n    from spac.data_utils import select_values\n    import warnings\n    import pickle\n    import pandas as pd\n\n    ## -------------------------------- ##\n    ## User-Defined Template Parameters ##\n    ## -------------------------------- ##\n\n    NIDAP_dataset = {{{Upstream_Analysis}}}.filesystem()\n    with NIDAP_dataset.open(\"transform_output.pickle\", \"rb\") as input_file:\n        adata = pickle.load(input_file)\n        # print(f\"adata's type is: {type(adata)}\")\n\n    \n    annotation = \"{{{Annotation_of_interest}}}\"\n    toogle = \"{{{Include_Exclude}}}\"\n    labels = {{{Labels}}}\n\n    if toogle == \"Include Selected Labels\":\n        values_to_include = labels\n        values_to_exclude = None\n    else:\n        values_to_include = None\n        values_to_exclude = labels\n\n    ##--------------- ##\n    ## Error Messages ##\n    ## -------------- ##\n\n    ## --------- ##\n    ## Functions ##\n    ## --------- ##\n\n\n    ## --------------- ##\n    ## Main Code Block ##\n    ## --------------- ##\n    ################################\n    with warnings.catch_warnings(record=True) as caught_warnings:\n        filtered_adata = select_values(\n            data=adata,\n            annotation=annotation,\n            values=values_to_include,\n            exclude_values=values_to_exclude\n            )\n        if caught_warnings is not None:\n            for warning in caught_warnings:\n                raise ValueError(warning.message)\n    \n    print(filtered_adata)\n    print(\"\\n\")\n\n    ## --------------- ##\n    ## Save Item Block ##\n    ## --------------- ##\n    \n    output_item = filtered_adata\n    output = Transforms.get_output()\n    output_fs = output.filesystem()\n    with output_fs.open('transform_output.pickle', 'wb') as f:\n        pickle.dump(output_item, f)\n\n    # Count and display occurrences of each label in the annotation\n    label_counts = filtered_adata.obs[annotation].value_counts()\n    print(label_counts)\n    print(\"\\n\")\n\n    dataframe = pd.DataFrame(filtered_adata.X, columns=filtered_adata.var.index, index=filtered_adata.obs.index)\n    print(dataframe.describe())\n    \n    return None\n\n#################################################\n## Global imports and functions included below ##\n#################################################\n\n\n",
      "shouldPersist": true
    }
  },
  "version": 34,
  "externalId": null,
  "canEditTemplate": true,
  "path": "/NIDAP/NCI-Wide Analysis & Visualization Resources/SPAC/SPAC Templates/Subset Analysis [SPAC] [DMAP]",
  "tags": [
    {
      "rid": "ri.compass.main.tag.02094a7d-d869-4dff-bc31-78ad8676d1ad",
      "name": "Code Templates:DMAP"
    },
    {
      "rid": "ri.compass.main.tag.ebb2ab0f-e354-4bd4-9f3a-e78dc8452986",
      "name": "Code Templates:SPAC"
    }
  ],
  "favorite": false,
  "namedCollections": [],
  "isDefault": true,
  "condaDependencies": [
    "python=3.6"
  ],
  "outputDatasetName": "Subset Analysis",
  "outputs": {
    "analysis": {"type": "file", "name": "output.pickle"}
  }
}