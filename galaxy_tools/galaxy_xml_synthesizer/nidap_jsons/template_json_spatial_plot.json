{
  "rid": "ri.vector.main.template.a9c01b84-442c-4368-8c20-1c94331c17f6",
  "title": "Spatial Plot [SPAC] [DMAP]",
  "description": "Generates static spatial visualizations of single-cell data, providing a snapshot of cellular features or annotations across a sample. \\\nPlease refer to [DUET Documentation](https://nidap.nih.gov/shares/links/tgbrrlr77lm7k) and [GitHub Documentation](https://fnlcr-dmap.github.io/SCSAWorkflow/spac.html#spac.visualization.spatial_plot) for further information.",
  "createdBy": "2fdfc0bf-b680-4054-9cbc-2814fb01f8a4",
  "createdAt": "2025-02-27T21:44:36.648292139Z",
  "commitMessage": "fix: Set the color scales to -999 and 999",
  "status": "RELEASED",
  "inputDatasets": [
    {
      "key": "Upstream_Analysis",
      "displayName": "Upstream Analysis",
      "description": "Link to prior processed dataset in the analysis.",
      "paramGroup": null,
      "anchorDataset": null,
      "dataType": "PYTHON_TRANSFORM_INPUT",
      "tags": []
    }
  ],
  "parameters": [
    {
      "key": "Stratify",
      "displayName": "Stratify",
      "description": "Set to False if all cells belong to a single slide, and True to define the annotation specified the slide/plot in Stratify By",
      "paramType": "BOOLEAN",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "True",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Stratify_By",
      "displayName": "Stratify By",
      "description": "The annotation(s) to stratify the dataset when generating the spatial plots. If single annotation is passed, the dataset will be stratified by the unique labels in the annotation column. If n (n>=2) annotations are passed, the function will be stratified based on existing combination of labels in the passed annotations.",
      "paramType": "LIST",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "[]",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Color_By",
      "displayName": "Color By",
      "description": "Color the points in the plot by either their corresponding feature or annotation",
      "paramType": "SELECT",
      "paramGroup": "Color by",
      "paramValues": [
        "Annotation",
        "Feature"
      ],
      "defaultValue": "Annotation",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Annotation_to_Highlight",
      "displayName": "Annotation to Highlight",
      "description": "Annotation name in the analysis to use for coloring the cells in the scatter plot based on the cell label. Can't be used with Feature.",
      "paramType": "STRING",
      "paramGroup": "Color by",
      "paramValues": null,
      "defaultValue": "None",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Table",
      "displayName": "Table",
      "description": "Source table to perform the visualization. Default is Original, referring to the raw dataset.",
      "paramType": "STRING",
      "paramGroup": "Color by",
      "paramValues": null,
      "defaultValue": "Original",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Feature_to_Highlight",
      "displayName": "Feature to Highlight",
      "description": "Feature name in the analysis to use for coloring the cells in the scatter plot based on the feature value. Can't be used with Annotation.",
      "paramType": "STRING",
      "paramGroup": "Color by",
      "paramValues": null,
      "defaultValue": "",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Upper_Colorbar_Bound",
      "displayName": "Upper Colorbar Bound",
      "description": "The upper bound of the colorbar scale. The default -999 will set the upper bound to the minimum of the dataset.",
      "paramType": "Integer",
      "paramGroup": "Colorbar Range",
      "paramValues": null,
      "defaultValue": "-999",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Lower_Colorbar_Bound",
      "displayName": "Lower Colorbar Bound",
      "description": "The lower bound of the colorbar scale. The default 999 will set the lower bound to the minimum of the dataset.",
      "paramType": "Integer",
      "paramGroup": "Colorbar Range",
      "paramValues": null,
      "defaultValue": "999",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Dot_Size",
      "displayName": "Dot Size",
      "description": "Size of the dot of scatter plot.",
      "paramType": "Integer",
      "paramGroup": "Figure Configuration",
      "paramValues": null,
      "defaultValue": "25",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Figure_Height",
      "displayName": "Figure Height",
      "description": "",
      "paramType": "Integer",
      "paramGroup": "Figure Configuration",
      "paramValues": null,
      "defaultValue": "6",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Dot_Transparency",
      "displayName": "Dot Transparency",
      "description": "Transparency of the dot, 0 being transparent and 1 being opaque",
      "paramType": "NUMBER",
      "paramGroup": "Figure Configuration",
      "paramValues": null,
      "defaultValue": "0.5",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Font_Size",
      "displayName": "Font Size",
      "description": "Font size of the figure",
      "paramType": "Integer",
      "paramGroup": "Figure Configuration",
      "paramValues": null,
      "defaultValue": "12",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Figure_Width",
      "displayName": "Figure Width",
      "description": "",
      "paramType": "Integer",
      "paramGroup": "Figure Configuration",
      "paramValues": null,
      "defaultValue": "12",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Figure_DPI",
      "displayName": "Figure DPI",
      "description": "Higher the DPI, clearer the image.",
      "paramType": "Integer",
      "paramGroup": "Figure Configuration",
      "paramValues": null,
      "defaultValue": "200",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    }
  ],
  "columns": [],
  "orderedMustacheKeys": [
    "Upstream_Analysis",
    "Stratify",
    "Stratify_By",
    "Color_By",
    "Annotation_to_Highlight",
    "Table",
    "Feature_to_Highlight",
    "Upper_Colorbar_Bound",
    "Lower_Colorbar_Bound",
    "Dot_Size",
    "Figure_Height",
    "Dot_Transparency",
    "Font_Size",
    "Figure_Width",
    "Figure_DPI"
  ],
  "contents": {
    "type": "code",
    "code": {
      "codeLanguage": "PYTHON",
      "codeTemplate": "@synchronous_node_execution\ndef Spatial_Plot({{{Upstream_Analysis}}}):\n    ## --------- ##\n    ## Libraries ##\n    ## --------- ##\n    from spac.visualization import spatial_plot\n    from spac.data_utils import select_values\n    from spac.utils import check_annotation\n    from functools import partial\n    import matplotlib.pyplot as plt\n    import pickle\n    from code_workbook_utils.utils import text_to_value\n    \n    ## -------------------------------- ##\n    ## User-Defined Template Parameters ##\n    ## -------------------------------- ##\n\n    NIDAP_dataset = {{{Upstream_Analysis}}}.filesystem()\n    with NIDAP_dataset.open(\"transform_output.pickle\", \"rb\") as input_file:\n        adata = pickle.load(input_file)\n\n    annotation = \"{{{Annotation_to_Highlight}}}\"\n    feature = \"{{{Feature_to_Highlight}}}\"\n    \n    layer = \"{{{Table}}}\"\n\n    alpha = {{{Dot_Transparency}}}\n    spot_size = {{{Dot_Size}}}\n    image_height = {{{Figure_Height}}} \n    image_width = {{{Figure_Width}}}\n    dpi = {{{Figure_DPI}}}\n    font_size = {{{Font_Size}}}\n    vmin = {{{Lower_Colorbar_Bound}}}\n    vmax = {{{Upper_Colorbar_Bound}}}\n    color_by = \"{{{Color_By}}}\"\n    stratify = {{{Stratify}}}\n    stratify_by = {{{Stratify_By}}}\n\n    ##--------------- ##\n    ## Error Messages ##\n    ## -------------- ##\n    if stratify and len(stratify_by) == 0:\n        raise ValueError('Please set at least one annotation in the \"Stratify By\" option, or set the \"Stratify\" to False.')\n    check_annotation(\n        adata,\n        annotations=stratify_by\n    )\n\n    # Process feature and annotation with text_to_value\n    feature = text_to_value(feature)\n    annotation = text_to_value(annotation)    \n\n    if color_by == \"Annotation\":\n        feature = None\n    else:\n        annotation = None\n\n\n#    if feature is not None and annotation is not None:\n#        raise ValueError('Cannot have both feature and annotation visualized. Please provide only one with the other set as \"None\" without quotes.')\n\n\n    ## --------- ##\n    ## Functions ##\n    ## --------- ##\n\n\n\n    ## --------------- ##\n    ## Main Code Block ##\n    ## --------------- ##\n    layer=text_to_value(layer, \"Original\")\n\n    prefilled_spatial = partial(\n        spatial_plot,\n        spot_size=spot_size,\n        alpha=alpha,\n        vmin=vmin,\n        vmax=vmax,\n        annotation=annotation,\n        feature=feature,\n        layer=layer\n    )\n\n    if not stratify:\n        plt.rcParams['font.size'] = font_size\n        fig, ax = plt.subplots(figsize=(image_width, image_height), dpi=dpi)\n\n        ax = prefilled_spatial(adata=adata, ax=ax)\n\n        if color_by == \"Annotation\":\n            title = f'Annotation: {annotation}'\n        else:\n            title = f'Table:\"{layer}\" \\n Feature:\"{feature}\"'\n        ax[0].set_title(title)\n\n        plt.show()\n    else:\n        combined_label = \"concatenated_label\"\n\n        adata.obs[combined_label] = adata.obs[stratify_by].astype(str).agg('_'.join, axis=1)\n\n        unique_values = adata.obs[combined_label].unique()\n\n        print(unique_values)\n\n        max_length = min(len(unique_values), 20)\n        if len(unique_values) > 20:\n            print(f'WARNING: There are \"{len(unique_values)}\" unique plots, displaying only the first 20 plots.')\n\n        for value in unique_values[:max_length]:\n            filtered_adata = select_values(data=adata, annotation=combined_label, values=value)\n\n            fig, ax = plt.subplots(figsize=(image_width, image_height), dpi=dpi)\n\n            ax = prefilled_spatial(adata=filtered_adata, ax=ax)\n\n            if color_by == \"Annotation\":\n                title = f'Annotation: {annotation}'\n            else:\n                title = f'Table:\"{layer}\" \\n Feature:\"{feature}\"'\n            title = f'{title}\\n Stratify by: {value}'\n            ax[0].set_title(title)\n\n            plt.show()\n\n    return None\n    ",
      "shouldPersist": true
    }
  },
  "version": 24,
  "externalId": null,
  "canEditTemplate": true,
  "path": "/NIDAP/NCI-Wide Analysis & Visualization Resources/SPAC/SPAC Templates/Spatial Plot [SPAC] [DMAP]",
  "tags": [
    {
      "rid": "ri.compass.main.tag.02094a7d-d869-4dff-bc31-78ad8676d1ad",
      "name": "Code Templates:DMAP"
    },
    {
      "rid": "ri.compass.main.tag.ebb2ab0f-e354-4bd4-9f3a-e78dc8452986",
      "name": "Code Templates:SPAC"
    }
  ],
  "favorite": false,
  "namedCollections": [],
  "isDefault": true,
  "condaDependencies": [
    "python=3.6"
  ],
  "outputDatasetName": "spatial_plot",
  "outputs": {
    "figures": {"type": "directory", "name": "figures_dir"}
  }
}