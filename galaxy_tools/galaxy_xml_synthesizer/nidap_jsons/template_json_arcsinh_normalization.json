{
  "rid": "ri.vector.main.template.ff0b0511-fc27-4f21-8360-e08292d72f2c",
  "title": "Arcsinh Normalization [SPAC] [DMAP]",
  "description": "Normalize features either by a user-defined co-factor or a determined percentile, allowing for effective normalization of high-range values in single-cell datasets. This transformation can also be applied per batch if specified.\\\nPlease refer to [DUET Documentation](https://nidap.nih.gov/workspace/notepad/view/ri.notepad.main.notepad.96406632-f9d5-4644-b188-401107931cf5) and [GitHub Documentation](https://fnlcr-dmap.github.io/SCSAWorkflow/spac.html#spac.transformations.arcsinh_transformation) for further information.",
  "createdBy": "391048e4-979e-4237-a0f4-9f34b125a427",
  "createdAt": "2024-10-29T14:52:39.670133537Z",
  "commitMessage": "Text_to_value",
  "status": "RELEASED",
  "inputDatasets": [
    {
      "key": "Upstream_Analysis",
      "displayName": "Upstream Analysis",
      "description": "Link to prior processed dataset in the analysis.",
      "paramGroup": null,
      "anchorDataset": null,
      "dataType": "PYTHON_TRANSFORM_INPUT",
      "tags": []
    }
  ],
  "parameters": [
    {
      "key": "Table_to_Process",
      "displayName": "Table to Process",
      "description": "Source table to perform the computation. Original refers to the raw dataset.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "Original",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Co_Factor",
      "displayName": "Co-Factor",
      "description": "A fixed positive number to use as a co-factor for the transformation.  If provided, it takes precedence over the percentile argument. If \"None\", the Percentile method will be used. Default is \"5.0\".",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "5.0",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Percentile",
      "displayName": "Percentile",
      "description": "The percentile to determine the co-factor if the co-factor is not provided. The percentile is computed for each feature (column) individually. Default is \"None\".",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "None",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Output_Table_Name",
      "displayName": "Output Table Name",
      "description": "Name of the table to be added to the analysis.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "arcsinh",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Per_Batch",
      "displayName": "Per Batch",
      "description": "Whether to apply the transformation per batch. If \"True\", the transformation is applied per batch.",
      "paramType": "BOOLEAN",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "False",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Annotation",
      "displayName": "Annotation",
      "description": "The name of the annotation to define batches. Required if Per Batch is \"True\".",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "None",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    }
  ],
  "columns": [],
  "orderedMustacheKeys": [
    "Upstream_Analysis",
    "Table_to_Process",
    "Co_Factor",
    "Percentile",
    "Output_Table_Name",
    "Per_Batch",
    "Annotation"
  ],
  "contents": {
    "type": "code",
    "code": {
      "codeLanguage": "PYTHON",
      "codeTemplate": "def unnamed_26({{{Upstream_Analysis}}}):\n\n    ## --------- ##\n    ## Libraries ##\n    ## --------- ##\n\n    import pandas as pd\n    import anndata\n    from spac.transformations import arcsinh_transformation\n    import pickle\n    from code_workbook_utils.utils import text_to_value\n\n    ## -------------------------------- ##\n    ## User-Defined Template Parameters ##\n    ## -------------------------------- ##\n\n    NIDAP_dataset = {{{Upstream_Analysis}}}.filesystem()\n    with NIDAP_dataset.open(\"transform_output.pickle\", \"rb\") as input_file:\n        adata = pickle.load(input_file)\n\n    input_layer = \"{{{Table_to_Process}}}\"\n    co_factor = \"{{{Co_Factor}}}\"\n    percentile = \"{{{Percentile}}}\"\n    output_layer = \"{{{Output_Table_Name}}}\"\n    per_batch = \"{{{Per_Batch}}}\"\n    annotation = \"{{{Annotation}}}\"\n\n    input_layer = text_to_value(\n        input_layer,\n        default_none_text=\"Original\"\n    )\n\n    co_factor = text_to_value(\n        co_factor,\n        default_none_text=\"None\",\n        to_float=True,\n        param_name=\"co_factor\"\n    )\n\n    percentile = text_to_value(\n        percentile,\n        default_none_text=\"None\",\n        to_float=True,\n        param_name=\"percentile\"\n    )\n\n    if per_batch == \"True\":\n        per_batch = True\n    else:\n        per_batch = False\n\n    annotation = text_to_value(\n        annotation,\n        default_none_text=\"None\"\n    )\n\n    ##--------------- ##\n    ## Error Messages ##\n    ## -------------- ##\n\n    ## --------- ##\n    ## Functions ##\n    ## --------- ##\n\n\n    ## --------------- ##\n    ## Main Code Block ##\n    ## --------------- ##\n    ################################\n\n\n    transformed_data = arcsinh_transformation(\n        adata,\n        input_layer=input_layer,\n        co_factor=co_factor,\n        percentile=percentile,\n        output_layer=output_layer,\n        per_batch=per_batch,\n        annotation=annotation\n        )\n    \n    print(f\"Transformed data stored in layer: {output_layer}\")\n    dataframe = pd.DataFrame(transformed_data.layers[output_layer])\n    print(dataframe.describe())\n    \n    # Transfer data through pickle method and filesystem on NIDAP\n    output = Transforms.get_output()\n    output_fs = output.filesystem()\n    with output_fs.open('transform_output.pickle', 'wb') as f:\n        pickle.dump(transformed_data, f)\n\n    return(None)\n\n\n#################################################\n## Global imports and functions included below ##\n#################################################\n\n\n",
      "shouldPersist": true
    }
  },
  "version": 15,
  "externalId": null,
  "canEditTemplate": true,
  "path": "/NIDAP/NCI-Wide Analysis & Visualization Resources/SPAC/SPAC Templates/Arcsinh Normalization [SPAC] [DMAP]",
  "tags": [
    {
      "rid": "ri.compass.main.tag.02094a7d-d869-4dff-bc31-78ad8676d1ad",
      "name": "Code Templates:DMAP"
    },
    {
      "rid": "ri.compass.main.tag.ebb2ab0f-e354-4bd4-9f3a-e78dc8452986",
      "name": "Code Templates:SPAC"
    }
  ],
  "favorite": false,
  "namedCollections": [],
  "isDefault": true,
  "condaDependencies": [
    "python=3.6"
  ],
  "outputDatasetName": "New Dataset",
  "outputs": {
    "analysis": {"type": "file", "name": "output.pickle"}
  }
}