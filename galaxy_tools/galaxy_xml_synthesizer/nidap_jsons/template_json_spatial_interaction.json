{
  "rid": "ri.vector.main.template.45401976-566a-42b8-baf7-74c612582bf7",
  "title": "Spatial Interaction [SPAC] [DMAP]",
  "description": "Performs advanced spatial statistical analyses , instead of visualization of spatial distribution, to  evaluate neighborhood enrichments or cluster interactions.\\\nPlease refer to [DUET Documentation](https://nidap.nih.gov/shares/links/byhqlqtwwqr4w) and [GitHub Documentation](https://fnlcr-dmap.github.io/SCSAWorkflow/spac.html#spac.spatial_analysis.spatial_interaction) for further information.",
  "createdBy": "473c74f1-6764-4d6c-87e8-4a56c2b2f5a0",
  "createdAt": "2025-01-07T13:53:53.178945591Z",
  "commitMessage": "feat: adding nidap image render adjustment",
  "status": "RELEASED",
  "inputDatasets": [
    {
      "key": "Upstream_Analysis",
      "displayName": "Upstream Analysis",
      "description": "Link to prior processed dataset in the analysis.",
      "paramGroup": null,
      "anchorDataset": null,
      "dataType": "PYTHON_TRANSFORM_INPUT",
      "tags": []
    }
  ],
  "parameters": [
    {
      "key": "Annotation",
      "displayName": "Annotation",
      "description": "Annotation to be used in calculating spatial interactions between cells.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Spatial_Analysis_Method",
      "displayName": "Spatial Analysis Method",
      "description": "Spatial analysis method provided by the squidpy package.",
      "paramType": "SELECT",
      "paramGroup": null,
      "paramValues": [
        "Neighborhood Enrichment",
        "Cluster Interaction Matrix"
      ],
      "defaultValue": "Neighborhood Enrichment",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Stratify_By",
      "displayName": "Stratify By",
      "description": "The annotation(s) to stratify the dataset when generating interaction plots. If single annotation is passed, the dataset will be stratified by the unique labels in the annotation column. If n (n>=2) annotations are passed, the function will be stratified based on existing combination of labels in the passed annotations. Use \"None\" without quotes to disable.",
      "paramType": "LIST",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "[\"None\"]",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Coordinate_Type",
      "displayName": "Coordinate Type",
      "description": "Type of coordinate system used in computing spatial neighbors. Should be 'generic' for general dataset. Default is None, decided by the squidy pacakge.",
      "paramType": "SELECT",
      "paramGroup": "Advanced Analysis Setting",
      "paramValues": [
        "None",
        "generic"
      ],
      "defaultValue": "None",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Seed",
      "displayName": "Seed",
      "description": "Random seed for reproducibility, used in Neighborhood Enrichment Analysis.",
      "paramType": "STRING",
      "paramGroup": "Advanced Analysis Setting",
      "paramValues": null,
      "defaultValue": "None",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Radius",
      "displayName": "Radius",
      "description": "The maximum distance in spatial coordinates to create an edge between two cells. Takes priority over KNN. Use \"None\" without quotes to disable.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "None",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "K_Nearest_Neighbors",
      "displayName": "K-Nearest Neighbors",
      "description": "Default is 6. Number of neighbors for KNN.",
      "paramType": "NUMBER",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "6",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Figure_Width",
      "displayName": "Figure Width",
      "description": "The width of the figure in inch.",
      "paramType": "NUMBER",
      "paramGroup": "Figure Configuration",
      "paramValues": null,
      "defaultValue": "15",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Figure_Height",
      "displayName": "Figure Height",
      "description": "The height of the figure in inch.",
      "paramType": "NUMBER",
      "paramGroup": "Figure Configuration",
      "paramValues": null,
      "defaultValue": "12",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Figure_DPI",
      "displayName": "Figure DPI",
      "description": "Higher the DPI, clearer the image.",
      "paramType": "NUMBER",
      "paramGroup": "Figure Configuration",
      "paramValues": null,
      "defaultValue": "200",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Font_Size",
      "displayName": "Font Size",
      "description": "",
      "paramType": "NUMBER",
      "paramGroup": "Figure Configuration",
      "paramValues": null,
      "defaultValue": "12",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Color_Bar_Range",
      "displayName": "Color Bar Range",
      "description": "The color bar range defines the even lower and upper color bar limit to allow center of the color bar remains 0. For example, enter the single value \"100\" without the quotes to create a color range from -100:100. Default Automatic will allow the color bar to be defined automatically.",
      "paramType": "STRING",
      "paramGroup": "Advanced Analysis Setting",
      "paramValues": null,
      "defaultValue": "Automatic",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    }
  ],
  "columns": [],
  "orderedMustacheKeys": [
    "Upstream_Analysis",
    "Annotation",
    "Spatial_Analysis_Method",
    "Stratify_By",
    "Coordinate_Type",
    "Seed",
    "Radius",
    "K_Nearest_Neighbors",
    "Figure_Width",
    "Figure_Height",
    "Figure_DPI",
    "Font_Size",
    "Color_Bar_Range"
  ],
  "contents": {
    "type": "code",
    "code": {
      "codeLanguage": "PYTHON",
      "codeTemplate": "@synchronous_node_execution\ndef neighborhood_enrichment({{{Upstream_Analysis}}}):\n\n    ## --------- ##\n    ## Libraries ##\n    ## --------- ##   \n    \n    import pickle\n    import pandas as pd\n    import numpy as np\n    from PIL import Image\n    from pprint import pprint\n    import matplotlib.pyplot as plt\n    from spac.spatial_analysis import spatial_interaction\n    from code_workbook_utils.utils import text_to_value\n    \n\n    NIDAP_dataset = {{{Upstream_Analysis}}}.filesystem()\n    with NIDAP_dataset.open(\"transform_output.pickle\", \"rb\") as input_file:\n        adata = pickle.load(input_file)\n\n    ## -------------------------------- ##\n    ## User-Defined Template Parameters ##\n    ## -------------------------------- ##\n\n    annotation = \"{{{Annotation}}}\"\n    analysis_method = \"{{{Spatial_Analysis_Method}}}\"\n    stratify_by = {{{Stratify_By}}}\n    seed = \"{{{Seed}}}\"\n    coord_type = \"{{{Coordinate_Type}}}\"\n    n_rings = 1\n    n_neighs = {{{K_Nearest_Neighbors}}}\n    radius = \"{{{Radius}}}\"\n    image_width = {{{Figure_Width}}}\n    image_height = {{{Figure_Height}}}\n    dpi = {{{Figure_DPI}}}\n    font_size = {{{Font_Size}}}\n    color_bar_range = \"{{{Color_Bar_Range}}}\"\n\n    ##--------------- ##\n    ## Error Messages ##\n    ## -------------- ##\n\n\n\n    ## --------- ##\n    ## Functions ##\n    ## --------- ##\n\n    def save_matrix(\n        matrix\n        ):\n        for file_name in matrix:\n            data_df = matrix[file_name]\n            print(\"\\n\")\n            print(file_name)\n            print(data_df)\n            with output_fs.open(file_name, 'w') as f:\n                data_df.to_csv(f, index=True)\n\n    def update_nidap_display(\n        axs,\n        image_width,\n        image_height,\n        dpi,\n        font_size\n    ):\n        # NIDAP display logic is different than the generic python image output\n        # For example, a 12in*8in image with font 12 should properly display all text in generic Image\n        # But in nidap code workbook resizing, the text will be reducted \n        # This function is to adjust the image sizing and font sizing to fit the NIDAP display\n        # Get the figure associated with the axes\n        fig = axs.get_figure()\n        \n        # Set figure size and DPI\n        fig.set_size_inches(image_width, image_height)\n        fig.set_dpi(dpi)\n        \n        # Customize font sizes\n        axs.title.set_fontsize(font_size)  # Title font size\n        axs.xaxis.label.set_fontsize(font_size)  # X-axis label font size\n        axs.yaxis.label.set_fontsize(font_size)  # Y-axis label font size\n        axs.tick_params(axis='both', labelsize=font_size)  # Tick label font size\n        # Return the updated figure and axes for chaining or further customization\n        return fig, axs\n\n    ## --------------- ##\n    ## Main Code Block ##\n    ## --------------- ##\n\n    for i, item in enumerate(stratify_by):\n        item_is_none = text_to_value(item)\n        if item_is_none is None and i == 0:\n            stratify_by = item_is_none\n        elif item_is_none is None and i != 0:\n            raise ValueError(\n                'Found string \"None\" in the stratify by list that is not the first entry.\\n'\n                'Please remove the \"None\" to proceed with the list of stratify by options, \\n'\n                'or move the \"None\" to start of the list to disable stratification. Thank you.')\n\n    seed = text_to_value(seed, to_int=True)\n    radius = text_to_value(radius, to_float=True)\n    coord_type = text_to_value(coord_type)\n    color_bar_range = text_to_value(\n        color_bar_range,\n        \"Automatic\",\n        to_float=True)\n    \n    if color_bar_range is not None:\n        cmap = \"seismic\"\n        vmin = -abs(color_bar_range)\n        vmax = abs(color_bar_range)\n    else:\n        cmap = \"seismic\"\n        vmin = vmax = color_bar_range\n\n    plt.rcParams['font.size'] = font_size\n\n    result_dictionary = spatial_interaction(\n        adata=adata,\n        annotation=annotation,\n        analysis_method=analysis_method,\n        stratify_by=stratify_by,\n        return_matrix=True,\n        seed=seed,\n        coord_type=coord_type,\n        n_rings=n_rings,\n        n_neighs=n_neighs,\n        radius=radius,\n        cmap=cmap,\n        vmin=vmin,\n        vmax=vmax,\n        figsize=(image_width, image_height),\n        dpi=dpi\n    )\n\n    output = Transforms.get_output()\n    output_fs = output.filesystem()\n\n    if not stratify_by:\n        axs = result_dictionary['Ax']\n        fig, axs = update_nidap_display(\n            axs=axs,\n            image_width=image_width,\n            image_height=image_height,\n            dpi=dpi,\n            font_size=font_size\n        )\n        plt.show()\n\n        matrix = result_dictionary['Matrix']['annotation']\n        save_matrix(matrix)\n    else:\n        plt.close(1)\n        axs_dict = result_dictionary['Ax']\n        for key in axs_dict:            \n            axs = axs_dict[key]\n            fig, axs = update_nidap_display(\n                axs=axs,\n                image_width=image_width,\n                image_height=image_height,\n                dpi=dpi,\n                font_size=font_size\n            )\n            plt.show()\n\n        matrix_dict = result_dictionary['Matrix']\n        for identifier in matrix_dict:\n            matrix = matrix_dict[identifier]\n            save_matrix(matrix)      \n\n    return(None)\n\n",
      "shouldPersist": true
    }
  },
  "version": 46,
  "externalId": null,
  "canEditTemplate": true,
  "path": "/NIDAP/NCI-Wide Analysis & Visualization Resources/SPAC/SPAC Templates/Spatial Interaction [SPAC] [DMAP]",
  "tags": [
    {
      "rid": "ri.compass.main.tag.02094a7d-d869-4dff-bc31-78ad8676d1ad",
      "name": "Code Templates:DMAP"
    },
    {
      "rid": "ri.compass.main.tag.ebb2ab0f-e354-4bd4-9f3a-e78dc8452986",
      "name": "Code Templates:SPAC"
    }
  ],
  "favorite": false,
  "namedCollections": [],
  "isDefault": true,
  "condaDependencies": [
    "python=3.6"
  ],
  "outputDatasetName": "spatial_interaction",
  "outputs": {
    "dataframe": {"type": "file", "name": "dataframe.csv"},
    "figures": {"type": "directory", "name": "figures_dir"}
  }
}