<tool id="spac_setup_analysis" name="Setup Analysis [SPAC] [DMAP]" version="1.0.0" profile="24.2">
    <description>Convert the pre-processed dataset to the analysis object for downstream analysis.</description>

    <requirements>
        <container type="docker">spac:setup_analysis-mvp</container>
    </requirements>

    <configfiles>
        <!-- Galaxy auto-serializes all parameters to JSON -->
        <inputs name="params_json" filename="galaxy_params.json" data_style="paths"/>
    </configfiles>
        
    <command detect_errors="exit_code"><![CDATA[
    python '$__tool_directory__/format_values.py' 
        'galaxy_params.json' 
        'cleaned_params.json'
        --list-values Annotation_s_ Features_to_Analyze Feature_Regex
    &&
    python3 '$__tool_directory__/setup_analysis_template.py' 'cleaned_params.json'
    ]]></command>

    <inputs>
        <param name="Upstream_Dataset" type="data" format="tabular,csv,tsv,txt" label="Upstream Dataset" help="Input CSV dataset"/>
        <param name="X_Coordinate_Column" type="text" value="" optional="true" label="X Coordinate Column"/>
        <param name="Y_Coordinate_Column" type="text" value="" optional="true" label="Y Coordinate Column"/>
        <repeat name="Annotation_s__repeat" title="Annotation(s)" min="0">
            <param name="value" type="text" label="Column name"/>
        </repeat>
        <repeat name="Features_to_Analyze_repeat" title="Features to Analyze" min="0">
            <param name="value" type="text" label="Column name" help="Leave empty to analyze all features"/>
        </repeat>
        <repeat name="Feature_Regex_repeat" title="Feature Regex" min="0">
            <param name="value" type="text" label="Regex pattern" help="e.g., .*Intensity$ to match all columns ending with 'Intensity'"/>
        </repeat>
    </inputs>

    <outputs>
        <!-- Debug outputs -->
        <data name="params_json_debug" format="json" from_work_dir="galaxy_params.json" label="${tool.name} on ${on_string}: Raw Parameters"/>
        <data name="cleaned_params" format="json" from_work_dir="cleaned_params.json" label="${tool.name} on ${on_string}: Cleaned Parameters"/>
        
        <!-- Main output (setup_analysis_template.py will create this) -->
        <data name="analysis" format="binary" from_work_dir="output.pickle" label="${tool.name} on ${on_string}: Analysis"/>
    </outputs>
    
    <help><![CDATA[
**Setup Analysis [SPAC] [DMAP] v1.0**

This tool converts pre-processed CSV datasets to analysis objects for downstream analysis.

**Key Features:**
- Uses Galaxy's auto-serialization (data_style="paths")
- Parameters normalized by format_values.py
- Output configuration handled by template
- Debug outputs available for troubleshooting

**Features to Analyze:**
- Add specific column names to analyze
- Leave empty to analyze all features (defaults to ["All"])

**Feature Regex:**
- Add regex patterns to match multiple columns
- Example: ".*Intensity$" matches all columns ending with "Intensity"
- Leave empty if not using regex matching

**Outputs:**
- Analysis: Binary pickle file containing the processed AnnData object
- Debug: Raw and cleaned parameter JSON files

**Technical Notes:**
- Galaxy generates galaxy_params.json via configfiles
- format_values.py normalizes parameters (no output injection)
- Template handles its own output configuration
- Only Features_to_Analyze defaults to ["All"] when empty
    ]]></help>
    
    <citations>
        <citation type="doi">10.1038/s41586-019-1876-x</citation>
    </citations>
</tool>
