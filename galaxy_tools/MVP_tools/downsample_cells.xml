<?xml version="1.0" ?>
<tool id="spac_downsample_cells" name="Downsample Cells [SPAC] [DMAP]" version="2.0.0" profile="24.2">
    <description>This template  reduces  number of cells based on one or more annotations. \
Please refer to DUET Documentation, GitHub Documentation for further information.</description>
    <requirements>
        <container type="docker">nciccbr/spac:v2-dev</container>
    </requirements>
    <configfiles>
        <inputs name="params_json" filename="galaxy_params.json" data_style="paths"/>
    </configfiles>
    <command detect_errors="exit_code"><![CDATA[

echo '{"dataframe": {"type": "file", "name": "dataframe.csv"}}' > outputs_config.json && python '$__tool_directory__/format_values.py' 'galaxy_params.json' 'cleaned_params.json' --bool-values Stratify_Option Random_Selection --list-values Annotations_List --inject-outputs --outputs-config outputs_config.json && python -c "from spac.templates.downsample_cells_template import run_from_json; run_from_json('cleaned_params.json')"

]]></command>
    <inputs>
        <param name="Upstream_Dataset" type="data" format="tabular,csv,tsv,txt" label="Upstream Dataset" help="Link to prior processed dataset in the analysis."/>
        <repeat name="Annotations_List_repeat" title="Annotations List">
            <param name="value" type="text" label="Value" help="Choose one or more annotations for creating a smaller, representative sample of dataset."/>
        </repeat>
        <param name="Number_of_Samples" type="integer" label="Number of Samples" value="100000" help="Specifies how many cells to include in the downsampled dataset. When &quot;Stratify Option&quot; is off, it selects this number of cells from each label or from each unique combination of labels across multiple annotations. When &quot;Stratify Option&quot; is on,  it distributes this total number of cells across all labels or label combinations, in proportion to their frequencies in the full dataset."/>
        <param name="Stratify_Option" type="boolean" label="Stratify Option" truevalue="True" falsevalue="False" checked="false" help="If true, samples are chosen to reflect the original dataset's label distribution across the selected annotations. If false, an equal number of cells will be selected from each label or unique label combination across selected annotations, regardless of their original frequency."/>
        <param name="Random_Selection" type="boolean" label="Random Selection" truevalue="True" falsevalue="False" checked="true" help="If this toggle is True, and &quot;Stratify Option&quot; is set to True, randomly select the returned cells within each annotation labels. Otherwise, choose the first cells up to &quot;Number_of_Samples&quot; from selected annotation(s)."/>
        <param name="New_Combined_Annotation_Name" type="text" label="New Combined Annotation Name" value="_combined_" help="This is the name for a new annotation created when multiple annotations are selected. The values of this new annotation are the specific combinations of labels from the selected annotations, such as 'Region1_Day3'."/>
        <param name="Minimum_Threshold" type="float" label="Minimum Threshold" value="5" help="Determine the lowest count of cells an annotation label must be included in the downsampled data. Annotation labels with fewer cells than this threshold will be excluded to ensure meaningful representation."/>
    </inputs>
    <outputs>
        <data name="params_json_debug" format="json" from_work_dir="galaxy_params.json" label="${tool.name} on ${on_string}: Raw Parameters"/>
        <data name="cleaned_params_debug" format="json" from_work_dir="cleaned_params.json" label="${tool.name} on ${on_string}: Cleaned Parameters"/>
        <data name="dataframe" format="csv" from_work_dir="dataframe.csv" label="${tool.name} on ${on_string}: Dataframe"/>
    </outputs>
    <help><![CDATA[

**Downsample Cells [SPAC] [DMAP]**
This template  reduces  number of cells based on one or more annotations. \
Please refer to DUET Documentation, GitHub Documentation for further information.
**Outputs:**
- dataframe: file (dataframe.csv)

]]></help>
    <citations>
        <citation type="bibtex">@misc{spac_toolkit,
    author = {FNLCR DMAP Team},
    title = {SPAC: SPAtial single-Cell analysis},
    year = {2022},
    url = {https://github.com/FNLCR-DMAP/SCSAWorkflow}
}</citation>
        <citation type="doi">10.1101/2025.04.02.646782</citation>
        <citation type="doi">10.48550/arXiv.2506.01560</citation>
    </citations>
</tool>