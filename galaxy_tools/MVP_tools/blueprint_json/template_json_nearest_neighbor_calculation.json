{
  "rid": "ri.vector.main.template.1f10e563-2a8b-4076-8ae9-77c96a34442a",
  "title": "Nearest Neighbor Calculation [SPAC][DMAP]",
  "description": "Computes the shortest distance from each cell to the nearest cell of each phenotype. The distance table is stored with the key name \"Label\". \\\nPlease refer to [DUET Documentation](https://nidap.nih.gov/workspace/notepad/view/ri.notepad.main.notepad.0280bc78-9ebe-45d3-97cb-c69b34e6bc10), [GitHub Documentation](https://fnlcr-dmap.github.io/SCSAWorkflow/spac.html#spac.spatial_analysis.calculate_nearest_neighbor) for further information.",
  "createdBy": "391048e4-979e-4237-a0f4-9f34b125a427",
  "createdAt": "2025-01-06T17:49:16.779400126Z",
  "commitMessage": "add Github doc",
  "status": "RELEASED",
  "inputDatasets": [
    {
      "key": "Upstream_Analysis",
      "displayName": "Upstream_Analysis",
      "description": "Link to prior processed dataset in the analysis.",
      "paramGroup": null,
      "anchorDataset": null,
      "dataType": "PYTHON_TRANSFORM_INPUT",
      "tags": []
    }
  ],
  "parameters": [
    {
      "key": "Annotation",
      "displayName": "Annotation",
      "description": "Annotation name specifying phenotypes.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "ImageID",
      "displayName": "ImageID",
      "description": "If multiple images are in the dataset, specify the annotation with image IDs. Otherwise, use \"None\" to treat the dataset as a single image.",
      "paramType": "STRING",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "None",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Nearest_Neighbor_Associated_Table",
      "displayName": "Nearest Neighbor Associated Table",
      "description": "Key name to store the calculated distances. Default is \"spatial_distance\".",
      "paramType": "STRING",
      "paramGroup": "Advanced Analysis Setting",
      "paramValues": null,
      "defaultValue": "spatial_distance",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    },
    {
      "key": "Verbose",
      "displayName": "Verbose",
      "description": "Indicates whether to print progress messages.",
      "paramType": "BOOLEAN",
      "paramGroup": null,
      "paramValues": null,
      "defaultValue": "True",
      "condition": null,
      "content": null,
      "objectPropertyReference": null
    }
  ],
  "columns": [],
  "orderedMustacheKeys": [
    "Upstream_Analysis",
    "Annotation",
    "ImageID",
    "Nearest_Neighbor_Associated_Table",
    "Verbose"
  ],
  "contents": {
    "type": "code",
    "code": {
      "codeLanguage": "PYTHON",
      "codeTemplate": "# DEV Nearest Neighbor Calculation [SPAC][DMAP] (testcase1-single-image) : v1\ndef calculate_NN_cell_labels({{{Upstream_Analysis}}}):\n    \n    ## --------- ##\n    ## Libraries ##\n    ## --------- ##\n    import pickle\n    import numpy as np\n    import pandas as pd\n    from spac.utils import check_table, check_annotation\n    from spac.spatial_analysis import calculate_nearest_neighbor\n    from code_workbook_utils.utils import text_to_value\n\n    ## -------------------------------- ##\n    ## User-Defined Template Parameters ##\n    ## -------------------------------- ##\n    NIDAP_dataset = {{{Upstream_Analysis}}}.filesystem()\n    with NIDAP_dataset.open(\"transform_output.pickle\", \"rb\") as input_file:\n        adata = pickle.load(input_file)\n    \n    annotation = \"{{{Annotation}}}\"\n    spatial_associated_table = \"spatial\"\n    imageid = \"{{{ImageID}}}\"           # If multiple images, provide a column name; otherwise \"None\"\n    label = \"{{{Nearest_Neighbor_Associated_Table}}}\" # Key under which to store the distance DataFrame in adata.obsm\n    verbose = {{{Verbose}}}             # Whether to print progress messages\n\n    # Convert any string \"None\" to actual None for Python\n    imageid = text_to_value(imageid, default_none_text=\"None\")\n\n    ## --------------- ##\n    ## Main Code Block ##\n    ## --------------- ##\n    # print(\"Running `calculate_nearest_neighbor`with the following parameters:\")\n    # print(f\"  annotation: {annotation}\")\n    # print(f\"  spatial_associated_table: {spatial_associated_table}\")\n    # print(f\"  imageid: {imageid}\")\n    # print(f\"  label: {label}\")\n    # print(f\"  verbose: {verbose}\")\n\n    # Perform the nearest neighbor calculation\n    calculate_nearest_neighbor(\n        adata=adata,\n        annotation=annotation,\n        spatial_associated_table=spatial_associated_table,\n        imageid=imageid,\n        label=label,\n        verbose=verbose\n    )\n\n    # Save the updated AnnData object\n    output = Transforms.get_output()\n    output_fs = output.filesystem()\n    with output_fs.open('transform_output.pickle', 'wb') as f:\n        pickle.dump(adata, f)\n\n    # print(\"Nearest neighbor calculation complete.\")\n    # print(\"adata.obsm keys:\", list(adata.obsm.keys()))\n    # if label in adata.obsm:\n    #     print(\"Preview of adata.obsm['spatial_distance']:\\n\", adata.obsm[label].head())\n\n    print(adata)\n   \n\n#################################################\n## Global imports and functions included below ##\n#################################################\n\n\n",
      "shouldPersist": true
    }
  },
  "version": 4,
  "externalId": null,
  "canEditTemplate": true,
  "path": "/NIDAP/NCI-Wide Analysis & Visualization Resources/SPAC/SPAC Templates/Nearest Neighbor Calculation [SPAC][DMAP]",
  "tags": [],
  "favorite": false,
  "namedCollections": [],
  "isDefault": true,
  "condaDependencies": [
    "python=3.6"
  ],
  "outputDatasetName": "nearest_neighbor_calculation",
  "outputs": {
    "analysis": {"type": "file", "name": "output.pickle"}
  }
}