<?xml version="1.0" ?>
<tool id="spac_spatial_interaction" name="Spatial Interaction [SPAC] [DMAP]" version="2.0.0" profile="24.2">
    <description>Performs advanced spatial statistical analyses , instead of visualization of spatial distribution, to  evaluate neighborhood enrichments or cluster interactions.\
Please refer to DUET Documentation an</description>
    <requirements>
        <container type="docker">spac:mvp</container>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[

echo '{"dataframe": {"type": "file", "name": "dataframe.csv"}, "figures": {"type": "directory", "name": "figures_dir"}}' > outputs_config.json && python '$__tool_directory__/format_values.py' 'galaxy_params.json' 'cleaned_params.json' --list-values Stratify_By --inject-outputs --outputs-config outputs_config.json && python '$__tool_directory__/spatial_interaction_template.py' 'cleaned_params.json'

]]></command>
    <configfiles>
        <inputs name="params_json" filename="galaxy_params.json" data_style="paths"/>
    </configfiles>
    
    <inputs>
        <param name="Upstream_Analysis" type="data" format="h5ad,binary" label="Upstream Analysis" help="Link to prior processed dataset in the analysis."/>
        <param name="Annotation" type="text" label="Annotation" value="" help="Annotation to be used in calculating spatial interactions between cells."/>
        <param name="Spatial_Analysis_Method" type="select" label="Spatial Analysis Method" help="Spatial analysis method provided by the squidpy package.">
            <option value="Neighborhood Enrichment" selected="true">Neighborhood Enrichment</option>
            <option value="Cluster Interaction Matrix">Cluster Interaction Matrix</option>
        </param>
        <repeat name="Stratify_By_repeat" title="Stratify By">
            <param name="value" type="text" label="Value" help="The annotation(s) to stratify the dataset when generating interaction plots. If single annotation is passed, the dataset will be stratified by the unique labels in the annotation column. If n (n&gt;=2) annotations are passed, the function will be stratified based on existing combination of labels in the passed annotations. Use &quot;None&quot; without quotes to disable."/>
        </repeat>
        <param name="Coordinate_Type" type="select" label="Coordinate Type" help="Type of coordinate system used in computing spatial neighbors. Should be 'generic' for general dataset. Default is None, decided by the squidy pacakge.">
            <option value="None" selected="true">None</option>
            <option value="generic">generic</option>
        </param>
        <param name="Seed" type="text" label="Seed" help="Random seed for reproducibility, used in Neighborhood Enrichment Analysis."/>
        <param name="Radius" type="text" label="Radius" help="The maximum distance in spatial coordinates to create an edge between two cells. Takes priority over KNN. Use &quot;None&quot; without quotes to disable."/>
        <param name="K_Nearest_Neighbors" type="integer" label="K-Nearest Neighbors" value="6" help="Default is 6. Number of neighbors for KNN."/>
        <param name="Figure_Width" type="float" label="Figure Width" value="15" help="The width of the figure in inch."/>
        <param name="Figure_Height" type="float" label="Figure Height" value="12" help="The height of the figure in inch."/>
        <param name="Figure_DPI" type="float" label="Figure DPI" value="200" help="Higher the DPI, clearer the image."/>
        <param name="Font_Size" type="float" label="Font Size" value="12"/>
        <param name="Color_Bar_Range" type="text" label="Color Bar Range" value="Automatic" help="The color bar range defines the even lower and upper color bar limit to allow center of the color bar remains 0. For example, enter the single value &quot;100&quot; without the quotes to create a color range from -100:100. Default Automatic will allow the color bar to be defined automatically."/>
    </inputs>
    <outputs>
        <data name="params_json_debug" format="json" from_work_dir="galaxy_params.json" label="${tool.name} on ${on_string}: Raw Parameters"/>
        <data name="cleaned_params_debug" format="json" from_work_dir="cleaned_params.json" label="${tool.name} on ${on_string}: Cleaned Parameters"/>
        <data name="dataframe" format="csv" from_work_dir="dataframe.csv" label="${tool.name} on ${on_string}: Dataframe"/>
        <collection name="figures" type="list" label="${tool.name} on ${on_string}: Figures">
            <discover_datasets pattern="__name_and_ext__" directory="figures_dir"/>
        </collection>
    </outputs>
    <help><![CDATA[

**Spatial Interaction [SPAC] [DMAP]**
Performs advanced spatial statistical analyses , instead of visualization of spatial distribution, to  evaluate neighborhood enrichments or cluster interactions.\
Please refer to DUET Documentation and GitHub Documentation for further information.
**Outputs:**
- dataframe: file (dataframe.csv)
- figures: directory (figures_dir)

]]></help>
    <citations>
        <citation type="doi">10.1038/s41586-019-1876-x</citation>
    </citations>
</tool>