

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spac.visualization &mdash; spac  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=b3ba4146"></script>
      <script src="../../_static/doctools.js?v=888ff710"></script>
      <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            spac
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Analysis of SPAtial Single Cell Datasets (SPAC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">spac</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../spac.html">spac package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../spac.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../spac.html#module-spac.data_utils">spac.data_utils module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../spac.html#module-spac.phenotyping">spac.phenotyping module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../spac.html#module-spac.spatial_analysis">spac.spatial_analysis module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../spac.html#spac-transformations-module">spac.transformations module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../spac.html#spac-utag-functions-module">spac.utag_functions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../spac.html#module-spac.utils">spac.utils module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../spac.html#module-spac.visualization">spac.visualization module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../spac.html#module-spac">Module contents</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">spac</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">spac.visualization</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spac.visualization</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">anndata</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">plotly.figure_factory</span> <span class="k">as</span> <span class="nn">ff</span>
<span class="kn">import</span> <span class="nn">plotly.io</span> <span class="k">as</span> <span class="nn">pio</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">BoundaryNorm</span>
<span class="kn">from</span> <span class="nn">spac.utils</span> <span class="kn">import</span> <span class="n">check_table</span><span class="p">,</span> <span class="n">check_annotation</span>
<span class="kn">from</span> <span class="nn">spac.utils</span> <span class="kn">import</span> <span class="n">check_feature</span><span class="p">,</span> <span class="n">annotation_category_relations</span>
<span class="kn">from</span> <span class="nn">spac.utils</span> <span class="kn">import</span> <span class="n">check_label</span>
<span class="kn">from</span> <span class="nn">spac.utils</span> <span class="kn">import</span> <span class="n">get_defined_color_map</span>
<span class="kn">from</span> <span class="nn">spac.utils</span> <span class="kn">import</span> <span class="n">compute_boxplot_metrics</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">spac.utils</span> <span class="kn">import</span> <span class="n">color_mapping</span><span class="p">,</span> <span class="n">spell_out_special_characters</span>
<span class="kn">from</span> <span class="nn">spac.data_utils</span> <span class="kn">import</span> <span class="n">select_values</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcolors</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatch</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>


<span class="c1"># Configure logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="visualize_2D_scatter"><a class="viewcode-back" href="../../spac.html#spac.visualization.visualize_2D_scatter">[docs]</a><span class="k">def</span> <span class="nf">visualize_2D_scatter</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annotate_centers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">x_axis_title</span><span class="o">=</span><span class="s1">&#39;Component 1&#39;</span><span class="p">,</span> <span class="n">y_axis_title</span><span class="o">=</span><span class="s1">&#39;Component 2&#39;</span><span class="p">,</span> <span class="n">plot_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">color_representation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize 2D data using plt.scatter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x, y : array-like</span>
<span class="sd">        Coordinates of the data.</span>
<span class="sd">    labels : array-like, optional</span>
<span class="sd">        Array of labels for the data points. Can be numerical or categorical.</span>
<span class="sd">    point_size : float, optional</span>
<span class="sd">        Size of the points. If None, it will be automatically determined.</span>
<span class="sd">    theme : str, optional</span>
<span class="sd">        Color theme for the plot. Defaults to &#39;viridis&#39; if theme not</span>
<span class="sd">        recognized. For a list of supported themes, refer to Matplotlib&#39;s</span>
<span class="sd">        colormap documentation:</span>
<span class="sd">        https://matplotlib.org/stable/tutorials/colors/colormaps.html</span>
<span class="sd">    ax : matplotlib.axes.Axes, optional (default: None)</span>
<span class="sd">        Matplotlib axis object. If None, a new one is created.</span>
<span class="sd">    annotate_centers : bool, optional (default: False)</span>
<span class="sd">        Annotate the centers of clusters if labels are categorical.</span>
<span class="sd">    x_axis_title : str, optional</span>
<span class="sd">        Title for the x-axis.</span>
<span class="sd">    y_axis_title : str, optional</span>
<span class="sd">        Title for the y-axis.</span>
<span class="sd">    plot_title : str, optional</span>
<span class="sd">        Title for the plot.</span>
<span class="sd">    color_representation : str, optional</span>
<span class="sd">        Description of what the colors represent.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional keyword arguments passed to plt.scatter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        The figure of the plot.</span>
<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The axes of the plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Input validation</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x and y must be array-like.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x and y must have the same length.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Labels length should match x and y length.&quot;</span><span class="p">)</span>

    <span class="c1"># Define color themes</span>
    <span class="n">themes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fire&#39;</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;inferno&#39;</span><span class="p">),</span>
        <span class="s1">&#39;viridis&#39;</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">),</span>
        <span class="s1">&#39;inferno&#39;</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;inferno&#39;</span><span class="p">),</span>
        <span class="s1">&#39;blue&#39;</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Blues&#39;</span><span class="p">),</span>
        <span class="s1">&#39;red&#39;</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Reds&#39;</span><span class="p">),</span>
        <span class="s1">&#39;green&#39;</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;Greens&#39;</span><span class="p">),</span>
        <span class="s1">&#39;darkblue&#39;</span><span class="p">:</span> <span class="n">ListedColormap</span><span class="p">([</span><span class="s1">&#39;#00008B&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;darkred&#39;</span><span class="p">:</span> <span class="n">ListedColormap</span><span class="p">([</span><span class="s1">&#39;#8B0000&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;darkgreen&#39;</span><span class="p">:</span> <span class="n">ListedColormap</span><span class="p">([</span><span class="s1">&#39;#006400&#39;</span><span class="p">])</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">theme</span> <span class="ow">and</span> <span class="n">theme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">themes</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Theme &#39;</span><span class="si">{</span><span class="n">theme</span><span class="si">}</span><span class="s2">&#39; not recognized. Please use a valid theme.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">themes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">theme</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">))</span>

    <span class="c1"># Determine point size</span>
    <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">point_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">point_size</span> <span class="o">=</span> <span class="mi">5000</span> <span class="o">/</span> <span class="n">num_points</span>

    <span class="c1"># Get figure size and fontsize from kwargs or set defaults</span>
    <span class="n">fig_width</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fig_width&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">fig_height</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fig_height&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fontsize&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_width</span><span class="p">,</span> <span class="n">fig_height</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

    <span class="c1"># Plotting logic</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Check if labels are categorical</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_categorical_dtype</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>

            <span class="c1"># Determine how to access the categories based on</span>
            <span class="c1"># the type of &#39;labels&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                <span class="n">unique_clusters</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">):</span>
                <span class="n">unique_clusters</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">categories</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;Expected labels to be of type Series[Categorical] or &quot;</span>
                    <span class="s2">&quot;Categorical.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Combine colors from multiple colormaps</span>
            <span class="n">cmap1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;tab20&#39;</span><span class="p">)</span>
            <span class="n">cmap2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;tab20b&#39;</span><span class="p">)</span>
            <span class="n">cmap3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;tab20c&#39;</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">cmap1</span><span class="o">.</span><span class="n">colors</span> <span class="o">+</span> <span class="n">cmap2</span><span class="o">.</span><span class="n">colors</span> <span class="o">+</span> <span class="n">cmap3</span><span class="o">.</span><span class="n">colors</span>

            <span class="c1"># Use the number of unique clusters to set the colormap length</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_clusters</span><span class="p">)])</span>

            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_clusters</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="o">==</span> <span class="n">cluster</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span>
                    <span class="n">s</span><span class="o">=</span><span class="n">point_size</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster: </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s2">, Points: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">annotate_centers</span><span class="p">:</span>
                    <span class="n">center_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
                    <span class="n">center_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                        <span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">cluster</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span>
                    <span class="p">)</span>
            <span class="c1"># Create a custom legend with color representation</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
                <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span>
                <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.25</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>  <span class="c1"># Adjusting position</span>
                <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Color represents: </span><span class="si">{</span><span class="n">color_representation</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If labels are continuous</span>
            <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">color_representation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plot_title</span><span class="si">}</span><span class="se">\n</span><span class="s2">Color represents: </span><span class="si">{</span><span class="n">color_representation</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Equal aspect ratio for the axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="s1">&#39;datalim&#39;</span><span class="p">)</span>

    <span class="c1"># Set axis labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_axis_title</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_axis_title</span><span class="p">)</span>

    <span class="c1"># Set plot title</span>
    <span class="k">if</span> <span class="n">plot_title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_title</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="dimensionality_reduction_plot"><a class="viewcode-back" href="../../spac.html#spac.visualization.dimensionality_reduction_plot">[docs]</a><span class="k">def</span> <span class="nf">dimensionality_reduction_plot</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">associated_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize scatter plot in PCA, t-SNE, UMAP, or associated table.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        The AnnData object with coordinates precomputed by the &#39;tsne&#39; or &#39;UMAP&#39;</span>
<span class="sd">        function and stored in &#39;adata.obsm[&quot;X_tsne&quot;]&#39; or &#39;adata.obsm[&quot;X_umap&quot;]&#39;</span>
<span class="sd">    method : str, optional (default: None)</span>
<span class="sd">        Dimensionality reduction method to visualize.</span>
<span class="sd">        Choose from {&#39;tsne&#39;, &#39;umap&#39;, &#39;pca&#39;}.</span>
<span class="sd">    annotation : str, optional</span>
<span class="sd">        The name of the column in `adata.obs` to use for coloring</span>
<span class="sd">        the scatter plot points based on cell annotations.</span>
<span class="sd">        Takes precedence over `feature`.</span>
<span class="sd">    feature : str, optional</span>
<span class="sd">        The name of the gene or feature in `adata.var_names` to use</span>
<span class="sd">        for coloring the scatter plot points based on feature expression.</span>
<span class="sd">    layer : str, optional</span>
<span class="sd">        The name of the data layer in `adata.layers` to use for visualization.</span>
<span class="sd">        If None, the main data matrix `adata.X` is used.</span>
<span class="sd">    ax : matplotlib.axes.Axes, optional (default: None)</span>
<span class="sd">        A matplotlib axes object to plot on.</span>
<span class="sd">        If not provided, a new figure and axes will be created.</span>
<span class="sd">    associated_table : str, optional (default: None)</span>
<span class="sd">        Name of the key in `obsm` that contains the numpy array. Takes</span>
<span class="sd">        precedence over `method`</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Parameters passed to visualize_2D_scatter function,</span>
<span class="sd">        including point_size.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        The created figure for the plot.</span>
<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The axes of the plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if both annotation and feature are specified, raise error if so</span>
    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">and</span> <span class="n">feature</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Please specify either an annotation or a feature for coloring, &quot;</span>
            <span class="s2">&quot;not both.&quot;</span><span class="p">)</span>

    <span class="c1"># Use utility functions for input validation</span>
    <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
        <span class="n">check_table</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">check_annotation</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">annotation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feature</span><span class="p">:</span>
        <span class="n">check_feature</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="p">[</span><span class="n">feature</span><span class="p">])</span>

    <span class="c1"># Validate the method and check if the necessary data exists in adata.obsm</span>
    <span class="k">if</span> <span class="n">associated_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">valid_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tsne&#39;</span><span class="p">,</span> <span class="s1">&#39;umap&#39;</span><span class="p">,</span> <span class="s1">&#39;pca&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method should be one of {&#39;tsne&#39;, &#39;umap&#39;, &#39;pca&#39;}&quot;</span>
                             <span class="sa">f</span><span class="s1">&#39;. Got:&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;X_</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> coordinates not found in adata.obsm. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Please run </span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> before calling this function.&quot;</span>
            <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">check_table</span><span class="p">(</span>
            <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
            <span class="n">tables</span><span class="o">=</span><span class="n">associated_table</span><span class="p">,</span>
            <span class="n">should_exist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">associated_table</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">associated_table_shape</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">associated_table</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">associated_table_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;The associated table:&quot;</span><span class="si">{</span><span class="n">associated_table</span><span class="si">}</span><span class="s1">&quot; does not have&#39;</span>
                <span class="sa">f</span><span class="s1">&#39; two dimensions. It shape is:&quot;</span><span class="si">{</span><span class="n">associated_table_shape</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">associated_table</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running visualization using the coordinates: &quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

    <span class="c1"># Extract the 2D coordinates</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Determine coloring scheme</span>
    <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">color_values</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">color_representation</span> <span class="o">=</span> <span class="n">annotation</span>
    <span class="k">elif</span> <span class="n">feature</span><span class="p">:</span>
        <span class="n">data_source</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="k">if</span> <span class="n">layer</span> <span class="k">else</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span>
        <span class="n">color_values</span> <span class="o">=</span> <span class="n">data_source</span><span class="p">[:,</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span> <span class="o">==</span> <span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">color_representation</span> <span class="o">=</span> <span class="n">feature</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color_values</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">color_representation</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Set axis titles based on method and color representation</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;tsne&#39;</span><span class="p">:</span>
        <span class="n">x_axis_title</span> <span class="o">=</span> <span class="s1">&#39;t-SNE 1&#39;</span>
        <span class="n">y_axis_title</span> <span class="o">=</span> <span class="s1">&#39;t-SNE 2&#39;</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;TSNE-</span><span class="si">{</span><span class="n">color_representation</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;pca&#39;</span><span class="p">:</span>
        <span class="n">x_axis_title</span> <span class="o">=</span> <span class="s1">&#39;PCA 1&#39;</span>
        <span class="n">y_axis_title</span> <span class="o">=</span> <span class="s1">&#39;PCA 2&#39;</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;PCA-</span><span class="si">{</span><span class="n">color_representation</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;umap&#39;</span><span class="p">:</span>
        <span class="n">x_axis_title</span> <span class="o">=</span> <span class="s1">&#39;UMAP 1&#39;</span>
        <span class="n">y_axis_title</span> <span class="o">=</span> <span class="s1">&#39;UMAP 2&#39;</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;UMAP-</span><span class="si">{</span><span class="n">color_representation</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_axis_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">associated_table</span><span class="si">}</span><span class="s1"> 1&#39;</span>
        <span class="n">y_axis_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">associated_table</span><span class="si">}</span><span class="s1"> 2&#39;</span>
        <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">associated_table</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">color_representation</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="c1"># Remove conflicting keys from kwargs</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;x_axis_title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;y_axis_title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;plot_title&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;color_representation&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">visualize_2D_scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">color_values</span><span class="p">,</span>
        <span class="n">x_axis_title</span><span class="o">=</span><span class="n">x_axis_title</span><span class="p">,</span>
        <span class="n">y_axis_title</span><span class="o">=</span><span class="n">y_axis_title</span><span class="p">,</span>
        <span class="n">plot_title</span><span class="o">=</span><span class="n">plot_title</span><span class="p">,</span>
        <span class="n">color_representation</span><span class="o">=</span><span class="n">color_representation</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="tsne_plot"><a class="viewcode-back" href="../../spac.html#spac.visualization.tsne_plot">[docs]</a><span class="k">def</span> <span class="nf">tsne_plot</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize scatter plot in tSNE basis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        The AnnData object with t-SNE coordinates precomputed by the &#39;tsne&#39;</span>
<span class="sd">        function and stored in &#39;adata.obsm[&quot;X_tsne&quot;]&#39;.</span>
<span class="sd">    color_column : str, optional</span>
<span class="sd">        The name of the column to use for coloring the scatter plot points.</span>
<span class="sd">    ax : matplotlib.axes.Axes, optional (default: None)</span>
<span class="sd">        A matplotlib axes object to plot on.</span>
<span class="sd">        If not provided, a new figure and axes will be created.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Parameters passed to scanpy.pl.tsne function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : matplotlib.figure.Figure</span>
<span class="sd">        The created figure for the plot.</span>
<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The axes of the tsne plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;adata must be an AnnData object.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;X_tsne&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;adata.obsm does not contain &#39;X_tsne&#39;, &quot;</span>
                   <span class="s2">&quot;perform t-SNE transformation first.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="c1"># Create a new figure and axes if not provided</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">color_column</span> <span class="ow">and</span> <span class="p">(</span><span class="n">color_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span>
                         <span class="n">color_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">color_column</span><span class="si">}</span><span class="s2">&#39; not found in adata.obs or adata.var.&quot;</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="c1"># Add color column to the kwargs for the scanpy plot</span>
    <span class="k">if</span> <span class="n">color_column</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_column</span>

    <span class="c1"># Plot the t-SNE</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">tsne</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="histogram"><a class="viewcode-back" href="../../spac.html#spac.visualization.histogram">[docs]</a><span class="k">def</span> <span class="nf">histogram</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">group_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">together</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">x_log_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">y_log_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the histogram of cells based on a specific feature from adata.X</span>
<span class="sd">    or annotation from adata.obs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        The AnnData object.</span>

<span class="sd">    feature : str, optional</span>
<span class="sd">        Name of continuous feature from adata.X to plot its histogram.</span>

<span class="sd">    annotation : str, optional</span>
<span class="sd">        Name of the annotation from adata.obs to plot its histogram.</span>

<span class="sd">    layer : str, optional</span>
<span class="sd">        Name of the layer in adata.layers to plot its histogram.</span>

<span class="sd">    group_by : str, default None</span>
<span class="sd">        Choose either to group the histogram by another column.</span>

<span class="sd">    together : bool, default False</span>
<span class="sd">        If True, and if group_by != None, create one plot combining all groups.</span>
<span class="sd">        If False, create separate histograms for each group.</span>
<span class="sd">        The appearance of combined histograms can be controlled using the</span>
<span class="sd">        `multiple` and `element` parameters in **kwargs.</span>
<span class="sd">        To control how the histograms are normalized (e.g., to divide the</span>
<span class="sd">        histogram by the number of elements in every group), use the `stat`</span>
<span class="sd">        parameter in **kwargs. For example, set `stat=&quot;probability&quot;` to show</span>
<span class="sd">        the relative frequencies of each group.</span>

<span class="sd">    ax : matplotlib.axes.Axes, optional</span>
<span class="sd">        An existing Axes object to draw the plot onto, optional.</span>

<span class="sd">    x_log_scale : bool, default False</span>
<span class="sd">        If True, the data will be transformed using np.log1p before plotting,</span>
<span class="sd">        and the x-axis label will be adjusted accordingly.</span>

<span class="sd">    y_log_scale : bool, default False</span>
<span class="sd">        If True, the y-axis will be set to log scale.</span>

<span class="sd">    **kwargs</span>
<span class="sd">        Additional keyword arguments passed to seaborn histplot function.</span>
<span class="sd">        Key arguments include:</span>
<span class="sd">        - `multiple`: Determines how the subsets of data are displayed</span>
<span class="sd">           on the same axes. Options include:</span>
<span class="sd">            * &quot;layer&quot;: Draws each subset on top of the other</span>
<span class="sd">               without adjustments.</span>
<span class="sd">            * &quot;dodge&quot;: Dodges bars for each subset side by side.</span>
<span class="sd">            * &quot;stack&quot;: Stacks bars for each subset on top of each other.</span>
<span class="sd">            * &quot;fill&quot;: Adjusts bar heights to fill the axes.</span>
<span class="sd">        - `element`: Determines the visual representation of the bins.</span>
<span class="sd">           Options include:</span>
<span class="sd">            * &quot;bars&quot;: Displays the typical bar-style histogram (default).</span>
<span class="sd">            * &quot;step&quot;: Creates a step line plot without bars.</span>
<span class="sd">            * &quot;poly&quot;: Creates a polygon where the bottom edge represents</span>
<span class="sd">               the x-axis and the top edge the histogram&#39;s bins.</span>
<span class="sd">        - `log_scale`: Determines if the data should be plotted on</span>
<span class="sd">           a logarithmic scale.</span>
<span class="sd">        - `stat`: Determines the statistical transformation to use on the data</span>
<span class="sd">           for the histogram. Options include:</span>
<span class="sd">            * &quot;count&quot;: Show the counts of observations in each bin.</span>
<span class="sd">            * &quot;frequency&quot;: Show the number of observations divided</span>
<span class="sd">              by the bin width.</span>
<span class="sd">            * &quot;density&quot;: Normalize such that the total area of the histogram</span>
<span class="sd">               equals 1.</span>
<span class="sd">            * &quot;probability&quot;: Normalize such that each bar&#39;s height reflects</span>
<span class="sd">               the probability of observing that bin.</span>
<span class="sd">        - `bins`: Specification of hist bins.</span>
<span class="sd">            Can be a number (indicating the number of bins) or a list</span>
<span class="sd">            (indicating bin edges). For example, `bins=10` will create 10 bins,</span>
<span class="sd">            while `bins=[0, 1, 2, 3]` will create bins [0,1), [1,2), [2,3].</span>
<span class="sd">            If not provided, the binning will be determined automatically.</span>
<span class="sd">            Note, don&#39;t pass a numpy array, only python lists or strs/numbers.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A dictionary containing the following:</span>
<span class="sd">        fig : matplotlib.figure.Figure</span>
<span class="sd">            The created figure for the plot.</span>

<span class="sd">        axs : matplotlib.axes.Axes or list of Axes</span>
<span class="sd">            The Axes object(s) of the histogram plot(s). Returns a single Axes</span>
<span class="sd">            if only one plot is created, otherwise returns a list of Axes.</span>

<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            DataFrame containing the data used for plotting the histogram.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># If no feature or annotation is specified, apply default behavior</span>
    <span class="k">if</span> <span class="n">feature</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Default to the first feature in adata.var_names</span>
        <span class="n">feature</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;No feature or annotation specified. &quot;</span>
            <span class="s2">&quot;Defaulting to the first feature: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">,</span>
            <span class="ne">UserWarning</span>
        <span class="p">)</span>

    <span class="c1"># Use utility functions for input validation</span>
    <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
        <span class="n">check_table</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">check_annotation</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">annotation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feature</span><span class="p">:</span>
        <span class="n">check_feature</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">feature</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group_by</span><span class="p">:</span>
        <span class="n">check_annotation</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">group_by</span><span class="p">)</span>

    <span class="c1"># If layer is specified, get the data from that layer</span>
    <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
             <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span>
        <span class="p">)</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="s1">&#39;Original&#39;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">feature</span> <span class="ow">and</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot pass both feature and annotation,&quot;</span>
                         <span class="s2">&quot; choose one.&quot;</span><span class="p">)</span>

    <span class="n">data_column</span> <span class="o">=</span> <span class="n">feature</span> <span class="k">if</span> <span class="n">feature</span> <span class="k">else</span> <span class="n">annotation</span>

    <span class="c1"># Check for negative values and apply log1p transformation if</span>
    <span class="c1"># x_log_scale is True</span>
    <span class="k">if</span> <span class="n">x_log_scale</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">data_column</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;There are negative values in the data, disabling x_log_scale.&quot;</span>
            <span class="p">)</span>
            <span class="n">x_log_scale</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">data_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">data_column</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="n">axs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Prepare the data for plotting</span>
    <span class="n">plot_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">data_column</span><span class="p">])</span>

    <span class="c1"># Bin calculation section</span>
    <span class="c1"># The default bin calculation used by sns.histo take quite</span>
    <span class="c1"># some time to compute for large number of points,</span>
    <span class="c1"># DMAP implemented the Rice rule for bin computation</span>

    <span class="k">def</span> <span class="nf">cal_bin_num</span><span class="p">(</span>
        <span class="n">num_rows</span>
    <span class="p">):</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">num_rows</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">))),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Automatically calculated number of bins is: </span><span class="si">{</span><span class="n">bins</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>

    <span class="n">num_rows</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Check if bins is being passed</span>
    <span class="c1"># If not, the in house algorithm will compute the number of bins</span>
    <span class="k">if</span> <span class="s1">&#39;bins&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cal_bin_num</span><span class="p">(</span><span class="n">num_rows</span><span class="p">)</span>

    <span class="c1"># Function to calculate histogram data</span>
    <span class="k">def</span> <span class="nf">calculate_histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">bin_edges</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute histogram data for numeric or categorical input.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - data (pd.Series): The input data to be binned.</span>
<span class="sd">        - bins (int or sequence): Number of bins (if numeric) or unique categories</span>
<span class="sd">            (if categorical).</span>
<span class="sd">        - bin_edges (array-like, optional): Predefined bin edges for numeric data.</span>
<span class="sd">        If None, automatic binning is used.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - pd.DataFrame: A DataFrame containing the following columns:</span>
<span class="sd">            - `count`:</span>
<span class="sd">                Frequency of values in each bin.</span>
<span class="sd">            - `bin_left`:</span>
<span class="sd">                Left edge of each bin (for numeric data).</span>
<span class="sd">            - `bin_right`:</span>
<span class="sd">                Right edge of each bin (for numeric data).</span>
<span class="sd">            - `bin_center`:</span>
<span class="sd">                Center of each bin (for numeric data) or category labels</span>
<span class="sd">                (for categorical data).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if the data is numeric or categorical</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bin_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Compute histogram using automatic binning</span>
                <span class="n">hist</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Compute histogram using predefined bin edges</span>
                <span class="n">hist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">hist</span><span class="p">,</span>
                <span class="s1">&#39;bin_left&#39;</span><span class="p">:</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;bin_right&#39;</span><span class="p">:</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                <span class="s1">&#39;bin_center&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;bin_center&#39;</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="s1">&#39;bin_left&#39;</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="s1">&#39;bin_right&#39;</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">counts</span><span class="o">.</span><span class="n">values</span>
            <span class="p">})</span>

    <span class="c1"># Plotting with or without grouping</span>
    <span class="k">if</span> <span class="n">group_by</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group_by</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_groups</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There must be at least one group to create a&quot;</span>
                             <span class="s2">&quot; histogram.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">together</span><span class="p">:</span>
            <span class="c1"># Compute global bin edges based on the entire dataset</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="n">data_column</span><span class="p">]):</span>
                <span class="n">global_bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram_bin_edges</span><span class="p">(</span>
                    <span class="n">plot_data</span><span class="p">[</span><span class="n">data_column</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">global_bin_edges</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">data_column</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

            <span class="n">hist_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Compute histograms for each group separately and combine them</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">group_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span>
                    <span class="n">plot_data</span><span class="p">[</span><span class="n">group_by</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span>
                <span class="p">][</span><span class="n">data_column</span><span class="p">]</span>
                <span class="n">group_hist</span> <span class="o">=</span> <span class="n">calculate_histogram</span><span class="p">(</span><span class="n">group_data</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">],</span>
                                                 <span class="n">bin_edges</span><span class="o">=</span><span class="n">global_bin_edges</span><span class="p">)</span>
                <span class="n">group_hist</span><span class="p">[</span><span class="n">group_by</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
                <span class="n">hist_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_hist</span><span class="p">)</span>
            <span class="n">hist_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">hist_data</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Set default values if not provided in kwargs</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;multiple&quot;</span><span class="p">,</span> <span class="s2">&quot;stack&quot;</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;element&quot;</span><span class="p">,</span> <span class="s2">&quot;bars&quot;</span><span class="p">)</span>


            <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;bin_center&#39;</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span>
                         <span class="n">hue</span><span class="o">=</span><span class="n">group_by</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># If plotting feature specify which layer</span>
            <span class="k">if</span> <span class="n">feature</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Layer: </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax_array</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">n_groups</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">n_groups</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Convert a single Axes object to a list</span>
            <span class="c1"># Ensure ax_array is always iterable</span>
            <span class="k">if</span> <span class="n">n_groups</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ax_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax_array</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax_array</span> <span class="o">=</span> <span class="n">ax_array</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax_array</span><span class="p">):</span>
                <span class="n">group_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_data</span><span class="p">[</span><span class="n">group_by</span><span class="p">]</span> <span class="o">==</span>
                             <span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">data_column</span><span class="p">]</span>
                <span class="n">hist_data</span> <span class="o">=</span> <span class="n">calculate_histogram</span><span class="p">(</span><span class="n">group_data</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">])</span>

                <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;bin_center&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_i</span><span class="p">,</span>
                    <span class="n">weights</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># If plotting feature specify which layer</span>
                <span class="k">if</span> <span class="n">feature</span><span class="p">:</span>
                    <span class="n">ax_i</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> with Layer: </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax_i</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">groups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="c1"># Set axis scales if y_log_scale is True</span>
                <span class="k">if</span> <span class="n">y_log_scale</span><span class="p">:</span>
                    <span class="n">ax_i</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

                <span class="c1"># Adjust x-axis label if x_log_scale is True</span>
                <span class="k">if</span> <span class="n">x_log_scale</span><span class="p">:</span>
                    <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;log(</span><span class="si">{</span><span class="n">data_column</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xlabel</span> <span class="o">=</span> <span class="n">data_column</span>
                <span class="n">ax_i</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

                <span class="c1"># Adjust y-axis label based on &#39;stat&#39; parameter</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
                <span class="n">ylabel_map</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="s1">&#39;Count&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="s1">&#39;Frequency&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="s1">&#39;Density&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="s1">&#39;Probability&#39;</span>
                <span class="p">}</span>
                <span class="n">ylabel</span> <span class="o">=</span> <span class="n">ylabel_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">y_log_scale</span><span class="p">:</span>
                    <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;log(</span><span class="si">{</span><span class="n">ylabel</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="n">ax_i</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

                <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax_i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Precompute histogram data for single plot</span>
        <span class="n">hist_data</span> <span class="o">=</span> <span class="n">calculate_histogram</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="n">data_column</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[</span><span class="n">data_column</span><span class="p">]):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">hist_data</span><span class="p">[</span><span class="s1">&#39;bin_left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
            <span class="n">hist_data</span><span class="p">[</span><span class="s1">&#39;bin_right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">hist_data</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;bin_center&#39;</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># If plotting feature specify which layer</span>
        <span class="k">if</span> <span class="n">feature</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Layer: </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="c1"># Set axis scales if y_log_scale is True</span>
    <span class="k">if</span> <span class="n">y_log_scale</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

    <span class="c1"># Adjust x-axis label if x_log_scale is True</span>
    <span class="k">if</span> <span class="n">x_log_scale</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;log(</span><span class="si">{</span><span class="n">data_column</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="n">data_column</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>

    <span class="c1"># Adjust y-axis label based on &#39;stat&#39; parameter</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
    <span class="n">ylabel_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="s1">&#39;Count&#39;</span><span class="p">,</span>
        <span class="s1">&#39;frequency&#39;</span><span class="p">:</span> <span class="s1">&#39;Frequency&#39;</span><span class="p">,</span>
        <span class="s1">&#39;density&#39;</span><span class="p">:</span> <span class="s1">&#39;Density&#39;</span><span class="p">,</span>
        <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="s1">&#39;Probability&#39;</span>
    <span class="p">}</span>
    <span class="n">ylabel</span> <span class="o">=</span> <span class="n">ylabel_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">y_log_scale</span><span class="p">:</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;log(</span><span class="si">{</span><span class="n">ylabel</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;fig&quot;</span><span class="p">:</span> <span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;axs&quot;</span><span class="p">:</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="n">hist_data</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;fig&quot;</span><span class="p">:</span> <span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;axs&quot;</span><span class="p">:</span> <span class="n">axs</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="n">hist_data</span><span class="p">}</span></div>

<div class="viewcode-block" id="heatmap"><a class="viewcode-back" href="../../spac.html#spac.visualization.heatmap">[docs]</a><span class="k">def</span> <span class="nf">heatmap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the heatmap of the mean feature of cells that belong to a `column`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">         The AnnData object.</span>

<span class="sd">    column : str</span>
<span class="sd">        Name of member of adata.obs to plot the histogram.</span>

<span class="sd">    layer : str, default None</span>
<span class="sd">        The name of the `adata` layer to use to calculate the mean feature.</span>

<span class="sd">    **kwargs:</span>
<span class="sd">        Parameters passed to seaborn heatmap function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        A dataframe tha has the labels as indexes the mean feature for every</span>
<span class="sd">        marker.</span>

<span class="sd">    matplotlib.figure.Figure</span>
<span class="sd">        The figure of the heatmap.</span>

<span class="sd">    matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">        The AsxesSubplot of the heatmap.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
    <span class="n">mean_feature</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_feature</span><span class="p">)</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_feature</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">))</span>
    <span class="n">seaborn</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
        <span class="n">mean_feature</span><span class="p">,</span>
        <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
        <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.1f&quot;</span><span class="p">,</span>
        <span class="n">cbar_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">use_gridspec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">),</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span>
        <span class="n">annot_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mean_feature</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="hierarchical_heatmap"><a class="viewcode-back" href="../../spac.html#spac.visualization.hierarchical_heatmap">[docs]</a><span class="k">def</span> <span class="nf">hierarchical_heatmap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">cluster_feature</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cluster_annotations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">standard_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">z_score</span><span class="o">=</span><span class="s2">&quot;annotation&quot;</span><span class="p">,</span>
                         <span class="n">swap_axes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rotate_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a hierarchical clustering heatmap and dendrogram.</span>
<span class="sd">    By default, the dataset is assumed to have features as columns and</span>
<span class="sd">    annotations as rows. Cells are grouped by annotation (e.g., phenotype),</span>
<span class="sd">    and for each group, the average expression intensity of each feature</span>
<span class="sd">    (e.g., protein or marker) is computed. The heatmap is plotted using</span>
<span class="sd">    seaborn&#39;s clustermap.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        The AnnData object.</span>
<span class="sd">    annotation : str</span>
<span class="sd">        Name of the annotation in adata.obs to group by and calculate mean</span>
<span class="sd">        intensity.</span>
<span class="sd">    features : list or None, optional</span>
<span class="sd">        List of feature names (e.g., markers) to be included in the</span>
<span class="sd">        visualization. If None, all features are used. Default is None.</span>
<span class="sd">    layer : str, optional</span>
<span class="sd">        The name of the `adata` layer to use to calculate the mean intensity.</span>
<span class="sd">        If not provided, uses the main matrix. Default is None.</span>
<span class="sd">    cluster_feature : bool, optional</span>
<span class="sd">        If True, perform hierarchical clustering on the feature axis.</span>
<span class="sd">        Default is False.</span>
<span class="sd">    cluster_annotations : bool, optional</span>
<span class="sd">        If True, perform hierarchical clustering on the annotations axis.</span>
<span class="sd">        Default is False.</span>
<span class="sd">    standard_scale : int or None, optional</span>
<span class="sd">        Whether to standard scale data (0: row-wise or 1: column-wise).</span>
<span class="sd">        Default is None.</span>
<span class="sd">    z_score : str, optional</span>
<span class="sd">        Specifies the axis for z-score normalization. Can be &quot;feature&quot; or</span>
<span class="sd">        &quot;annotation&quot;. Default is &quot;annotation&quot;.</span>
<span class="sd">    swap_axes : bool, optional</span>
<span class="sd">        If True, switches the axes of the heatmap, effectively transposing</span>
<span class="sd">        the dataset. By default (when False), annotations are on the vertical</span>
<span class="sd">        axis (rows) and features are on the horizontal axis (columns).</span>
<span class="sd">        When set to True, features will be on the vertical axis and</span>
<span class="sd">        annotations on the horizontal axis. Default is False.</span>
<span class="sd">    rotate_label : bool, optional</span>
<span class="sd">        If True, rotate x-axis labels by 45 degrees. Default is False.</span>
<span class="sd">    **kwargs:</span>
<span class="sd">        Additional parameters passed to `sns.clustermap` function or its</span>
<span class="sd">        underlying functions. Some essential parameters include:</span>
<span class="sd">        - `cmap` : colormap</span>
<span class="sd">          Colormap to use for the heatmap. It&#39;s an argument for the underlying</span>
<span class="sd">          `sns.heatmap()` used within `sns.clustermap()`. Examples include</span>
<span class="sd">          &quot;viridis&quot;, &quot;plasma&quot;, &quot;coolwarm&quot;, etc.</span>
<span class="sd">        - `{row,col}_colors` : Lists or DataFrames</span>
<span class="sd">          Colors to use for annotating the rows/columns. Useful for visualizing</span>
<span class="sd">          additional categorical information alongside the main heatmap.</span>
<span class="sd">        - `{dendrogram,colors}_ratio` : tuple(float)</span>
<span class="sd">          Control the size proportions of the dendrogram and the color labels</span>
<span class="sd">          relative to the main heatmap.</span>
<span class="sd">        - `cbar_pos` : tuple(float) or None</span>
<span class="sd">          Specify the position and size of the colorbar in the figure. If set</span>
<span class="sd">          to None, no colorbar will be added.</span>
<span class="sd">        - `tree_kws` : dict</span>
<span class="sd">          Customize the appearance of the dendrogram tree. Passes additional</span>
<span class="sd">          keyword arguments to the underlying</span>
<span class="sd">          `matplotlib.collections.LineCollection`.</span>
<span class="sd">        - `method` : str</span>
<span class="sd">          The linkage algorithm to use for the hierarchical clustering.</span>
<span class="sd">          Defaults to &#39;centroid&#39; in the function, but can be changed.</span>
<span class="sd">        - `metric` : str</span>
<span class="sd">          The distance metric to use for the hierarchy. Defaults to &#39;euclidean&#39;</span>
<span class="sd">          in the function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mean_intensity : pandas.DataFrame</span>
<span class="sd">        A DataFrame containing the mean intensity of cells for each annotation.</span>
<span class="sd">    clustergrid : seaborn.matrix.ClusterGrid</span>
<span class="sd">        The seaborn ClusterGrid object representing the heatmap and</span>
<span class="sd">        dendrograms.</span>
<span class="sd">    dendrogram_data : dict</span>
<span class="sd">        A dictionary containing hierarchical clustering linkage data for both</span>
<span class="sd">        rows and columns. These linkage matrices can be used to generate</span>
<span class="sd">        dendrograms with tools like scipy&#39;s dendrogram function. This offers</span>
<span class="sd">        flexibility in customizing and plotting dendrograms as needed.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    import matplotlib.pyplot as plt</span>
<span class="sd">    import pandas as pd</span>
<span class="sd">    import anndata</span>
<span class="sd">    from spac.visualization import hierarchical_heatmap</span>
<span class="sd">    X = pd.DataFrame([[1, 2], [3, 4]], columns=[&#39;gene1&#39;, &#39;gene2&#39;])</span>
<span class="sd">    annotation = pd.DataFrame([&#39;type1&#39;, &#39;type2&#39;], columns=[&#39;cell_type&#39;])</span>
<span class="sd">    all_data = anndata.AnnData(X=X, obs=annotation)</span>

<span class="sd">    mean_intensity, clustergrid, dendrogram_data = hierarchical_heatmap(</span>
<span class="sd">        all_data,</span>
<span class="sd">        &quot;cell_type&quot;,</span>
<span class="sd">        layer=None,</span>
<span class="sd">        z_score=&quot;annotation&quot;,</span>
<span class="sd">        swap_axes=True,</span>
<span class="sd">        cluster_feature=False,</span>
<span class="sd">        cluster_annotations=True</span>
<span class="sd">    )</span>

<span class="sd">    # To display a standalone dendrogram using the returned linkage matrix:</span>
<span class="sd">    import scipy.cluster.hierarchy as sch</span>
<span class="sd">    import numpy as np</span>
<span class="sd">    import matplotlib.pyplot as plt</span>

<span class="sd">    # Convert the linkage data to type double</span>
<span class="sd">    dendro_col_data = np.array(dendrogram_data[&#39;col_linkage&#39;], dtype=np.double)</span>

<span class="sd">    # Ensure the linkage matrix has at least two dimensions and</span>
<span class="sd">    more than one linkage</span>
<span class="sd">    if dendro_col_data.ndim == 2 and dendro_col_data.shape[0] &gt; 1:</span>
<span class="sd">        fig, ax = plt.subplots(figsize=(10, 7))</span>
<span class="sd">        sch.dendrogram(dendro_col_data, ax=ax)</span>
<span class="sd">        plt.title(&#39;Standalone Col Dendrogram&#39;)</span>
<span class="sd">        plt.show()</span>
<span class="sd">    else:</span>
<span class="sd">        print(&quot;Insufficient data to plot a dendrogram.&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Use utility functions to check inputs</span>
    <span class="n">check_annotation</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">annotation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">check_feature</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
        <span class="n">check_table</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>

    <span class="c1"># Raise an error if there are any NaN values in the annotation column</span>
    <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;NaN values found in annotation column.&quot;</span><span class="p">)</span>

    <span class="c1"># Convert the observation column to categorical if it&#39;s not already</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_categorical_dtype</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation</span><span class="p">]):</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

    <span class="c1"># Calculate mean intensity</span>
    <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
        <span class="n">intensities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">],</span>
            <span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">intensities</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">intensities</span><span class="p">,</span> <span class="n">labels</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
    <span class="n">mean_intensity</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># If swap_axes is True, transpose the mean_intensity</span>
    <span class="k">if</span> <span class="n">swap_axes</span><span class="p">:</span>
        <span class="n">mean_intensity</span> <span class="o">=</span> <span class="n">mean_intensity</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Map z_score based on user&#39;s input and the state of swap_axes</span>
    <span class="k">if</span> <span class="n">z_score</span> <span class="o">==</span> <span class="s2">&quot;annotation&quot;</span><span class="p">:</span>
        <span class="n">z_score</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">swap_axes</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">z_score</span> <span class="o">==</span> <span class="s2">&quot;feature&quot;</span><span class="p">:</span>
        <span class="n">z_score</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">swap_axes</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># Subset the mean_intensity DataFrame based on selected features</span>
    <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mean_intensity</span> <span class="o">=</span> <span class="n">mean_intensity</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>

    <span class="c1"># Determine clustering behavior based on swap_axes</span>
    <span class="k">if</span> <span class="n">swap_axes</span><span class="p">:</span>
        <span class="n">row_cluster</span> <span class="o">=</span> <span class="n">cluster_feature</span>  <span class="c1"># Rows are features</span>
        <span class="n">col_cluster</span> <span class="o">=</span> <span class="n">cluster_annotations</span>  <span class="c1"># Columns are annotations</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">row_cluster</span> <span class="o">=</span> <span class="n">cluster_annotations</span>  <span class="c1"># Rows are annotations</span>
        <span class="n">col_cluster</span> <span class="o">=</span> <span class="n">cluster_feature</span>  <span class="c1"># Columns are features</span>

    <span class="c1"># Use seaborn&#39;s clustermap for hierarchical clustering and</span>
    <span class="c1"># heatmap visualization.</span>
    <span class="n">clustergrid</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span>
        <span class="n">mean_intensity</span><span class="p">,</span>
        <span class="n">standard_scale</span><span class="o">=</span><span class="n">standard_scale</span><span class="p">,</span>
        <span class="n">z_score</span><span class="o">=</span><span class="n">z_score</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;centroid&#39;</span><span class="p">,</span>
        <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span>
        <span class="n">row_cluster</span><span class="o">=</span><span class="n">row_cluster</span><span class="p">,</span>
        <span class="n">col_cluster</span><span class="o">=</span><span class="n">col_cluster</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="c1"># Rotate x-axis tick labels if rotate_label is True</span>
    <span class="k">if</span> <span class="n">rotate_label</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">clustergrid</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>

    <span class="c1"># Extract the dendrogram data for return</span>
    <span class="n">dendro_row_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dendro_col_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">clustergrid</span><span class="o">.</span><span class="n">dendrogram_row</span><span class="p">:</span>
        <span class="n">dendro_row_data</span> <span class="o">=</span> <span class="n">clustergrid</span><span class="o">.</span><span class="n">dendrogram_row</span><span class="o">.</span><span class="n">linkage</span>

    <span class="k">if</span> <span class="n">clustergrid</span><span class="o">.</span><span class="n">dendrogram_col</span><span class="p">:</span>
        <span class="n">dendro_col_data</span> <span class="o">=</span> <span class="n">clustergrid</span><span class="o">.</span><span class="n">dendrogram_col</span><span class="o">.</span><span class="n">linkage</span>

    <span class="c1"># Define the dendrogram_data dictionary</span>
    <span class="n">dendrogram_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;row_linkage&#39;</span><span class="p">:</span> <span class="n">dendro_row_data</span><span class="p">,</span>
        <span class="s1">&#39;col_linkage&#39;</span><span class="p">:</span> <span class="n">dendro_col_data</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">mean_intensity</span><span class="p">,</span> <span class="n">clustergrid</span><span class="p">,</span> <span class="n">dendrogram_data</span></div>


<div class="viewcode-block" id="threshold_heatmap"><a class="viewcode-back" href="../../spac.html#spac.visualization.threshold_heatmap">[docs]</a><span class="k">def</span> <span class="nf">threshold_heatmap</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span> <span class="n">feature_cutoffs</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">swap_axes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a heatmap for each feature, categorizing intensities into low,</span>
<span class="sd">    medium, and high based on provided cutoffs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        AnnData object containing the feature intensities in .X attribute</span>
<span class="sd">        or specified layer.</span>
<span class="sd">    feature_cutoffs : dict</span>
<span class="sd">        Dictionary with feature names as keys and tuples with two intensity</span>
<span class="sd">        cutoffs as values.</span>
<span class="sd">    annotation : str</span>
<span class="sd">        Column name in .obs DataFrame that contains the annotation</span>
<span class="sd">        used for grouping.</span>
<span class="sd">    layer : str, optional</span>
<span class="sd">        Layer name in adata.layers to use for intensities.</span>
<span class="sd">        If None, uses .X attribute.</span>
<span class="sd">    swap_axes : bool, optional</span>
<span class="sd">        If True, swaps the axes of the heatmap.</span>
<span class="sd">    **kwargs : keyword arguments</span>
<span class="sd">        Additional keyword arguments to pass to scanpy&#39;s heatmap function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dictionary of :class:`~matplotlib.axes.Axes`</span>
<span class="sd">        A dictionary contains the axes of figures generated in the scanpy</span>
<span class="sd">        heatmap function.</span>
<span class="sd">        Consistent Key: &#39;heatmap_ax&#39;</span>
<span class="sd">        Potential Keys includes: &#39;groupby_ax&#39;, &#39;dendrogram_ax&#39;, and</span>
<span class="sd">        &#39;gene_groups_ax&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Use utility functions for input validation</span>
    <span class="n">check_table</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
    <span class="n">check_annotation</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">annotation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">feature_cutoffs</span><span class="p">:</span>
        <span class="n">check_feature</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">feature_cutoffs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="c1"># Assert annotation is a string</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">err_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Annotation should be string. Got </span><span class="si">{</span><span class="n">err_type</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_cutoffs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;feature_cutoffs should be a dictionary.&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">feature_cutoffs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Each value in feature_cutoffs should be a &quot;</span>
                <span class="s2">&quot;tuple of two elements.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Low cutoff for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> should not be NaN.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;High cutoff for </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> should not be NaN.&quot;</span><span class="p">)</span>

    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;feature_cutoffs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_cutoffs</span>

    <span class="n">intensity_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">feature_cutoffs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">feature</span><span class="p">,</span> <span class="n">cutoffs</span> <span class="ow">in</span> <span class="n">feature_cutoffs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">low_cutoff</span><span class="p">,</span> <span class="n">high_cutoff</span> <span class="o">=</span> <span class="n">cutoffs</span>
        <span class="n">feature_values</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">adata</span><span class="p">[:,</span> <span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">layer</span> <span class="k">else</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
        <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">intensity_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature_values</span> <span class="o">&lt;=</span> <span class="n">low_cutoff</span><span class="p">,</span> <span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">intensity_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">feature_values</span> <span class="o">&gt;</span> <span class="n">low_cutoff</span><span class="p">)</span> <span class="o">&amp;</span>
                         <span class="p">(</span><span class="n">feature_values</span> <span class="o">&lt;=</span> <span class="n">high_cutoff</span><span class="p">),</span> <span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">intensity_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">feature_values</span> <span class="o">&gt;</span> <span class="n">high_cutoff</span><span class="p">,</span> <span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">intensity_df</span> <span class="o">=</span> <span class="n">intensity_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

    <span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span> <span class="mi">139</span><span class="o">/</span><span class="mi">255</span><span class="p">),</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;yellow&#39;</span><span class="p">}</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">color_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>

    <span class="n">norm</span> <span class="o">=</span> <span class="n">BoundaryNorm</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">],</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>

    <span class="n">heatmap_plot</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">,</span>
        <span class="n">var_names</span><span class="o">=</span><span class="n">intensity_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
        <span class="n">groupby</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>
        <span class="n">use_raw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">layer</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>   <span class="c1"># Ensure the plot is not displayed but returned</span>
        <span class="n">swap_axes</span><span class="o">=</span><span class="n">swap_axes</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="c1"># Print the keys of the heatmap_plot dictionary</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Keys of heatmap_plot:&quot;</span><span class="p">,</span> <span class="n">heatmap_plot</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="c1"># Get the main heatmap axis from the available keys</span>
    <span class="n">heatmap_ax</span> <span class="o">=</span> <span class="n">heatmap_plot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;heatmap_ax&#39;</span><span class="p">)</span>

    <span class="c1"># If &#39;heatmap_ax&#39; key does not exist, access the first axis available</span>
    <span class="k">if</span> <span class="n">heatmap_ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">heatmap_ax</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">heatmap_plot</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Heatmap Axes:&quot;</span><span class="p">,</span> <span class="n">heatmap_ax</span><span class="p">)</span>

    <span class="c1"># Find the colorbar associated with the heatmap</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">heatmap_ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="s1">&#39;colorbar&#39;</span><span class="p">):</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">colorbar</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">cbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No colorbar found in the plot.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Colorbar:&quot;</span><span class="p">,</span> <span class="n">cbar</span><span class="p">)</span>

    <span class="n">new_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">new_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Medium&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">]</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">new_ticks</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="n">new_labels</span><span class="p">)</span>
    <span class="n">pos_heatmap</span> <span class="o">=</span> <span class="n">heatmap_ax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span>
        <span class="p">[</span><span class="n">pos_heatmap</span><span class="o">.</span><span class="n">x1</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">pos_heatmap</span><span class="o">.</span><span class="n">y0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">pos_heatmap</span><span class="o">.</span><span class="n">height</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">heatmap_plot</span></div>


<div class="viewcode-block" id="spatial_plot"><a class="viewcode-back" href="../../spac.html#spac.visualization.spatial_plot">[docs]</a><span class="k">def</span> <span class="nf">spatial_plot</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">,</span>
        <span class="n">spot_size</span><span class="p">,</span>
        <span class="n">alpha</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=-</span><span class="mi">999</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=-</span><span class="mi">999</span><span class="p">,</span>
        <span class="n">annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the spatial plot of selected features</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        The AnnData object containing target feature and spatial coordinates.</span>

<span class="sd">    spot_size : int</span>
<span class="sd">        The size of spot on the spatial plot.</span>
<span class="sd">    alpha : float</span>
<span class="sd">        The transparency of spots, range from 0 (invisible) to 1 (solid)</span>
<span class="sd">    vmin : float or int</span>
<span class="sd">        The lower limit of the feature value for visualization</span>
<span class="sd">    vmax : float or int</span>
<span class="sd">        The upper limit of the feature value for visualization</span>
<span class="sd">    feature : str</span>
<span class="sd">        The feature to visualize on the spatial plot.</span>
<span class="sd">        Default None.</span>
<span class="sd">    annotation : str</span>
<span class="sd">        The annotation to visualize in the spatial plot.</span>
<span class="sd">        Can&#39;t be set with feature, default None.</span>
<span class="sd">    layer : str</span>
<span class="sd">        Name of the AnnData object layer that wants to be plotted.</span>
<span class="sd">        By default adata.raw.X is plotted.</span>
<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The matplotlib Axes containing the analysis plots.</span>
<span class="sd">        The returned ax is the passed ax or new ax created.</span>
<span class="sd">        Only works if plotting a single component.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Arguments to pass to matplotlib.pyplot.scatter()</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        Single or a list of class:`~matplotlib.axes.Axes`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">err_msg_layer</span> <span class="o">=</span> <span class="s2">&quot;The &#39;layer&#39; parameter must be a string, &quot;</span> <span class="o">+</span> \
        <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">layer</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">err_msg_feature</span> <span class="o">=</span> <span class="s2">&quot;The &#39;feature&#39; parameter must be a string, &quot;</span> <span class="o">+</span> \
        <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">feature</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">err_msg_annotation</span> <span class="o">=</span> <span class="s2">&quot;The &#39;annotation&#39; parameter must be a string, &quot;</span> <span class="o">+</span> \
        <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">annotation</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">err_msg_feat_annotation_coe</span> <span class="o">=</span> <span class="s2">&quot;Both annotation and feature are passed, &quot;</span> <span class="o">+</span>\
        <span class="s2">&quot;please provide sinle input.&quot;</span>
    <span class="n">err_msg_feat_annotation_non</span> <span class="o">=</span> <span class="s2">&quot;Both annotation and feature are None, &quot;</span> <span class="o">+</span> \
        <span class="s2">&quot;please provide single input.&quot;</span>
    <span class="n">err_msg_spot_size</span> <span class="o">=</span> <span class="s2">&quot;The &#39;spot_size&#39; parameter must be an integer, &quot;</span> <span class="o">+</span> \
        <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">spot_size</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">err_msg_alpha_type</span> <span class="o">=</span> <span class="s2">&quot;The &#39;alpha&#39; parameter must be a float,&quot;</span> <span class="o">+</span> \
        <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">err_msg_alpha_value</span> <span class="o">=</span> <span class="s2">&quot;The &#39;alpha&#39; parameter must be between &quot;</span> <span class="o">+</span> \
        <span class="sa">f</span><span class="s2">&quot;0 and 1 (inclusive), got </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">err_msg_vmin</span> <span class="o">=</span> <span class="s2">&quot;The &#39;vmin&#39; parameter must be a float or an int, &quot;</span> <span class="o">+</span> \
        <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">vmin</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">err_msg_vmax</span> <span class="o">=</span> <span class="s2">&quot;The &#39;vmax&#39; parameter must be a float or an int, &quot;</span> <span class="o">+</span> \
        <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">vmax</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">err_msg_ax</span> <span class="o">=</span> <span class="s2">&quot;The &#39;ax&#39; parameter must be an instance &quot;</span> <span class="o">+</span> \
        <span class="sa">f</span><span class="s2">&quot;of matplotlib.axes.Axes, got </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ax</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">adata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input dataset must not be None.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
        <span class="n">err_msg_adata</span> <span class="o">=</span> <span class="s2">&quot;The &#39;adata&#39; parameter must be an &quot;</span> <span class="o">+</span> \
            <span class="sa">f</span><span class="s2">&quot;instance of anndata.AnnData, got </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">adata</span><span class="p">))</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_adata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_layer</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">err_msg_layer_exist</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Layer </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2"> does not exists, &quot;</span> <span class="o">+</span> \
            <span class="sa">f</span><span class="s2">&quot;available layers are </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_layer_exist</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_feature</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_annotation</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_feat_annotation_coe</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">feature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_feat_annotation_non</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;spatial&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm_keys</span><span class="p">():</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Spatial coordinates not found in the &#39;obsm&#39; attribute.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="c1"># Extract annotation name</span>
    <span class="n">annotation_names</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">annotation_names_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">annotation_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">annotation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annotation_names</span><span class="p">:</span>
        <span class="n">error_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;The annotation &quot;</span><span class="si">{</span><span class="n">annotation</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;not found in the dataset.&#39;</span> <span class="o">+</span> \
            <span class="sa">f</span><span class="s2">&quot; Existing annotations are: </span><span class="si">{</span><span class="n">annotation_names_str</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_text</span><span class="p">)</span>

    <span class="c1"># Extract feature name</span>
    <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">layer_process</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">layer_process</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>

    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">feature</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">:</span>
        <span class="n">error_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Feature </span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s2"> not found,&quot;</span> <span class="o">+</span> \
            <span class="s2">&quot; please check the sample metadata.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_text</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spot_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_spot_size</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_alpha_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">alpha</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_alpha_value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vmin</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">999</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_vmin</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vmax</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">999</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vmax</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_vmax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg_ax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">feature_index</span> <span class="o">=</span> <span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
        <span class="n">feature_annotation</span> <span class="o">=</span> <span class="n">feature</span> <span class="o">+</span> <span class="s2">&quot;spatial_plot&quot;</span>
        <span class="k">if</span> <span class="n">vmin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span><span class="p">:</span>
            <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">layer_process</span><span class="p">[:,</span> <span class="n">feature_index</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">vmax</span> <span class="o">==</span> <span class="o">-</span><span class="mi">999</span><span class="p">:</span>
            <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">layer_process</span><span class="p">[:,</span> <span class="n">feature_index</span><span class="p">])</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">feature_annotation</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_process</span><span class="p">[:,</span> <span class="n">feature_index</span><span class="p">]</span>
        <span class="n">color_region</span> <span class="o">=</span> <span class="n">feature_annotation</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color_region</span> <span class="o">=</span> <span class="n">annotation</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span>
        <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
        <span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">color_region</span><span class="p">,</span>
        <span class="n">spot_size</span><span class="o">=</span><span class="n">spot_size</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="boxplot"><a class="viewcode-back" href="../../spac.html#spac.visualization.boxplot">[docs]</a><span class="k">def</span> <span class="nf">boxplot</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">second_annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a boxplot visualization of the features in the passed adata object.</span>
<span class="sd">    This function offers flexibility in how the boxplots are displayed,</span>
<span class="sd">    based on the arguments provided.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        The AnnData object.</span>

<span class="sd">    annotation : str, optional</span>
<span class="sd">        Annotation to determine if separate plots are needed for every label.</span>

<span class="sd">    second_annotation : str, optional</span>
<span class="sd">        Second annotation to further divide the data.</span>

<span class="sd">    layer : str, optional</span>
<span class="sd">        The name of the matrix layer to use. If not provided,</span>
<span class="sd">        uses the main data matrix adata.X.</span>

<span class="sd">    ax : matplotlib.axes.Axes, optional</span>
<span class="sd">        An existing Axes object to draw the plot onto, optional.</span>

<span class="sd">    features : list, optional</span>
<span class="sd">        List of feature names to be plotted.</span>
<span class="sd">        If not provided, all features will be plotted.</span>

<span class="sd">    log_scale : bool, optional</span>
<span class="sd">        If True, the Y-axis will be in log scale. Default is False.</span>

<span class="sd">    **kwargs</span>
<span class="sd">        Additional arguments to pass to seaborn.boxplot.</span>
<span class="sd">        Key arguments include:</span>
<span class="sd">        - `orient`: Determines the orientation of the plot.</span>
<span class="sd">        * &quot;v&quot;: Vertical orientation (default). In this case, categorical data</span>
<span class="sd">           will be plotted on the x-axis, and the boxplots will be vertical.</span>
<span class="sd">        * &quot;h&quot;: Horizontal orientation. Categorical data will be plotted on the</span>
<span class="sd">           y-axis, and the boxplots will be horizontal.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig, ax : matplotlib.figure.Figure, matplotlib.axes.Axes</span>
<span class="sd">        The created figure and axes for the plot.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    - Multiple features boxplot: boxplot(adata, features=[&#39;GeneA&#39;,&#39;GeneB&#39;])</span>
<span class="sd">    - Boxplot grouped by a single annotation:</span>
<span class="sd">      boxplot(adata, features=[&#39;GeneA&#39;], annotation=&#39;cell_type&#39;)</span>
<span class="sd">    - Boxplot for multiple features grouped by a single annotation:</span>
<span class="sd">      boxplot(adata, features=[&#39;GeneA&#39;, &#39;GeneB&#39;], annotation=&#39;cell_type&#39;)</span>
<span class="sd">    - Nested grouping by two annotations: boxplot(adata, features=[&#39;GeneA&#39;],</span>
<span class="sd">      annotation=&#39;cell_type&#39;, second_annotation=&#39;treatment&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Use utility functions to check inputs</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating Box Plot...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
        <span class="n">check_table</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">check_annotation</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">annotation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">second_annotation</span><span class="p">:</span>
        <span class="n">check_annotation</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">second_annotation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">check_feature</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;orient&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;orient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;v&#39;</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;orient&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span>
        <span class="n">v_orient</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">v_orient</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Validate ax instance</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input &#39;ax&#39; must be a matplotlib.axes.Axes object.&quot;</span><span class="p">)</span>

    <span class="c1"># Use the specified layer if provided</span>
    <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
        <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span>

    <span class="c1"># Create a DataFrame from the data matrix with features as columns</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_matrix</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>

    <span class="c1"># Add annotations to the DataFrame if provided</span>
    <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">if</span> <span class="n">second_annotation</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">second_annotation</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">second_annotation</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># If features is None, set it to all available features</span>
    <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
        <span class="n">features</span> <span class="o">+</span>
        <span class="p">([</span><span class="n">annotation</span><span class="p">]</span> <span class="k">if</span> <span class="n">annotation</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span>
        <span class="p">([</span><span class="n">second_annotation</span><span class="p">]</span> <span class="k">if</span> <span class="n">second_annotation</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="p">]</span>

    <span class="c1"># Check for negative values</span>
    <span class="k">if</span> <span class="n">log_scale</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;There are negative values in this data, disabling the log scale.&quot;</span>
        <span class="p">)</span>
        <span class="n">log_scale</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Apply log1p transformation if log_scale is True</span>
    <span class="k">if</span> <span class="n">log_scale</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>

    <span class="c1"># Create the plot</span>
    <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="c1"># Plotting logic based on provided annotations</span>
    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">and</span> <span class="n">second_annotation</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v_orient</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>
                        <span class="n">hue</span><span class="o">=</span><span class="n">second_annotation</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">hue</span><span class="o">=</span><span class="n">second_annotation</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">title_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Nested Grouping by </span><span class="si">{</span><span class="n">annotation</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">second_annotation</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title_str</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Reshape the dataframe to long format for visualization</span>
            <span class="n">melted_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="n">annotation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v_orient</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">melted_data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;variable&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>
                            <span class="n">hue</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>  <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">melted_data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;variable&quot;</span><span class="p">,</span>
                            <span class="n">hue</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>  <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple Features Grouped by </span><span class="si">{</span><span class="n">annotation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v_orient</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>
                            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>
                            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grouped by </span><span class="si">{</span><span class="n">annotation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v_orient</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">melted_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">melf</span><span class="p">()</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">melted_data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;variable&quot;</span><span class="p">,</span>
                            <span class="n">hue</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>  <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Multiple Features&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v_orient</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Set a single tick for the single feature</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>  <span class="c1"># Set the label for the tick</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Set a single tick for the single feature</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>  <span class="c1"># Set the label for the tick</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Single Boxplot&quot;</span><span class="p">)</span>

    <span class="c1"># Set x and y-axis labels</span>
    <span class="k">if</span> <span class="n">v_orient</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="n">annotation</span> <span class="k">if</span> <span class="n">annotation</span> <span class="k">else</span> <span class="s1">&#39;Feature&#39;</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;log(Intensity)&#39;</span> <span class="k">if</span> <span class="n">log_scale</span> <span class="k">else</span> <span class="s1">&#39;Intensity&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;log(Intensity)&#39;</span> <span class="k">if</span> <span class="n">log_scale</span> <span class="k">else</span> <span class="s1">&#39;Intensity&#39;</span>
        <span class="n">ylabel</span> <span class="o">=</span> <span class="n">annotation</span> <span class="k">if</span> <span class="n">annotation</span> <span class="k">else</span> <span class="s1">&#39;Feature&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">df</span></div>


<div class="viewcode-block" id="boxplot_interactive"><a class="viewcode-back" href="../../spac.html#spac.visualization.boxplot_interactive">[docs]</a><span class="k">def</span> <span class="nf">boxplot_interactive</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">annotation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">showfliers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">log_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span>
    <span class="n">figure_width</span><span class="o">=</span><span class="mf">3.2</span><span class="p">,</span>
    <span class="n">figure_height</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">figure_dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">defined_color_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">annotation_colorscale</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>
    <span class="n">feature_colorscale</span><span class="o">=</span><span class="s2">&quot;seismic&quot;</span><span class="p">,</span>
    <span class="n">figure_type</span><span class="o">=</span><span class="s2">&quot;interactive&quot;</span><span class="p">,</span>
    <span class="n">return_metrics</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a boxplot for given features from an AnnData object.</span>

<span class="sd">    This function visualizes the distribution of gene expression</span>
<span class="sd">    (or other features) across different annotations in the provided data.</span>
<span class="sd">    It can handle various options such as log-transformation, feature</span>
<span class="sd">    selection, and handling of outliers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        An AnnData object containing the data to plot. The expression matrix</span>
<span class="sd">        is accessed via `adata.X` or `adata.layers[layer]`, and annotations</span>
<span class="sd">        are taken from `adata.obs`.</span>

<span class="sd">    annotation : str, optional</span>
<span class="sd">        The name of the annotation column (e.g., cell type or sample</span>
<span class="sd">        condition) from `adata.obs` used to group the features. If `None`, no</span>
<span class="sd">        grouping is applied.</span>

<span class="sd">    layer : str, optional</span>
<span class="sd">        The name of the layer from `adata.layers` to use. If `None`, `adata.X`</span>
<span class="sd">        is used.</span>

<span class="sd">    ax : plotly.graph_objects.Figure, optional</span>
<span class="sd">        The figure to plot the boxplot onto. If `None`, a new figure is</span>
<span class="sd">        created.</span>

<span class="sd">    features : list of str, optional</span>
<span class="sd">        The list of features (genes) to plot. If `None`, all features are</span>
<span class="sd">        included.</span>

<span class="sd">    showfliers : {None, &quot;downsample&quot;, &quot;all&quot;}, default = None</span>
<span class="sd">        If &#39;all&#39;, all outliers are displayed in the boxplot.</span>
<span class="sd">        If &#39;downsample&#39;, when num outliers is &gt;10k, they are downsampled to</span>
<span class="sd">        10% of the original count.</span>
<span class="sd">        If None, outliers are hidden.</span>

<span class="sd">    log_scale : bool, default=False</span>
<span class="sd">        If True, the log1p transformation is applied to the features before</span>
<span class="sd">        plotting. This option is disabled if negative values are found in the</span>
<span class="sd">        features.</span>

<span class="sd">    orient : {&quot;v&quot;, &quot;h&quot;}, default=&quot;v&quot;</span>
<span class="sd">        The orientation of the boxplots: &quot;v&quot; for vertical, &quot;h&quot; for horizontal.</span>

<span class="sd">    figure_width : int, optional</span>
<span class="sd">        Width of the figure in inches. Default is 3.2.</span>

<span class="sd">    figure_height : int, optional</span>
<span class="sd">        Height of the figure in inches. Default is 2.</span>

<span class="sd">    figure_dpi : int, optional</span>
<span class="sd">        DPI (dots per inch) for the figure. Default is 200.</span>

<span class="sd">    defined_color_map : str, optional</span>
<span class="sd">        Key in &#39;adata.uns&#39; holding a pre-computed color dictionary.</span>
<span class="sd">        Falls back to automatic generation from &#39;annotation&#39; values.</span>
<span class="sd">    ax : matplotlib.axes.Axes, optional</span>
<span class="sd">        A Matplotlib Axes object. Currently, this parameter is not used by the</span>
<span class="sd">        underlying plotting functions (Seaborn&#39;s `catplot`/`displot`), which</span>
<span class="sd">        will always generate a new figure and axes. The `ax` key in the</span>
<span class="sd">        returned dictionary will contain the Axes from these new plots.</span>
<span class="sd">        This parameter is maintained for API consistency and potential</span>
<span class="sd">        future enhancements. Default is None.</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Additional arguments for seaborn figure-level functions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A dictionary containing the following keys:</span>
<span class="sd">        fig : plotly.graph_objects.Figure or str</span>
<span class="sd">            The generated boxplot figure, which can be either:</span>
<span class="sd">                - If `figure_type` is &quot;static&quot;: A base64-encoded PNG</span>
<span class="sd">                image string</span>
<span class="sd">                - If `figure_type` is &quot;interactive&quot;: A Plotly figure object</span>

<span class="sd">        df : pd.DataFrame</span>
<span class="sd">            A DataFrame containing the features and their corresponding values.</span>

<span class="sd">        metrics : pd.DataFrame</span>
<span class="sd">            A DataFrame containing the computed boxplot metrics (if</span>
<span class="sd">            `return_metrics` is True).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">boxplot_from_statistics</span><span class="p">(</span>
        <span class="n">summary_stats</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cmap</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">annotation</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">showfliers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">log_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span>
        <span class="n">figure_width</span><span class="o">=</span><span class="n">figure_width</span><span class="p">,</span>
        <span class="n">figure_height</span><span class="o">=</span><span class="n">figure_height</span><span class="p">,</span>
        <span class="n">figure_dpi</span><span class="o">=</span><span class="n">figure_dpi</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a boxplot from the provided summary statistics DataFrame.</span>

<span class="sd">        This function visualizes a set of summary statistics (e.g., quartiles,</span>
<span class="sd">        mean) as a boxplot. It supports grouping the data by a given</span>
<span class="sd">        annotation and allows customization of orientation, displaying</span>
<span class="sd">        outliers, and interactive plotting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        summary_stats : pd.DataFrame</span>
<span class="sd">            A DataFrame containing the summary statistics of the features to</span>
<span class="sd">            plot. It should include columns like &#39;marker&#39;, &#39;q1&#39;, &#39;med&#39;, &#39;q3&#39;,</span>
<span class="sd">            &#39;whislo&#39;, &#39;whishi&#39;, and &#39;mean&#39;. Optionally, it may also contain an</span>
<span class="sd">            annotation column used for grouping.</span>

<span class="sd">        cmap : dict</span>
<span class="sd">            A dictionary mapping annotation/feature values to color strings</span>
<span class="sd">            (hex, rgb/rgba, hsl/hsla, hsv/hsva, or CSS).</span>

<span class="sd">        annotation : str, optional</span>
<span class="sd">            The column name in `summary_stats` used to group the data by</span>
<span class="sd">            specific categories (e.g., cell type, condition). If `None`, no</span>
<span class="sd">            grouping is applied.</span>

<span class="sd">        ax : matplotlib.axes.Axes or plotly.graph_objects.Figure, optional</span>
<span class="sd">            A figure or axes to plot onto. If None, a new Plotly figure is</span>
<span class="sd">            created.</span>

<span class="sd">        showfliers : {None, &quot;downsample&quot;, &quot;all&quot;}, default = None</span>
<span class="sd">            If &#39;all&#39;, all outliers are displayed in the boxplot.</span>
<span class="sd">            If &#39;downsample&#39;, when num outliers is &gt;10k, they are downsampled</span>
<span class="sd">            to 10% of the original count.</span>
<span class="sd">            If None, outliers are hidden.</span>

<span class="sd">        log_scale : bool, optional, default=False</span>
<span class="sd">            If True, the log1p transformation is applied to the features</span>
<span class="sd">            before plotting. This option is disabled if negative values are</span>
<span class="sd">            found in the features.</span>

<span class="sd">        orient : {&quot;v&quot;, &quot;h&quot;}, default=&quot;v&quot;</span>
<span class="sd">            The orientation of the boxplot: &#39;v&#39; for vertical and &#39;h&#39; for</span>
<span class="sd">            horizontal.</span>

<span class="sd">        figure_width : int, optional</span>
<span class="sd">            Width of the figure in inches. Default is 3.2.</span>

<span class="sd">        figure_height : int, optional</span>
<span class="sd">            Height of the figure in inches. Default is 2.</span>

<span class="sd">        figure_dpi : int, optional</span>
<span class="sd">            DPI (dots per inch) for the figure. Default is 200.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig : plotly.graph_objects.Figure</span>
<span class="sd">            The Plotly figure containing the generated boxplot.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - The function uses the `plotly` library for visualization, allowing</span>
<span class="sd">        interactive plotting.</span>
<span class="sd">        - If grouping by an annotation, each group will be assigned a unique</span>
<span class="sd">        color from a predefined colormap.</span>
<span class="sd">        - The boxplot will display whiskers, quartiles, and the mean. Outliers</span>
<span class="sd">        are controlled by the `showfliers` parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize the figure: if &#39;ax&#39; is provided, use it, otherwise create</span>
        <span class="c1"># a new Plotly figure</span>
        <span class="k">if</span> <span class="n">ax</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

        <span class="c1"># Get unique features (markers) from the summary statistics</span>
        <span class="n">unique_features</span> <span class="o">=</span> <span class="n">summary_stats</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="c1"># Create comma seperated list for features in the plot title</span>
        <span class="c1"># If there are &gt;3 unique features, use &#39;Multiple Features&#39; in the title</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_features</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_features</span><span class="p">[</span><span class="mi">0</span><span class="p">:])</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_title</span> <span class="o">=</span> <span class="s1">&#39;Multiple Features&#39;</span>

        <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
            <span class="n">unique_annotations</span> <span class="o">=</span> <span class="n">summary_stats</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

            <span class="n">plot_title</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; grouped by </span><span class="si">{</span><span class="n">annotation</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Empty outlier lists cause issues with plotly,</span>
        <span class="c1"># so replace them with [None]</span>
        <span class="k">if</span> <span class="n">showfliers</span><span class="p">:</span>
            <span class="n">summary_stats</span><span class="p">[</span><span class="s2">&quot;fliers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_stats</span><span class="p">[</span><span class="s2">&quot;fliers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>

        <span class="c1"># Set up the orientation of the plot data &amp; axis-labels</span>
        <span class="k">if</span> <span class="n">orient</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
            <span class="n">x_data</span> <span class="o">=</span> <span class="s2">&quot;fliers&quot;</span>
            <span class="n">y_data</span> <span class="o">=</span> <span class="s2">&quot;marker&quot;</span>
            <span class="n">x_axis_label</span> <span class="o">=</span> <span class="s2">&quot;log(Intensity)&quot;</span> <span class="k">if</span> <span class="n">log_scale</span> <span class="k">else</span> <span class="s2">&quot;Intensity&quot;</span>
            <span class="n">y_axis_label</span> <span class="o">=</span> <span class="n">annotation</span> <span class="k">if</span> <span class="n">annotation</span> <span class="k">else</span> <span class="s2">&quot;feature value&quot;</span>
        <span class="k">elif</span> <span class="n">orient</span> <span class="o">==</span> <span class="s2">&quot;v&quot;</span><span class="p">:</span>
            <span class="n">x_data</span> <span class="o">=</span> <span class="s2">&quot;marker&quot;</span>
            <span class="n">y_data</span> <span class="o">=</span> <span class="s2">&quot;fliers&quot;</span>
            <span class="n">x_axis_label</span> <span class="o">=</span> <span class="n">annotation</span> <span class="k">if</span> <span class="n">annotation</span> <span class="k">else</span> <span class="s2">&quot;feature value&quot;</span>
            <span class="n">y_axis_label</span> <span class="o">=</span> <span class="s2">&quot;log(Intensity)&quot;</span> <span class="k">if</span> <span class="n">log_scale</span> <span class="k">else</span> <span class="s2">&quot;Intensity&quot;</span>

        <span class="c1"># If annotation is provided, group the data</span>
        <span class="c1"># and create boxplots for each group</span>
        <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
            <span class="n">grouped_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">annotation_value</span> <span class="ow">in</span> <span class="n">summary_stats</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="c1"># Transform the summary statistics to a dictionary</span>
                <span class="c1"># for each annotation value</span>
                <span class="n">grouped_data</span><span class="p">[</span><span class="n">annotation_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary_stats</span><span class="p">[</span>
                    <span class="n">summary_stats</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span> <span class="o">==</span> <span class="n">annotation_value</span>
                <span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">)</span>

            <span class="c1"># Add a boxplot trace for each annotation value</span>
            <span class="k">for</span> <span class="n">annotation_value</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">grouped_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">orient</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">y_data</span><span class="p">]</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x_data</span><span class="p">]</span> <span class="k">if</span> <span class="n">showfliers</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">y_data</span><span class="p">]</span> <span class="k">if</span> <span class="n">showfliers</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x_data</span><span class="p">]</span>

                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">annotation_value</span><span class="p">,</span>
                        <span class="n">q1</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;q1&quot;</span><span class="p">],</span>
                        <span class="n">median</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;med&quot;</span><span class="p">],</span>
                        <span class="n">q3</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;q3&quot;</span><span class="p">],</span>
                        <span class="n">lowerfence</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;whislo&quot;</span><span class="p">],</span>
                        <span class="n">upperfence</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;whishi&quot;</span><span class="p">],</span>
                        <span class="n">mean</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">boxpoints</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                        <span class="n">jitter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">pointpos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">annotation_value</span><span class="p">]</span>
                        <span class="p">),</span>  <span class="c1"># Assign color based on annotation</span>
                        <span class="n">legendgroup</span><span class="o">=</span><span class="n">annotation_value</span><span class="p">,</span>
                        <span class="n">showlegend</span><span class="o">=</span><span class="n">annotation_value</span>
                        <span class="ow">in</span> <span class="n">unique_annotations</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># used to only show legend once per annotation group</span>
                <span class="n">unique_annotations</span> <span class="o">=</span> <span class="n">unique_annotations</span><span class="p">[</span>
                    <span class="n">unique_annotations</span> <span class="o">!=</span> <span class="n">annotation_value</span>
                <span class="p">]</span>

            <span class="c1"># Adjust layout to group the boxplots by annotation</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">boxmode</span><span class="o">=</span><span class="s2">&quot;group&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If no annotation, create a boxplot</span>
            <span class="c1"># for each unique feature (marker)</span>
            <span class="n">stats_dict</span> <span class="o">=</span> <span class="n">summary_stats</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;list&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">marker_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stats_dict</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">orient</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats_dict</span><span class="p">[</span><span class="n">y_data</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats_dict</span><span class="p">[</span><span class="n">x_data</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">]]</span> <span class="k">if</span> <span class="n">showfliers</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats_dict</span><span class="p">[</span><span class="n">y_data</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">]]</span> <span class="k">if</span> <span class="n">showfliers</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats_dict</span><span class="p">[</span><span class="n">x_data</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>

                <span class="c1"># Note: adding None to the x or y data to ensure</span>
                <span class="c1"># the outliers are displayed correctly</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">marker_value</span><span class="p">,</span>
                        <span class="n">q1</span><span class="o">=</span><span class="p">[</span><span class="n">stats_dict</span><span class="p">[</span><span class="s2">&quot;q1&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
                        <span class="n">median</span><span class="o">=</span><span class="p">[</span><span class="n">stats_dict</span><span class="p">[</span><span class="s2">&quot;med&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
                        <span class="n">q3</span><span class="o">=</span><span class="p">[</span><span class="n">stats_dict</span><span class="p">[</span><span class="s2">&quot;q3&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
                        <span class="n">lowerfence</span><span class="o">=</span><span class="p">[</span><span class="n">stats_dict</span><span class="p">[</span><span class="s2">&quot;whislo&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
                        <span class="n">upperfence</span><span class="o">=</span><span class="p">[</span><span class="n">stats_dict</span><span class="p">[</span><span class="s2">&quot;whishi&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
                        <span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="n">stats_dict</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">boxpoints</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                        <span class="n">jitter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">pointpos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">[</span><span class="n">marker_value</span><span class="p">]</span>
                        <span class="p">),</span>
                        <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="c1"># Final layout adjustments for the plot title, axis labels, and size</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">plot_title</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="n">y_axis_label</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="n">x_axis_label</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">figure_height</span> <span class="o">*</span> <span class="n">figure_dpi</span><span class="p">),</span>
            <span class="n">width</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">figure_width</span> <span class="o">*</span> <span class="n">figure_dpi</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="c1">#####################</span>
    <span class="c1">#  Main Code Block  #</span>
    <span class="c1">#####################</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculating Box Plot...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
        <span class="n">check_table</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">layer</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">check_annotation</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">annotation</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">check_feature</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input &#39;ax&#39; must be a plotly.Figure object.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">showfliers</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;downsample&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;showfliers must be one of &#39;all&#39;, &#39;downsample&#39;, or None.&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Got </span><span class="si">{</span><span class="n">showfliers</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">figure_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;interactive&quot;</span><span class="p">,</span> <span class="s2">&quot;static&quot;</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;figure_type must be one of &#39;interactive&#39;, &#39;static&#39;, or &#39;png&#39;.&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Got </span><span class="si">{</span><span class="n">figure_type</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># Extract data from the specified layer or the default matrix (adata.X)</span>
    <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
        <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span>

    <span class="c1"># Convert the data matrix into a DataFrame with</span>
    <span class="c1"># appropriate column names (features)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_matrix</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>

    <span class="c1"># Add annotation column to the DataFrame if provided</span>
    <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># If no specific features are provided, use all available features</span>
    <span class="k">if</span> <span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">features</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># Filter the DataFrame to include only the</span>
    <span class="c1"># selected features and the annotation</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">features</span> <span class="o">+</span> <span class="p">([</span><span class="n">annotation</span><span class="p">]</span> <span class="k">if</span> <span class="n">annotation</span> <span class="k">else</span> <span class="p">[])]</span>

    <span class="c1"># Check for negative values if log scale is requested</span>
    <span class="k">if</span> <span class="n">log_scale</span> <span class="ow">and</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;There are negative values in this data, disabling the log scale.&quot;</span>
        <span class="p">)</span>
        <span class="n">log_scale</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Apply log1p transformation if log_scale is True</span>
    <span class="k">if</span> <span class="n">log_scale</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">features</span><span class="p">])</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># Compute the summary statistics required for the boxplot</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">compute_boxplot_metrics</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span> <span class="n">showfliers</span><span class="o">=</span><span class="n">showfliers</span>
    <span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Time taken to compute boxplot metrics: </span><span class="si">%f</span><span class="s2"> seconds&quot;</span><span class="p">,</span>
        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="p">)</span>

    <span class="c1"># Get the colormap for the annotation</span>
    <span class="k">if</span> <span class="n">defined_color_map</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">get_defined_color_map</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">get_defined_color_map</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="n">annotation_colorscale</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Create a color mapping for the features</span>
        <span class="n">unique_features</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;marker&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">color_mapping</span><span class="p">(</span>
            <span class="n">unique_features</span><span class="p">,</span>
            <span class="n">color_map</span><span class="o">=</span><span class="n">feature_colorscale</span><span class="p">,</span>
            <span class="n">return_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># Generate the boxplot figure from the summary statistics</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">boxplot_from_statistics</span><span class="p">(</span>
        <span class="n">summary_stats</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
        <span class="n">annotation</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>
        <span class="n">showfliers</span><span class="o">=</span><span class="n">showfliers</span><span class="p">,</span>
        <span class="n">log_scale</span><span class="o">=</span><span class="n">log_scale</span><span class="p">,</span>
        <span class="n">orient</span><span class="o">=</span><span class="n">orient</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
        <span class="n">figure_width</span><span class="o">=</span><span class="n">figure_width</span><span class="p">,</span>
        <span class="n">figure_height</span><span class="o">=</span><span class="n">figure_height</span><span class="p">,</span>
        <span class="n">figure_dpi</span><span class="o">=</span><span class="n">figure_dpi</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Prepare the base image or figure return value</span>
    <span class="k">if</span> <span class="n">figure_type</span> <span class="o">==</span> <span class="s2">&quot;interactive&quot;</span><span class="p">:</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="n">fig</span>
    <span class="k">elif</span> <span class="n">figure_type</span> <span class="o">==</span> <span class="s2">&quot;png&quot;</span><span class="p">:</span>
        <span class="c1"># Convert Plotly to PNG encoded to base64</span>
        <span class="n">img_bytes</span> <span class="o">=</span> <span class="n">pio</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">)</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">img_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">figure_type</span> <span class="o">==</span> <span class="s2">&quot;static&quot;</span><span class="p">:</span>
        <span class="c1"># Disable interactive components</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;dragmode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;hovermode&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;clickmode&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="s1">&#39;modebar_remove&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s1">&#39;toimage&#39;</span><span class="p">,</span>
                <span class="s1">&#39;zoom&#39;</span><span class="p">,</span>
                <span class="s1">&#39;zoomin&#39;</span><span class="p">,</span>
                <span class="s1">&#39;zoomout&#39;</span><span class="p">,</span>
                <span class="s1">&#39;select&#39;</span><span class="p">,</span>
                <span class="s1">&#39;pan&#39;</span><span class="p">,</span>
                <span class="s1">&#39;lasso&#39;</span><span class="p">,</span>
                <span class="s1">&#39;autoscale&#39;</span><span class="p">,</span>
                <span class="s1">&#39;resetscale&#39;</span>
            <span class="p">],</span>
            <span class="s1">&#39;legend_itemclick&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;legend_itemdoubleclick&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Time taken to generate boxplot: </span><span class="si">%f</span><span class="s2"> seconds&quot;</span><span class="p">,</span>
        <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fig&quot;</span><span class="p">:</span> <span class="n">plot</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">}</span>
     <span class="c1"># Determine if metrics included based on return_metrics flag</span>
    <span class="k">if</span> <span class="n">return_metrics</span><span class="p">:</span>
       <span class="n">result</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span>

    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="interactive_spatial_plot"><a class="viewcode-back" href="../../spac.html#spac.visualization.interactive_spatial_plot">[docs]</a><span class="k">def</span> <span class="nf">interactive_spatial_plot</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dot_size</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
    <span class="n">dot_transparency</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
    <span class="n">annotation_colorscale</span><span class="o">=</span><span class="s1">&#39;rainbow&#39;</span><span class="p">,</span>
    <span class="n">feature_colorscale</span><span class="o">=</span><span class="s1">&#39;balance&#39;</span><span class="p">,</span>
    <span class="n">figure_width</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="n">figure_height</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">figure_dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">font_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">stratify_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">defined_color_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">reverse_y_axis</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an interactive scatter plot for</span>
<span class="sd">    spatial data using provided annotations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        Annotated data matrix object,</span>
<span class="sd">        must have a .obsm attribute with &#39;spatial&#39; key.</span>
<span class="sd">    annotations : list of str or str, optional</span>
<span class="sd">        Column(s) in `adata.obs` that contain the annotations to plot.</span>
<span class="sd">        If a single string is provided, it will be converted to a list.</span>
<span class="sd">        The interactive plot will show all the labels in the annotation</span>
<span class="sd">        columns passed.</span>
<span class="sd">    feature : str, optional</span>
<span class="sd">        If annotation is None, the name of the gene or feature</span>
<span class="sd">        in `adata.var_names` to use for coloring the scatter plot points</span>
<span class="sd">        based on feature expression.</span>
<span class="sd">    layer : str, optional</span>
<span class="sd">        If feature is not None, the name of the data layer in `adata.layers`</span>
<span class="sd">        to use for visualization. If None, the main data matrix `adata.X` is</span>
<span class="sd">        used.</span>
<span class="sd">    dot_size : float, optional</span>
<span class="sd">        Size of the scatter dots in the plot. Default is 1.5.</span>
<span class="sd">    dot_transparency : float, optional</span>
<span class="sd">        Transparancy level of the scatter dots. Default is 0.75.</span>
<span class="sd">    annotation_colorscale : str, optional</span>
<span class="sd">        Name of the color scale to use for the dots when annotation</span>
<span class="sd">        is used. Default is &#39;Viridis&#39;.</span>
<span class="sd">    feature_colorscale: srt, optional</span>
<span class="sd">        Name of the color scale to use for the dots when feature</span>
<span class="sd">        is used. Default is &#39;seismic&#39;.</span>
<span class="sd">    figure_width : int, optional</span>
<span class="sd">        Width of the figure in inches. Default is 12.</span>
<span class="sd">    figure_height : int, optional</span>
<span class="sd">        Height of the figure in inches. Default is 8.</span>
<span class="sd">    figure_dpi : int, optional</span>
<span class="sd">        DPI (dots per inch) for the figure. Default is 200.</span>
<span class="sd">    font_size : int, optional</span>
<span class="sd">        Font size for text in the plot. Default is 12.</span>
<span class="sd">    stratify_by : str, optional</span>
<span class="sd">        Column in `adata.obs` to stratify the plot. Default is None.</span>
<span class="sd">    defined_color_map : str, optional</span>
<span class="sd">        Predefined color mapping stored in adata.uns for specific labels.</span>
<span class="sd">        Default is None, which will generate the color mapping automatically.</span>
<span class="sd">    reverse_y_axis : bool, optional</span>
<span class="sd">        If True, reverse the Y-axis of the plot. Default is False.</span>
<span class="sd">    cmin : float, optional</span>
<span class="sd">        Minimum value for the color scale when using features.</span>
<span class="sd">        Default is None.</span>
<span class="sd">    cmax : float, optional</span>
<span class="sd">        Maximum value for the color scale when using features.</span>
<span class="sd">        Default is None.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional keyword arguments for customization.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of dict</span>
<span class="sd">        A list of dictionaries, each containing the following keys:</span>
<span class="sd">        - &quot;image_name&quot;: str, the name of the generated image.</span>
<span class="sd">        - &quot;image_object&quot;: Plotly Figure object.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function is tailored for spatial single-cell data and expects the</span>
<span class="sd">    AnnData object to have spatial coordinates in its `.obsm` attribute under</span>
<span class="sd">    the &#39;spatial&#39; key.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">feature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;At least one of the &#39;annotations&#39; or &#39;feature&#39; parameters &quot;</span> <span class="o">+</span> \
            <span class="s2">&quot;must be provided.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotations</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="p">[</span><span class="n">annotations</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
            <span class="n">check_annotation</span><span class="p">(</span>
                <span class="n">adata</span><span class="p">,</span>
                <span class="n">annotations</span><span class="o">=</span><span class="n">annotation</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">check_feature</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span>
            <span class="n">features</span><span class="o">=</span><span class="n">feature</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">check_table</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span>
            <span class="n">tables</span><span class="o">=</span><span class="n">layer</span>
        <span class="p">)</span>

    <span class="n">check_table</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">,</span>
        <span class="n">tables</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span>
        <span class="n">associated_table</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare_spatial_dataframe</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">layer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare a DataFrame for spatial plotting from an AnnData object.</span>

<span class="sd">        If &#39;annotations&#39; is provided (a string or list of strings), the</span>
<span class="sd">        returned DataFrame will contain the X,Y coordinates and one column</span>
<span class="sd">        per annotation.</span>
<span class="sd">        If &#39;feature&#39; is provided (and annotations is None), a single &#39;color&#39;</span>
<span class="sd">        column is created from adata.layers[layer] (if provided) or adata.X.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        adata : anndata.AnnData</span>
<span class="sd">            AnnData object with spatial coordinates in adata.obsm[&#39;spatial&#39;].</span>
<span class="sd">        annotations : str or list of str, optional</span>
<span class="sd">            Annotation column(s) in adata.obs to include.</span>
<span class="sd">        feature : str, optional</span>
<span class="sd">            Continuous feature name in adata.var_names for coloring.</span>
<span class="sd">        layer : str, optional</span>
<span class="sd">            Layer to use for feature values if feature is provided.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            DataFrame with columns &#39;X&#39;, &#39;Y&#39; and each annotation column (or a</span>
<span class="sd">            &#39;color&#39; column for continuous feature).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If neither annotations nor feature is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spatial</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">]</span>
        <span class="n">xcoord</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">spatial</span><span class="p">]</span>
        <span class="n">ycoord</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">spatial</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">xcoord</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span> <span class="n">ycoord</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">annotations</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">annotations</span> <span class="o">=</span> <span class="p">[</span><span class="n">annotations</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ann</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">ann</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">ann</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">elif</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_source</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="k">if</span> <span class="n">layer</span> <span class="k">else</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span>
            <span class="n">color_values</span> <span class="o">=</span> <span class="n">data_source</span><span class="p">[:,</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span> <span class="o">==</span> <span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_values</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Either &#39;annotations&#39; or &#39;feature&#39; must be provided.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">main_figure_generation</span><span class="p">(</span>
        <span class="n">spatial_df</span><span class="p">,</span>
        <span class="n">annotations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">feature</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dot_size</span><span class="o">=</span><span class="n">dot_size</span><span class="p">,</span>
        <span class="n">dot_transparency</span><span class="o">=</span><span class="n">dot_transparency</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">color_mapping</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">figure_width</span><span class="o">=</span><span class="n">figure_width</span><span class="p">,</span>
        <span class="n">figure_height</span><span class="o">=</span><span class="n">figure_height</span><span class="p">,</span>
        <span class="n">figure_dpi</span><span class="o">=</span><span class="n">figure_dpi</span><span class="p">,</span>
        <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;interactive_spatial_plot&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the core interactive plot for downstream processing.</span>
<span class="sd">        This function generates the main interactive plot using Plotly</span>
<span class="sd">        that contains the spatial scatter plot with annotations and</span>
<span class="sd">        image configuration.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spatial_df : pandas.DataFrame</span>
<span class="sd">            Annotated dataframe</span>
<span class="sd">        annotations : Union[list[str], str], optional</span>
<span class="sd">            Column(s) in `spatial_df` that contain the annotations to plot.</span>
<span class="sd">            The interactive plot will show all the labels in the annotation</span>
<span class="sd">            columns passed as unique traces.</span>
<span class="sd">        feature : str, optional</span>
<span class="sd">            The column name in `spatial_df` for the continuous color mapping</span>
<span class="sd">        dot_size : float, optional</span>
<span class="sd">            Size of the scatter dots in the plot. Default is 1.5.</span>
<span class="sd">        dot_transparency : float, optional</span>
<span class="sd">            Transparency level of the scatter dots. Default is 0.75.</span>
<span class="sd">        colorscale : Optional[str], optional</span>
<span class="sd">            Name of the color scale to use for the dots if features is passed.</span>
<span class="sd">        color_mapping : Optional[dict], optional</span>
<span class="sd">            A dictionary mapping annotation labels to colors for annotations.</span>
<span class="sd">        figure_width : int, optional</span>
<span class="sd">            Width of the figure in inches. Default is 12.</span>
<span class="sd">        figure_height : int, optional</span>
<span class="sd">            Height of the figure in inches. Default is 8.</span>
<span class="sd">        figure_dpi : int, optional</span>
<span class="sd">            DPI (dots per inch) for the figure. Default is 200.</span>
<span class="sd">        font_size : int, optional</span>
<span class="sd">            Font size for text in the plot. Default is 12.</span>
<span class="sd">        title : str, optional</span>
<span class="sd">            Title of the image. Default is &quot;interactive_spatial_plot&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plotly.graph_objs._figure.Figure</span>
<span class="sd">            The generated interactive Plotly figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xcoord</span> <span class="o">=</span> <span class="n">spatial_df</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
        <span class="n">ycoord</span> <span class="o">=</span> <span class="n">spatial_df</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>

        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xcoord</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">xcoord</span><span class="p">)</span>
        <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ycoord</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ycoord</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span>

        <span class="n">dy</span> <span class="o">=</span> <span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span>

        <span class="n">min_x_range</span> <span class="o">=</span> <span class="n">min_x</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">dx</span>
        <span class="n">max_x_range</span> <span class="o">=</span> <span class="n">max_x</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">dx</span>
        <span class="n">min_y_range</span> <span class="o">=</span> <span class="n">min_y</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">dy</span>
        <span class="n">max_y_range</span> <span class="o">=</span> <span class="n">max_y</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">dy</span>

        <span class="n">width_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">figure_width</span> <span class="o">*</span> <span class="n">figure_dpi</span><span class="p">)</span>
        <span class="n">height_px</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">figure_height</span> <span class="o">*</span> <span class="n">figure_dpi</span><span class="p">)</span>

        <span class="c1"># Define partial for scatter traces with common parameters</span>
        <span class="n">scatter_partial</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span>
            <span class="n">render_mode</span><span class="o">=</span><span class="s2">&quot;webgl&quot;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># Helper function to create a scatter trace for features</span>
        <span class="c1"># as it needs a continuous color scale.</span>
        <span class="c1"># in my experience, px.scatter does not work well with</span>
        <span class="c1"># continuous color scales color_continuous_scale,</span>
        <span class="c1"># so I use go.Scattergl instead.</span>
        <span class="k">def</span> <span class="nf">create_scatter_trace</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">colorscale</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">colorscale</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span>
                    <span class="n">colorscale</span><span class="o">=</span><span class="n">colorscale</span><span class="p">,</span>
                    <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">feature</span><span class="p">),</span>
                    <span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">cmin</span><span class="o">=</span><span class="n">cmin</span><span class="p">,</span>
                    <span class="n">cmax</span><span class="o">=</span><span class="n">cmax</span>
                <span class="p">),</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;x+y+text&quot;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

        <span class="c1"># The annotation trace creates a dummy point</span>
        <span class="c1"># so that the label of that annotion is shown in the legend</span>
        <span class="k">def</span> <span class="nf">create_annotation_trace</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>

            <span class="c1"># add one extra point just close to the first point</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">filtered</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">filtered</span><span class="p">[</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.1</span><span class="p">],</span>
                <span class="n">render_mode</span><span class="o">=</span><span class="s2">&quot;webgl&quot;</span>
            <span class="p">)</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                    <span class="n">colorscale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">opacity</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;b&gt;</span><span class="si">{</span><span class="n">obs</span><span class="si">}</span><span class="s1">&lt;/b&gt;&#39;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">trace</span>

        <span class="n">main_fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Loop over all annotation and add annotation dummy point</span>
            <span class="c1"># and data points to the figure</span>
            <span class="k">for</span> <span class="n">obs</span> <span class="ow">in</span> <span class="n">annotations</span><span class="p">:</span>

                <span class="n">spatial_df</span><span class="p">[</span><span class="n">obs</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;no_label&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">filtered</span> <span class="o">=</span> <span class="n">spatial_df</span>
                <span class="c1"># Create and add annotation trace using the helper function</span>
                <span class="n">main_fig</span><span class="o">.</span><span class="n">add_traces</span><span class="p">(</span>
                    <span class="n">create_annotation_trace</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="c1"># Create and add the scatter trace for the annotation</span>
                <span class="n">main_fig</span><span class="o">.</span><span class="n">add_traces</span><span class="p">(</span>
                    <span class="n">scatter_partial</span><span class="p">(</span>
                        <span class="n">filtered</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">obs</span><span class="p">,</span>
                        <span class="n">hover_data</span><span class="o">=</span><span class="p">[</span><span class="n">obs</span><span class="p">],</span>
                        <span class="n">color_discrete_map</span><span class="o">=</span><span class="n">color_mapping</span><span class="p">,</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="n">main_fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">create_scatter_trace</span><span class="p">(</span><span class="n">spatial_df</span><span class="p">,</span> <span class="n">feature</span><span class="p">,</span> <span class="n">colorscale</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No plot is generated.&quot;</span>
                <span class="s2">&quot; Either &#39;annotations&#39; or &#39;feature&#39; must be provided.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Set the hover template to show x, y and annotation</span>
            <span class="c1"># This is needed to show the correct label when</span>
            <span class="c1"># multiple annotations are present</span>
            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="s2">&quot;%</span><span class="si">{customdata[0]}</span><span class="s2">&lt;extra&gt;&lt;/extra&gt;&quot;</span>
        <span class="k">elif</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># it is already set in the create_scatter_trace function</span>
            <span class="n">hovertemplate</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">main_fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">size</span><span class="o">=</span><span class="n">dot_size</span><span class="p">,</span>
                <span class="n">opacity</span><span class="o">=</span><span class="n">dot_transparency</span>
            <span class="p">),</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hovertemplate</span>
        <span class="p">)</span>

        <span class="n">main_fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="n">width_px</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">height_px</span><span class="p">,</span>
            <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">font_size</span><span class="p">),</span>
            <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">,</span>
                <span class="n">yanchor</span><span class="o">=</span><span class="s1">&#39;middle&#39;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">xanchor</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">itemwidth</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0, 0, 0, 0)&quot;</span><span class="p">,</span>
                <span class="n">traceorder</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span>
                <span class="n">entrywidth</span><span class="o">=</span><span class="mi">50</span>
            <span class="p">),</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">min_x_range</span><span class="p">,</span> <span class="n">max_x_range</span><span class="p">],</span>
                        <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="c1"># showticklabels=False,</span>
                        <span class="n">title_standoff</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">constrain</span><span class="o">=</span><span class="s2">&quot;domain&quot;</span>
                    <span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">min_y_range</span><span class="p">,</span> <span class="n">max_y_range</span><span class="p">],</span>
                        <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">scaleanchor</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                        <span class="n">scaleratio</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="c1"># showticklabels=False,</span>
                        <span class="n">title_standoff</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">constrain</span><span class="o">=</span><span class="s2">&quot;domain&quot;</span>
                    <span class="p">),</span>
            <span class="n">shapes</span><span class="o">=</span><span class="p">[</span>
                <span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Shape</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;rect&quot;</span><span class="p">,</span>
                    <span class="n">xref</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                    <span class="n">yref</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                    <span class="n">x0</span><span class="o">=</span><span class="n">min_x_range</span><span class="p">,</span>
                    <span class="n">y0</span><span class="o">=</span><span class="n">min_y_range</span><span class="p">,</span>
                    <span class="n">x1</span><span class="o">=</span><span class="n">max_x_range</span><span class="p">,</span>
                    <span class="n">y1</span><span class="o">=</span><span class="n">max_y_range</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">fillcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="n">title</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                <span class="s1">&#39;font&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">font_size</span><span class="p">},</span>
                <span class="s1">&#39;xanchor&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="s1">&#39;yanchor&#39;</span><span class="p">:</span> <span class="s1">&#39;top&#39;</span><span class="p">,</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mf">0.99</span>
            <span class="p">},</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">font_size</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">reverse_y_axis</span><span class="p">:</span>
            <span class="n">main_fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">autorange</span><span class="o">=</span><span class="s2">&quot;reversed&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;image_name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spell_out_special_characters</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="si">}</span><span class="s2">.html&quot;</span><span class="p">,</span>
            <span class="s2">&quot;image_object&quot;</span><span class="p">:</span> <span class="n">main_fig</span>
        <span class="p">}</span>

    <span class="c1">#####################</span>
    <span class="c1"># Main Code Block ##</span>
    <span class="c1">#####################</span>

    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

    <span class="c1"># Set the discrete or continuous color parameters</span>
    <span class="n">color_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">colorscale</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">title_substring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">annotations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">color_dict</span> <span class="o">=</span> <span class="n">get_defined_color_map</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span>
            <span class="n">defined_color_map</span><span class="o">=</span><span class="n">defined_color_map</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="n">annotation_colorscale</span>
        <span class="p">)</span>
        <span class="n">title_substring</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Highlighted by </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">annotations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">feature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colorscale</span> <span class="o">=</span> <span class="n">feature_colorscale</span>
        <span class="n">title_substring</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Colored by &quot;</span><span class="si">{</span><span class="n">feature</span><span class="si">}</span><span class="s1">&quot;, &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;table: &quot;</span><span class="si">{</span><span class="n">layer</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">layer</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;Original&quot;</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="p">)</span>

    <span class="c1"># Create the partial function with the common keyword arguments directly</span>
    <span class="n">plot_main</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
        <span class="n">main_figure_generation</span><span class="p">,</span>
        <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
        <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span>
        <span class="n">color_mapping</span><span class="o">=</span><span class="n">color_dict</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="n">colorscale</span><span class="p">,</span>
        <span class="n">dot_size</span><span class="o">=</span><span class="n">dot_size</span><span class="p">,</span>
        <span class="n">dot_transparency</span><span class="o">=</span><span class="n">dot_transparency</span><span class="p">,</span>
        <span class="n">figure_width</span><span class="o">=</span><span class="n">figure_width</span><span class="p">,</span>
        <span class="n">figure_height</span><span class="o">=</span><span class="n">figure_height</span><span class="p">,</span>
        <span class="n">figure_dpi</span><span class="o">=</span><span class="n">figure_dpi</span><span class="p">,</span>
        <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">stratify_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Check if the stratification column exists in the data</span>
        <span class="n">check_annotation</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">stratify_by</span><span class="p">)</span>
        <span class="n">unique_stratification_values</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">stratify_by</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">strat_value</span> <span class="ow">in</span> <span class="n">unique_stratification_values</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">stratify_by</span><span class="p">]</span> <span class="o">==</span> <span class="n">strat_value</span>
            <span class="n">title_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Subsetting </span><span class="si">{</span><span class="n">stratify_by</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">strat_value</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;number of cells in the region: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">adata_subset</span> <span class="o">=</span> <span class="n">select_values</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
                <span class="n">annotation</span><span class="o">=</span><span class="n">stratify_by</span><span class="p">,</span>
                <span class="n">values</span><span class="o">=</span><span class="n">strat_value</span>
            <span class="p">)</span>

            <span class="n">spatial_df</span> <span class="o">=</span> <span class="n">prepare_spatial_dataframe</span><span class="p">(</span>
                <span class="n">adata_subset</span><span class="p">,</span>
                <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span>
                <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
                <span class="n">layer</span><span class="o">=</span><span class="n">layer</span>
            <span class="p">)</span>
            <span class="n">title_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">title_substring</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="c1"># Call the partial function with additional arguments</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">plot_main</span><span class="p">(</span>
                <span class="n">spatial_df</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title_str</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">title_str</span> <span class="o">=</span> <span class="s2">&quot;Interactive Spatial Plot&quot;</span>
        <span class="n">title_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">title_substring</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">spatial_df</span> <span class="o">=</span> <span class="n">prepare_spatial_dataframe</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span>
            <span class="n">annotations</span><span class="o">=</span><span class="n">annotations</span><span class="p">,</span>
            <span class="n">feature</span><span class="o">=</span><span class="n">feature</span><span class="p">,</span>
            <span class="n">layer</span><span class="o">=</span><span class="n">layer</span>
        <span class="p">)</span>

        <span class="c1"># For non-stratified case, pass extra parameters if needed</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">plot_main</span><span class="p">(</span>
            <span class="n">spatial_df</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="n">title_str</span>
        <span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="sankey_plot"><a class="viewcode-back" href="../../spac.html#spac.visualization.sankey_plot">[docs]</a><span class="k">def</span> <span class="nf">sankey_plot</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">:</span> <span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
        <span class="n">source_annotation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target_annotation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">source_color_map</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tab20&quot;</span><span class="p">,</span>
        <span class="n">target_color_map</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tab20c&quot;</span><span class="p">,</span>
        <span class="n">sankey_font</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">12.0</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a Sankey plot from the given AnnData object.</span>
<span class="sd">    The color map refers to matplotlib color maps, default is tab20 for</span>
<span class="sd">    source annotation, and tab20c for target annotation.</span>
<span class="sd">    For more information on colormaps, see:</span>
<span class="sd">    https://matplotlib.org/stable/users/explain/colors/colormaps.html</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        The annotated data matrix.</span>
<span class="sd">    source_annotation : str</span>
<span class="sd">        The source annotation to use for the Sankey plot.</span>
<span class="sd">    target_annotation : str</span>
<span class="sd">        The target annotation to use for the Sankey plot.</span>
<span class="sd">    source_color_map : str</span>
<span class="sd">        The color map to use for the source nodes. Default is tab20.</span>
<span class="sd">    target_color_map : str</span>
<span class="sd">        The color map to use for the target nodes. Default is tab20c.</span>
<span class="sd">    sankey_font : float, optional</span>
<span class="sd">        The font size to use for the Sankey plot. Defaults to 12.0.</span>
<span class="sd">    prefix : bool, optional</span>
<span class="sd">        Whether to prefix the target labels with</span>
<span class="sd">        the source labels. Defaults to True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plotly.graph_objs._figure.Figure</span>
<span class="sd">        The generated Sankey plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">label_relations</span> <span class="o">=</span> <span class="n">annotation_category_relations</span><span class="p">(</span>
        <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
        <span class="n">source_annotation</span><span class="o">=</span><span class="n">source_annotation</span><span class="p">,</span>
        <span class="n">target_annotation</span><span class="o">=</span><span class="n">target_annotation</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span>
    <span class="p">)</span>
    <span class="c1"># Extract and prepare source and target labels</span>
    <span class="n">source_labels</span> <span class="o">=</span> <span class="n">label_relations</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">target_labels</span> <span class="o">=</span> <span class="n">label_relations</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">all_labels</span> <span class="o">=</span> <span class="n">source_labels</span> <span class="o">+</span> <span class="n">target_labels</span>

    <span class="n">source_label_colors</span> <span class="o">=</span> <span class="n">color_mapping</span><span class="p">(</span><span class="n">source_labels</span><span class="p">,</span> <span class="n">source_color_map</span><span class="p">)</span>
    <span class="n">target_label_colors</span> <span class="o">=</span> <span class="n">color_mapping</span><span class="p">(</span><span class="n">target_labels</span><span class="p">,</span> <span class="n">target_color_map</span><span class="p">)</span>
    <span class="n">label_colors</span> <span class="o">=</span> <span class="n">source_label_colors</span> <span class="o">+</span> <span class="n">target_label_colors</span>

    <span class="c1"># Create a dictionary to map labels to indices</span>
    <span class="n">label_to_index</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_labels</span><span class="p">)}</span>
    <span class="n">color_to_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">label</span><span class="p">:</span> <span class="n">color</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">source_labels</span><span class="p">,</span> <span class="n">source_label_colors</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1"># Initialize lists to store the source indices, target indices, and values</span>
    <span class="n">source_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">target_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">link_colors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># For each row in label_relations, add the source index, target index,</span>
    <span class="c1"># and count to the respective lists</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">label_relations</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">source_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_to_index</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]])</span>
        <span class="n">target_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_to_index</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]])</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
        <span class="n">link_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">color_to_map</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]])</span>

    <span class="c1"># Generate Sankey diagram</span>
    <span class="c1"># Calculate the x-coordinate for each label</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Sankey</span><span class="p">(</span>
        <span class="n">node</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">pad</span><span class="o">=</span><span class="n">sankey_font</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span>
            <span class="n">thickness</span><span class="o">=</span><span class="n">sankey_font</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
            <span class="n">label</span><span class="o">=</span><span class="n">all_labels</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">label_colors</span>
        <span class="p">),</span>
        <span class="n">link</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">arrowlen</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source_indices</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">target_indices</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">link_colors</span>
        <span class="p">),</span>
        <span class="n">arrangement</span><span class="o">=</span><span class="s2">&quot;snap&quot;</span><span class="p">,</span>
        <span class="n">textfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">sankey_font</span>
        <span class="p">)</span>
    <span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">customdata</span> <span class="o">=</span> <span class="n">label_relations</span><span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;percentage_source&#39;</span><span class="p">,</span> <span class="s1">&#39;percentage_target&#39;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">hovertemplate</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s1">&#39;%</span><span class="si">{source.label}</span><span class="s1"> to %</span><span class="si">{target.label}</span><span class="s1">&lt;br&gt;&#39;</span>
        <span class="s1">&#39;%</span><span class="si">{customdata[0]}</span><span class="s1">% to %</span><span class="si">{customdata[1]}</span><span class="s1">%&lt;br&gt;&#39;</span>
        <span class="s1">&#39;Count: %</span><span class="si">{value}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">hovertemplate</span> <span class="o">=</span> <span class="n">hovertemplate</span>

    <span class="c1"># Customize the Sankey diagram layout</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title_text</span><span class="o">=</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">source_annotation</span><span class="si">}</span><span class="s1">&quot; to &quot;</span><span class="si">{</span><span class="n">target_annotation</span><span class="si">}</span><span class="s1">&quot;&lt;br&gt;Sankey Diagram&#39;</span>
        <span class="p">),</span>
        <span class="n">title_x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">title_font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">family</span><span class="o">=</span><span class="s1">&#39;Arial, bold&#39;</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">sankey_font</span><span class="p">,</span>  <span class="c1"># Set the title font size</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span>  <span class="c1"># Set the title font color</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">l</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">t</span><span class="o">=</span><span class="n">sankey_font</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">b</span><span class="o">=</span><span class="n">sankey_font</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="relational_heatmap"><a class="viewcode-back" href="../../spac.html#spac.visualization.relational_heatmap">[docs]</a><span class="k">def</span> <span class="nf">relational_heatmap</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">:</span> <span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
        <span class="n">source_annotation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">target_annotation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">color_map</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mint&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a relational heatmap from the given AnnData object.</span>
<span class="sd">    The color map refers to matplotlib color maps, default is mint.</span>
<span class="sd">    For more information on colormaps, see:</span>
<span class="sd">    https://matplotlib.org/stable/users/explain/colors/colormaps.html</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        The annotated data matrix.</span>
<span class="sd">    source_annotation : str</span>
<span class="sd">        The source annotation to use for the relational heatmap.</span>
<span class="sd">    target_annotation : str</span>
<span class="sd">        The target annotation to use for the relational heatmap.</span>
<span class="sd">    color_map : str</span>
<span class="sd">        The color map to use for the relational heatmap. Default is mint.</span>
<span class="sd">    **kwargs : dict, optional</span>
<span class="sd">        Additional keyword arguments. For example, you can pass font_size=12.0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing:</span>
<span class="sd">        - &quot;figure&quot; (plotly.graph_objs._figure.Figure):</span>
<span class="sd">            The generated relational heatmap as a Plotly figure.</span>
<span class="sd">        - &quot;file_name&quot; (str):</span>
<span class="sd">            The name of the file where the relational matrix can be saved.</span>
<span class="sd">        - &quot;data&quot; (pandas.DataFrame):</span>
<span class="sd">            A relational matrix DataFrame with percentage values.</span>
<span class="sd">            Rows represent source annotations,</span>
<span class="sd">            columns represent target annotations,</span>
<span class="sd">            and an additional &quot;total&quot; column sums</span>
<span class="sd">            the percentages for each source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Default font size</span>
    <span class="n">font_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;font_size&#39;</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">)</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prefix&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Get the relationship between source and target annotations</span>

    <span class="n">label_relations</span> <span class="o">=</span> <span class="n">annotation_category_relations</span><span class="p">(</span>
            <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
            <span class="n">source_annotation</span><span class="o">=</span><span class="n">source_annotation</span><span class="p">,</span>
            <span class="n">target_annotation</span><span class="o">=</span><span class="n">target_annotation</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span>
        <span class="p">)</span>

    <span class="c1"># Pivot the data to create a matrix for the heatmap</span>
    <span class="n">heatmap_matrix</span> <span class="o">=</span> <span class="n">label_relations</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="s1">&#39;source&#39;</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="s1">&#39;percentage_source&#39;</span>
    <span class="p">)</span>

    <span class="n">heatmap_matrix</span> <span class="o">=</span> <span class="n">heatmap_matrix</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">heatmap_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">heatmap_matrix</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="c1"># Create text labels for the heatmap</span>
    <span class="n">label_relations</span><span class="p">[</span><span class="s1">&#39;text_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">label_relations</span><span class="p">[</span><span class="s2">&quot;percentage_source&quot;</span><span class="p">]</span>
    <span class="p">]</span>

    <span class="n">heatmap_matrix2</span> <span class="o">=</span> <span class="n">label_relations</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="s1">&#39;source&#39;</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="s1">&#39;percentage_source&#39;</span>
        <span class="p">)</span>

    <span class="n">heatmap_matrix2</span> <span class="o">=</span> <span class="n">heatmap_matrix2</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">hover_template</span> <span class="o">=</span> <span class="s1">&#39;Source: %</span><span class="si">{z}</span><span class="s1">%&lt;br&gt;Target: %</span><span class="si">{customdata}</span><span class="s1">%&lt;extra&gt;&lt;/extra&gt;&#39;</span>
    <span class="c1"># Ensure alignment of the text data with the heatmap matrix</span>
    <span class="n">z</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">iter_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">y_item</span> <span class="ow">in</span> <span class="n">y</span><span class="p">:</span>
        <span class="n">iter_list</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x_item</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">z_data_point</span> <span class="o">=</span> <span class="n">label_relations</span><span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">label_relations</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">x_item</span>
                <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">label_relations</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">y_item</span>
                <span class="p">)</span>
            <span class="p">][</span><span class="s1">&#39;percentage_source&#39;</span><span class="p">]</span>
            <span class="n">iter_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_data_point</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">z_data_point</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">z</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">iter_list</span><span class="p">])</span>

    <span class="c1"># Create heatmap</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">create_annotated_heatmap</span><span class="p">(</span>
        <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="n">color_map</span><span class="p">,</span>
        <span class="n">customdata</span><span class="o">=</span><span class="n">heatmap_matrix2</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hover_template</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">target_annotation</span><span class="p">,</span>
            <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">dtick</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
            <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;rgb(0, 0, 0)&quot;</span><span class="p">,</span>
            <span class="n">tickvals</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))),</span>
            <span class="n">ticktext</span><span class="o">=</span><span class="n">x</span>
        <span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="n">source_annotation</span><span class="p">,</span>
            <span class="n">ticks</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">dtick</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">ticksuffix</span><span class="o">=</span><span class="s2">&quot;   &quot;</span><span class="p">,</span>
            <span class="n">tickvals</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))),</span>
            <span class="n">ticktext</span><span class="o">=</span><span class="n">y</span>
        <span class="p">),</span>
        <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">l</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">t</span><span class="o">=</span><span class="n">font_size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">b</span><span class="o">=</span><span class="n">font_size</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">)):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">annotations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">font_size</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
        <span class="n">side</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
        <span class="n">tickangle</span><span class="o">=</span><span class="mi">90</span>
    <span class="p">)</span>

    <span class="c1"># Data output section</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">layout</span>
    <span class="c1"># Create a DataFrame</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;customdata&#39;</span><span class="p">])</span>
    <span class="n">matrix</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;yaxis&#39;</span><span class="p">][</span><span class="s1">&#39;ticktext&#39;</span><span class="p">]</span>
    <span class="n">matrix</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="n">layout</span><span class="p">[</span><span class="s1">&#39;xaxis&#39;</span><span class="p">][</span><span class="s1">&#39;ticktext&#39;</span><span class="p">]</span>
    <span class="n">matrix</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Display the DataFrame</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source_annotation</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">target_annotation</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> \
                <span class="s2">&quot;_relation_matrix.csv&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;figure&quot;</span><span class="p">:</span> <span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">matrix</span><span class="p">}</span></div>


<div class="viewcode-block" id="plot_ripley_l"><a class="viewcode-back" href="../../spac.html#spac.visualization.plot_ripley_l">[docs]</a><span class="k">def</span> <span class="nf">plot_ripley_l</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">,</span>
        <span class="n">phenotypes</span><span class="p">,</span>
        <span class="n">regions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sims</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">return_df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot Ripley&#39;s L statistic for multiple bins and different regions</span>
<span class="sd">    for a given pair of phenotypes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        AnnData object containing Ripley&#39;s L results in `adata.uns[&#39;ripley_l&#39;]`.</span>
<span class="sd">    phenotypes : tuple of str</span>
<span class="sd">        A tuple of two phenotypes: (center_phenotype, neighbor_phenotype).</span>
<span class="sd">    regions : list of str, optional</span>
<span class="sd">        A list of region labels to plot. If None, plot all available regions.</span>
<span class="sd">        Default is None.</span>
<span class="sd">    sims : bool, optional</span>
<span class="sd">        Whether to plot the simulation results. Default is False.</span>
<span class="sd">    return_df : bool, optional</span>
<span class="sd">        Whether to return the DataFrame containing the Ripley&#39;s L results.</span>
<span class="sd">    kwargs : dict, optional</span>
<span class="sd">        Additional keyword arguments to pass to `seaborn.lineplot`.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the Ripley L results are not found in `adata.uns[&#39;ripley_l&#39;]`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The Axes object containing the plot, which can be further modified.</span>
<span class="sd">    df : pandas.DataFrame, optional</span>
<span class="sd">        The DataFrame containing the Ripley&#39;s L results, if `return_df` is True.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; ax = plot_ripley_l(</span>
<span class="sd">    ...     adata,</span>
<span class="sd">    ...     phenotypes=(&#39;Phenotype1&#39;, &#39;Phenotype2&#39;),</span>
<span class="sd">    ...     regions=[&#39;region1&#39;, &#39;region2&#39;])</span>
<span class="sd">    &gt;&gt;&gt; plt.show()</span>

<span class="sd">    This returns the `Axes` object for further customization and displays the plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Retrieve the results from adata.uns[&#39;ripley_l&#39;]</span>
    <span class="n">ripley_results</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ripley_l&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ripley_results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Ripley L results not found in the analsyis.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Filter the results for the specific pair of phenotypes</span>
    <span class="n">filtered_results</span> <span class="o">=</span> <span class="n">ripley_results</span><span class="p">[</span>
        <span class="p">(</span><span class="n">ripley_results</span><span class="p">[</span><span class="s1">&#39;center_phenotype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">phenotypes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">ripley_results</span><span class="p">[</span><span class="s1">&#39;neighbor_phenotype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">phenotypes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">filtered_results</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="c1"># Generate all unique combinations of phenotype pairs</span>
        <span class="n">unique_pairs</span> <span class="o">=</span> <span class="n">ripley_results</span><span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;center_phenotype&#39;</span><span class="p">,</span> <span class="s1">&#39;neighbor_phenotype&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No Ripley L results found for the specified pair of phenotypes.&quot;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Center Phenotype: &quot;</span><span class="si">{</span><span class="n">phenotypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Neighbor Phenotype: &quot;</span><span class="si">{</span><span class="n">phenotypes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Exisiting unique pairs: </span><span class="si">{</span><span class="n">unique_pairs</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># If specific regions are provided, filter them, otherwise plot all regions</span>
    <span class="k">if</span> <span class="n">regions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filtered_results</span> <span class="o">=</span> <span class="n">filtered_results</span><span class="p">[</span>
            <span class="n">filtered_results</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">regions</span><span class="p">)]</span>

    <span class="c1"># Check if the results are emply after subsetting the regions</span>
    <span class="k">if</span> <span class="n">filtered_results</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">available_regions</span> <span class="o">=</span> <span class="n">ripley_results</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No data available for the specified regions: </span><span class="si">{</span><span class="n">regions</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Available regions: </span><span class="si">{</span><span class="n">available_regions</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Create a figure and axes</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="n">plot_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Plot Ripley&#39;s L for each region</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_results</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>  <span class="c1"># Region label</span>

        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ripley_l&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
               <span class="sa">f</span><span class="s2">&quot;Ripley L results not found for region: </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span>
               <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Message: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
              <span class="n">message</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">n_center</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ripley_l&#39;</span><span class="p">][</span><span class="s1">&#39;n_center&#39;</span><span class="p">]</span>
        <span class="n">n_neighbors</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ripley_l&#39;</span><span class="p">][</span><span class="s1">&#39;n_neighbor&#39;</span><span class="p">]</span>
        <span class="n">n_cells</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">n_center</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">n_neighbors</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ripley_l&#39;</span><span class="p">][</span><span class="s1">&#39;area&#39;</span><span class="p">]</span>
        <span class="c1"># Plot the Ripley L statistic for the region</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ripley_l&#39;</span><span class="p">][</span><span class="s1">&#39;L_stat&#39;</span><span class="p">],</span>
            <span class="n">x</span><span class="o">=</span><span class="s1">&#39;bins&#39;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">n_cells</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">area</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Calculate averages for simulations if enabled</span>
        <span class="k">if</span> <span class="n">sims</span><span class="p">:</span>
            <span class="n">sims_stat_df</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ripley_l&quot;</span><span class="p">][</span><span class="s2">&quot;sims_stat&quot;</span><span class="p">]</span>
            <span class="n">avg_stats</span> <span class="o">=</span> <span class="n">sims_stat_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;bins&quot;</span><span class="p">)[</span><span class="s2">&quot;stats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">avg_used_center_cells</span> <span class="o">=</span> \
                <span class="n">sims_stat_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;bins&quot;</span><span class="p">)[</span><span class="s2">&quot;used_center_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Prepare plotted data to return if return_df is True</span>
        <span class="n">l_stat_data</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ripley_l&#39;</span><span class="p">][</span><span class="s1">&#39;L_stat&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">stat_row</span> <span class="ow">in</span> <span class="n">l_stat_data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="n">region</span><span class="p">,</span>
                <span class="s1">&#39;radius&#39;</span><span class="p">:</span> <span class="n">stat_row</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">],</span>
                <span class="s1">&#39;ripley(radius)&#39;</span><span class="p">:</span> <span class="n">stat_row</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">],</span>
                <span class="s1">&#39;region_area&#39;</span><span class="p">:</span> <span class="n">area</span><span class="p">,</span>
                <span class="s1">&#39;n_center&#39;</span><span class="p">:</span> <span class="n">n_center</span><span class="p">,</span>
                <span class="s1">&#39;n_neighbor&#39;</span><span class="p">:</span> <span class="n">n_neighbors</span><span class="p">,</span>
                <span class="s1">&#39;used_center_cells&#39;</span><span class="p">:</span> <span class="n">stat_row</span><span class="p">[</span><span class="s1">&#39;used_center_cells&#39;</span><span class="p">]</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">sims</span><span class="p">:</span>
                <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;avg_sim_ripley(radius)&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">avg_stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stat_row</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;avg_sim_used_center_cells&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">avg_used_center_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stat_row</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">plot_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sims</span><span class="p">:</span>
            <span class="n">confidence_level</span> <span class="o">=</span> <span class="mi">95</span>
            <span class="n">errorbar</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;pi&quot;</span><span class="p">,</span> <span class="n">confidence_level</span><span class="p">)</span>
            <span class="n">n_sims</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;n_simulations&quot;</span><span class="p">]</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;bins&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s2">&quot;stats&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;ripley_l&quot;</span><span class="p">][</span><span class="s2">&quot;sims_stat&quot;</span><span class="p">],</span>
                <span class="n">errorbar</span><span class="o">=</span><span class="n">errorbar</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Simulations(</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">):</span><span class="si">{</span><span class="n">n_sims</span><span class="si">}</span><span class="s2"> runs&quot;</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

    <span class="c1"># Set labels, title, and grid</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
        <span class="s2">&quot;Ripley&#39;s L Statistic for phenotypes:&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">phenotypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">phenotypes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Regions:(center, neighbor), area&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Set the horizontal axis lable</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Radii (pixels)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Ripley&#39;s L Statistic&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_df</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">plot_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">df</span>

    <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="_prepare_spatial_distance_data"><a class="viewcode-back" href="../../modules/visualization._prepare_spatial_distance_data.html#spac.visualization._prepare_spatial_distance_data">[docs]</a><span class="k">def</span> <span class="nf">_prepare_spatial_distance_data</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">annotation</span><span class="p">,</span>
    <span class="n">stratify_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">spatial_distance</span><span class="o">=</span><span class="s1">&#39;spatial_distance&#39;</span><span class="p">,</span>
    <span class="n">distance_from</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">distance_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares a tidy DataFrame for nearest-neighbor (spatial distance) plotting.</span>

<span class="sd">    This function:</span>
<span class="sd">      1) Validates required parameters (annotation, distance_from).</span>
<span class="sd">      2) Retrieves the spatial distance matrix from</span>
<span class="sd">         `adata.obsm[spatial_distance]`.</span>
<span class="sd">      3) Merges annotation (and optional stratify column).</span>
<span class="sd">      4) Filters rows to the reference phenotype (`distance_from`).</span>
<span class="sd">      5) Subsets columns if `distance_to` is given;</span>
<span class="sd">         otherwise keeps all distances.</span>
<span class="sd">      6) Reshapes (melts) into long-form data:</span>
<span class="sd">         columns -&gt; [cellid, group, distance].</span>
<span class="sd">      7) Applies optional log1p transform.</span>

<span class="sd">    The resulting DataFrame is suitable for plotting with tool like Seaborn.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        Annotated data matrix, containing distances in</span>
<span class="sd">        `adata.obsm[spatial_distance]`.</span>
<span class="sd">    annotation : str</span>
<span class="sd">        Column in `adata.obs` indicating cell phenotype or annotation.</span>
<span class="sd">    stratify_by : str, optional</span>
<span class="sd">        Column in `adata.obs` used to group/stratify data</span>
<span class="sd">        (e.g., image or sample).</span>
<span class="sd">    spatial_distance : str, optional</span>
<span class="sd">        Key in `adata.obsm` storing the distance DataFrame.</span>
<span class="sd">        Default &#39;spatial_distance&#39;.</span>
<span class="sd">    distance_from : str</span>
<span class="sd">        Reference phenotype from which distances are measured. Required.</span>
<span class="sd">    distance_to : str or list of str, optional</span>
<span class="sd">        Target phenotype(s). If None, use all available phenotype distances.</span>
<span class="sd">    log : bool, optional</span>
<span class="sd">        If True, applies np.log1p transform to the &#39;distance&#39; column, which is</span>
<span class="sd">        renamed to &#39;log_distance&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        Tidy DataFrame with columns:</span>
<span class="sd">            - &#39;cellid&#39;: index of the cell from &#39;adata.obs&#39;.</span>
<span class="sd">            - &#39;group&#39;: the target phenotype (column names of &#39;distance_map&#39;.</span>
<span class="sd">            - &#39;distance&#39;: the numeric distance value.</span>
<span class="sd">            - &#39;phenotype&#39;: the reference phenotype (&#39;distance_from&#39;).</span>
<span class="sd">            - &#39;stratify_by&#39;: optional grouping column, if provided.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If required parameters are missing, if phenotypes are not found in</span>
<span class="sd">        `adata.obs`, or if the spatial distance matrix is not available in</span>
<span class="sd">        `adata.obsm`.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; df_long = _prepare_spatial_distance_data(</span>
<span class="sd">    ...     adata=my_adata,</span>
<span class="sd">    ...     annotation=&#39;cell_type&#39;,</span>
<span class="sd">    ...     stratify_by=&#39;sample_id&#39;,</span>
<span class="sd">    ...     spatial_distance=&#39;spatial_distance&#39;,</span>
<span class="sd">    ...     distance_from=&#39;Tumor&#39;,</span>
<span class="sd">    ...     distance_to=[&#39;Stroma&#39;, &#39;Immune&#39;],</span>
<span class="sd">    ...     log=True</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; df_long.head()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Validate required parameters</span>
    <span class="k">if</span> <span class="n">distance_from</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Please specify the &#39;distance_from&#39; phenotype. This indicates &quot;</span>
            <span class="s2">&quot;the reference group from which distances are measured.&quot;</span>
        <span class="p">)</span>
    <span class="n">check_annotation</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">annotation</span><span class="p">)</span>

    <span class="c1"># Convert distance_to to list if needed</span>
    <span class="k">if</span> <span class="n">distance_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">distance_to</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">distance_to</span> <span class="o">=</span> <span class="p">[</span><span class="n">distance_to</span><span class="p">]</span>

    <span class="n">phenotypes_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="n">distance_from</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">distance_to</span> <span class="k">if</span> <span class="n">distance_to</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="p">)</span>

    <span class="c1"># Ensure distance_from and distance_to exist in adata.obs[annotation]</span>
    <span class="n">check_label</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">,</span>
        <span class="n">annotation</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">phenotypes_to_check</span><span class="p">,</span>
        <span class="n">should_exist</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="c1"># Retrieve the spatial distance matrix from adata.obsm</span>
    <span class="k">if</span> <span class="n">spatial_distance</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">spatial_distance</span><span class="si">}</span><span class="s2">&#39; does not exist in the provided dataset. &quot;</span>
            <span class="s2">&quot;Please run &#39;calculate_nearest_neighbor&#39; first to compute and &quot;</span>
            <span class="s2">&quot;store spatial distance. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Available keys: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">distance_map</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">spatial_distance</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Verify requested phenotypes exist in the distance_map columns</span>
    <span class="n">missing_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">phenotypes_to_check</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">distance_map</span><span class="o">.</span><span class="n">columns</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">missing_cols</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Phenotypes </span><span class="si">{</span><span class="n">missing_cols</span><span class="si">}</span><span class="s2"> not found in columns of &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">spatial_distance</span><span class="si">}</span><span class="s2">&#39;. Columns present: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">distance_map</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Validate &#39;stratify_by&#39; column if provided</span>
    <span class="k">if</span> <span class="n">stratify_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">check_annotation</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">annotations</span><span class="o">=</span><span class="n">stratify_by</span><span class="p">)</span>

    <span class="c1"># Build a meta DataFrame with phenotype &amp; optional stratify column</span>
    <span class="n">meta_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;phenotype&#39;</span><span class="p">:</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">annotation</span><span class="p">]},</span>
                             <span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stratify_by</span><span class="p">:</span>
        <span class="n">meta_data</span><span class="p">[</span><span class="n">stratify_by</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">stratify_by</span><span class="p">]</span>

    <span class="c1"># Merge metadata with distance_map and filter for &#39;distance_from&#39;</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">meta_data</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">distance_map</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">df_merged</span><span class="p">[</span><span class="n">df_merged</span><span class="p">[</span><span class="s1">&#39;phenotype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">distance_from</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No cells found with phenotype == &#39;</span><span class="si">{</span><span class="n">distance_from</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Reset index to ensure cell names are in a column called &#39;cellid&#39;</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;cellid&#39;</span><span class="p">})</span>

    <span class="c1"># Prepare the list of metadata columns</span>
    <span class="n">meta_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;phenotype&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">stratify_by</span><span class="p">:</span>
        <span class="n">meta_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stratify_by</span><span class="p">)</span>

    <span class="c1"># Determine distance columns</span>
    <span class="k">if</span> <span class="n">distance_to</span><span class="p">:</span>
        <span class="n">keep_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cellid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">meta_cols</span> <span class="o">+</span> <span class="n">distance_to</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">non_distance_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cellid&#39;</span><span class="p">,</span> <span class="s1">&#39;phenotype&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">stratify_by</span><span class="p">:</span>
            <span class="n">non_distance_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stratify_by</span><span class="p">)</span>
        <span class="n">distance_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">non_distance_cols</span>
        <span class="p">]</span>
        <span class="n">keep_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cellid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">meta_cols</span> <span class="o">+</span> <span class="n">distance_columns</span>

    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">df_merged</span><span class="p">[</span><span class="n">keep_cols</span><span class="p">]</span>

    <span class="c1"># Melt the DataFrame from wide to long format</span>
    <span class="n">df_long</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
        <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cellid&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">meta_cols</span><span class="p">,</span>
        <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span>
    <span class="p">)</span>

    <span class="c1"># Convert columns to categorical for consistency</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;phenotype&#39;</span><span class="p">,</span> <span class="n">stratify_by</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_long</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_long</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>

    <span class="c1"># Reorder categories for &#39;group&#39; if &#39;distance_to&#39; is provided</span>
    <span class="k">if</span> <span class="n">distance_to</span><span class="p">:</span>
        <span class="n">df_long</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">reorder_categories</span><span class="p">(</span><span class="n">distance_to</span><span class="p">)</span>
        <span class="n">df_long</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Ensure &#39;distance&#39; is numeric and apply log transform if requested</span>
    <span class="n">df_long</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df_long</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">df_long</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">df_long</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">])</span>
        <span class="n">df_long</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="s1">&#39;log_distance&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Reorder columns dynamically based on the presence of &#39;log&#39;</span>
    <span class="n">distance_col</span> <span class="o">=</span> <span class="s1">&#39;log_distance&#39;</span> <span class="k">if</span> <span class="n">log</span> <span class="k">else</span> <span class="s1">&#39;distance&#39;</span>
    <span class="n">final_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cellid&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">distance_col</span><span class="p">,</span> <span class="s1">&#39;phenotype&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">stratify_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">final_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stratify_by</span><span class="p">)</span>
    <span class="n">df_long</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="n">final_cols</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">df_long</span></div>


<div class="viewcode-block" id="_plot_spatial_distance_dispatch"><a class="viewcode-back" href="../../modules/visualization._plot_spatial_distance_dispatch.html#spac.visualization._plot_spatial_distance_dispatch">[docs]</a><span class="k">def</span> <span class="nf">_plot_spatial_distance_dispatch</span><span class="p">(</span>
    <span class="n">df_long</span><span class="p">,</span>
    <span class="n">method</span><span class="p">,</span>
    <span class="n">plot_type</span><span class="p">,</span>
    <span class="n">stratify_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">facet_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">distance_col</span><span class="o">=</span><span class="s2">&quot;distance&quot;</span><span class="p">,</span>
    <span class="n">hue_axis</span><span class="o">=</span><span class="s2">&quot;group&quot;</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dispatch a seaborn call to visualise nearest-neighbor distances.</span>
<span class="sd">    Returns Axes object(s) for further customization.</span>

<span class="sd">    Layout logic</span>
<span class="sd">    ------------</span>
<span class="sd">    1. ``stratify_by`` &amp; ``facet_plot``  Faceted plot, returns ``Axes``</span>
<span class="sd">       or ``List[Axes]`` for the &quot;ax&quot; key.</span>
<span class="sd">    2. ``stratify_by`` &amp; not ``facet_plot``  List of plots, returns</span>
<span class="sd">       ``List[Axes]`` for the &quot;ax&quot; key.</span>
<span class="sd">    3. ``stratify_by`` is None  Single plot, returns ``Axes`` or</span>
<span class="sd">       ``List[Axes]`` (if plot_type creates facets) for the &quot;ax&quot; key.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_long : pd.DataFrame</span>
<span class="sd">        Tidy DataFrame returned by `_prepare_spatial_distance_data` with</span>
<span class="sd">        a long layout and with  columns [&#39;cellid&#39;, &#39;group&#39;, &#39;distance&#39;,</span>
<span class="sd">        &#39;phenotype&#39;, &#39;stratify_by&#39;].</span>
<span class="sd">    method : {&#39;numeric&#39;, &#39;distribution&#39;}</span>
<span class="sd">        ``&#39;numeric&#39;``  :pyfunc:`seaborn.catplot`</span>
<span class="sd">        ``&#39;distribution&#39;``  :pyfunc:`seaborn.displot`</span>
<span class="sd">    plot_type : str</span>
<span class="sd">        Kind forwarded to Seaborn.</span>
<span class="sd">        Numeric (`method=&#39;numeric&#39;`)  box, violin, boxen, strip, swarm, etc.</span>
<span class="sd">        Distribution (`method=&#39;distribution&#39;`)  hist, kde, ecdf, etc.</span>
<span class="sd">    stratify_by : str or None</span>
<span class="sd">        Column used to split data. *None* for no splitting.</span>
<span class="sd">    facet_plot : bool, default False</span>
<span class="sd">        If True with stratify_by, create a faceted grid, otherwise</span>
<span class="sd">        returns individual axes.</span>
<span class="sd">    distance_col : str, default &#39;distance&#39;</span>
<span class="sd">        Column name in df_long holding the numeric distance values.</span>
<span class="sd">        &#39;distance&#39;  raw Euclidean / pixel / micron distances.</span>
<span class="sd">        &#39;log_distance&#39;  natural-logtransformed distances.</span>
<span class="sd">        The axis label is automatically adjusted.</span>
<span class="sd">    hue_axis : str, default &#39;group&#39;</span>
<span class="sd">        Column that encodes the hue (color) dimension.</span>
<span class="sd">    palette : dict or str or None</span>
<span class="sd">         dict  color map forwarded to seaborn/Matpotlib.</span>
<span class="sd">         str   any Seaborn/Matplotlib palette name</span>
<span class="sd">         None  defaults chosen by Seaborn</span>
<span class="sd">        Typically the pincolor map prepared upstream.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Extra keyword args propagated to Seaborn. Legend control</span>
<span class="sd">        (e.g. `legend=False`) should be passed here if needed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        {</span>
<span class="sd">            &#39;data&#39;: pandas.DataFrame,      # the input df_long</span>
<span class="sd">            &#39;ax&#39;  : matplotlib.axes.Axes | list[Axes]</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;numeric&quot;</span><span class="p">,</span> <span class="s2">&quot;distribution&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`method` must be &#39;numeric&#39; or &#39;distribution&#39;.&quot;</span><span class="p">)</span>

    <span class="c1"># Choose plotting function</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;numeric&quot;</span><span class="p">:</span>
        <span class="n">_plot_base</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">catplot</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">distance_col</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;group&quot;</span><span class="p">,</span>
            <span class="n">hue</span><span class="o">=</span><span class="n">hue_axis</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span>
            <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># distribution</span>
        <span class="n">_plot_base</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">distance_col</span><span class="p">,</span>
            <span class="n">hue</span><span class="o">=</span><span class="n">hue_axis</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span>
            <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Single plotting wrapper to create Axes object(s)</span>
    <span class="k">def</span> <span class="nf">_make_axes_object</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kws_plot</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">_plot_base</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kws_plot</span><span class="p">)</span>

        <span class="n">axis_label</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Log(Nearest Neighbor Distance)&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;log&quot;</span> <span class="ow">in</span> <span class="n">distance_col</span>
            <span class="k">else</span> <span class="s2">&quot;Nearest Neighbor Distance&quot;</span>
        <span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">set_axis_labels</span><span class="p">(</span><span class="n">axis_label</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">returned_ax</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">returned_ax</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">returned_ax</span>

    <span class="c1"># Build axes</span>
    <span class="n">final_axes_object</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">stratify_by</span> <span class="ow">and</span> <span class="n">facet_plot</span><span class="p">:</span>
        <span class="n">final_axes_object</span> <span class="o">=</span> <span class="n">_make_axes_object</span><span class="p">(</span>
            <span class="n">df_long</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="n">stratify_by</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">stratify_by</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">facet_plot</span><span class="p">:</span>
        <span class="n">list_of_all_axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">category_value</span> <span class="ow">in</span> <span class="n">df_long</span><span class="p">[</span><span class="n">stratify_by</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">data_subset</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="n">df_long</span><span class="p">[</span><span class="n">stratify_by</span><span class="p">]</span> <span class="o">==</span> <span class="n">category_value</span><span class="p">]</span>
            <span class="n">axes_or_list_for_category</span> <span class="o">=</span> <span class="n">_make_axes_object</span><span class="p">(</span>
                <span class="n">data_subset</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axes_or_list_for_category</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">list_of_all_axes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">axes_or_list_for_category</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">list_of_all_axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axes_or_list_for_category</span><span class="p">)</span>
        <span class="n">final_axes_object</span> <span class="o">=</span> <span class="n">list_of_all_axes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final_axes_object</span> <span class="o">=</span> <span class="n">_make_axes_object</span><span class="p">(</span><span class="n">df_long</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">df_long</span><span class="p">,</span> <span class="s2">&quot;ax&quot;</span><span class="p">:</span> <span class="n">final_axes_object</span><span class="p">}</span></div>


<span class="c1"># Build a master HEX palette and cache it inside the AnnData object</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># WHAT  Convert every entry in ``color_dict_rgb`` (which may contain RGB tuples,</span>
<span class="c1">#       &quot;rgb()&quot; strings, or alreadyhex values) into a canonical sixdigit HEX</span>
<span class="c1">#       string, storing the results in ``palette_hex``.</span>
<span class="c1"># WHY   Downstream plotting utilities (Matplotlib / Seaborn) expect colours in</span>
<span class="c1">#       HEX.  Performing the conversion once, here, guarantees a uniform format</span>
<span class="c1">#       for all later plots and prevents inconsistencies when colours are</span>
<span class="c1">#       reused.</span>
<span class="c1"># HOW   The helper ``_css_rgb_or_hex_to_hex`` normalises each colour.  The</span>
<span class="c1">#       resulting dictionary is cached under ``adata.uns[&#39;_spac_palettes&#39;]`` so</span>
<span class="c1">#       that *any* later function can retrieve the same palette by name.</span>
<span class="c1">#       ``defined_color_map or annotation`` forms a unique key that ties the</span>
<span class="c1">#       palette to either a userdefined map or the current annotation field.</span>
<div class="viewcode-block" id="_css_rgb_or_hex_to_hex"><a class="viewcode-back" href="../../modules/visualization._css_rgb_or_hex_to_hex.html#spac.visualization._css_rgb_or_hex_to_hex">[docs]</a><span class="k">def</span> <span class="nf">_css_rgb_or_hex_to_hex</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">keep_alpha</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalise a CSS-style color string to a hexadecimal value or</span>
<span class="sd">    a valid Matplotlib color name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    col : str</span>
<span class="sd">        Accepted formats:</span>
<span class="sd">        * &#39;#abc&#39;, &#39;#aabbcc&#39;, &#39;#rrggbbaa&#39;</span>
<span class="sd">        * &#39;rgb(r,g,b)&#39; or &#39;rgba(r,g,b,a)&#39;, where r, g, b are 0-255 and</span>
<span class="sd">          a is 0-1 or 0-255</span>
<span class="sd">        * any named Matplotlib color</span>

<span class="sd">    keep_alpha : bool, optional</span>
<span class="sd">        If True and the input includes alpha, return an 8-digit hex;</span>
<span class="sd">        otherwise drop the alpha channel.  Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        * Lower-case colour name or</span>
<span class="sd">        * 6- or 8-digit lower-case hex.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the color cannot be interpreted.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; _css_rgb_or_hex_to_hex(&#39;gold&#39;)</span>
<span class="sd">    &#39;gold&#39;</span>
<span class="sd">    &gt;&gt;&gt; _css_rgb_or_hex_to_hex(&#39;rgb(255,0,0)&#39;)</span>
<span class="sd">    &#39;#ff0000&#39;</span>
<span class="sd">    &gt;&gt;&gt; _css_rgb_or_hex_to_hex(&#39;rgba(255,0,0,0.5)&#39;, keep_alpha=True)</span>
<span class="sd">    &#39;#ff000080&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">col</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># Compile the rgb()/rgba() matcher locally to satisfy style request.</span>
    <span class="n">rgb_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;rgba?\s*\(&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;\s*([0-9]{1,3})\s*,&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;\s*([0-9]{1,3})\s*,&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;\s*([0-9]{1,3})&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;(?:\s*,\s*([0-9]*\.?[0-9]+))?&#39;</span>
        <span class="sa">r</span><span class="s1">&#39;\s*\)&#39;</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># 1. direct hex</span>
    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">keep_alpha</span><span class="o">=</span><span class="n">keep_alpha</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># 2. rgb()/rgba()</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">rgb_re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">255</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;RGB components in &quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&quot; must be between 0 and 255&#39;</span>
            <span class="p">)</span>
        <span class="n">rgba</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="n">g</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="n">b</span> <span class="o">/</span> <span class="mi">255</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">a_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a_val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>      <span class="c1"># user supplied 0-255 alpha</span>
                <span class="n">a_val</span> <span class="o">/=</span> <span class="mi">255</span>
            <span class="n">rgba</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span><span class="n">rgba</span><span class="p">,</span> <span class="n">keep_alpha</span><span class="o">=</span><span class="n">keep_alpha</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># 3. named color</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">get_named_colors_mapping</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">col</span>  <span class="c1"># let Matplotlib handle named colors</span>

    <span class="c1"># 4. unsupported format</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unsupported color format: &quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span></div>


<span class="c1"># Helper function (can be defined at module level)</span>
<div class="viewcode-block" id="_ordered_unique_figs"><a class="viewcode-back" href="../../modules/visualization._ordered_unique_figs.html#spac.visualization._ordered_unique_figs">[docs]</a><span class="k">def</span> <span class="nf">_ordered_unique_figs</span><span class="p">(</span><span class="n">axes_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper to get unique figures from a list of axes,</span>
<span class="sd">    preserving first-seen order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ax_item</span> <span class="ow">in</span> <span class="n">axes_list</span><span class="p">:</span> <span class="c1"># Assumes axes_list is indeed a list</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ax_item</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">seen</span><span class="p">)</span></div>


<div class="viewcode-block" id="visualize_nearest_neighbor"><a class="viewcode-back" href="../../spac.html#spac.visualization.visualize_nearest_neighbor">[docs]</a><span class="k">def</span> <span class="nf">visualize_nearest_neighbor</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">annotation</span><span class="p">,</span>
    <span class="n">distance_from</span><span class="p">,</span>
    <span class="n">distance_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">stratify_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">spatial_distance</span><span class="o">=</span><span class="s1">&#39;spatial_distance&#39;</span><span class="p">,</span>
    <span class="n">facet_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">annotation_colorscale</span><span class="o">=</span><span class="s1">&#39;rainbow&#39;</span><span class="p">,</span>
    <span class="n">defined_color_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Visualize nearest-neighbor (spatial distance) data between groups of cells</span>
<span class="sd">    with optional pin-color map via numeric or distribution plots.</span>

<span class="sd">    This landing function first constructs a tidy long-form DataFrame via</span>
<span class="sd">    function `_prepare_spatial_distance_data`, then dispatches plotting to</span>
<span class="sd">    function `_plot_spatial_distance_dispatch`.  A pin-color feature guarantees</span>
<span class="sd">    consistent mapping from annotation labels to colors across figures,</span>
<span class="sd">    drawing the mapping from ``adata.uns`` (if present) or generating one</span>
<span class="sd">    automatically through `spac.utils.color_mapping`.</span>

<span class="sd">    Plot arrangement logic:</span>
<span class="sd">      1) If stratify_by is not None and facet_plot=True =&gt; single figure</span>
<span class="sd">         with subplots (faceted).</span>
<span class="sd">      2) If stratify_by is not None and facet_plot=False =&gt; multiple separate</span>
<span class="sd">         figures, one per group.</span>
<span class="sd">      3) If stratify_by is None =&gt; a single figure with one plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : anndata.AnnData</span>
<span class="sd">        Annotated data matrix with distances in `adata.obsm[spatial_distance]`.</span>
<span class="sd">    annotation : str</span>
<span class="sd">        Column in `adata.obs` containing cell phenotypes or annotations.</span>
<span class="sd">    distance_from : str</span>
<span class="sd">        Reference phenotype from which distances are measured. Required.</span>
<span class="sd">    distance_to : str or list of str, optional</span>
<span class="sd">        Target phenotype(s) to measure distance to. If None, uses all</span>
<span class="sd">        available phenotypes.</span>
<span class="sd">    stratify_by : str, optional</span>
<span class="sd">        Column in `adata.obs` used to group or stratify data (e.g. imageid).</span>
<span class="sd">    spatial_distance : str, optional</span>
<span class="sd">        Key in `adata.obsm` storing the distance DataFrame. Default is</span>
<span class="sd">        &#39;spatial_distance&#39;.</span>
<span class="sd">    facet_plot : bool, optional</span>
<span class="sd">        If True (and stratify_by is not None), subplots in a single figure.</span>
<span class="sd">        Otherwise, multiple or single figure(s).</span>
<span class="sd">    method : {&#39;numeric&#39;, &#39;distribution&#39;}</span>
<span class="sd">        Determines the plotting style (catplot vs displot).</span>
<span class="sd">    plot_type : str or None, optional</span>
<span class="sd">        Specific seaborn plot kind.  If None, sensible defaults are selected</span>
<span class="sd">        (&#39;boxen&#39; for numeric, &#39;violin&#39; for distribution).</span>
<span class="sd">        For method=&#39;numeric&#39;: &#39;box&#39;, &#39;violin&#39;, &#39;boxen&#39;, &#39;strip&#39;, &#39;swarm&#39;.</span>
<span class="sd">        For method=&#39;distribution&#39;: &#39;hist&#39;, &#39;kde&#39;, &#39;ecdf&#39;.</span>
<span class="sd">    log : bool, optional</span>
<span class="sd">        If True, applies np.log1p transform to the distance values.</span>
<span class="sd">    annotation_colorscale : str, optional</span>
<span class="sd">        Matplotlib colormap name used when auto-enerating a new mapping.</span>
<span class="sd">        Ignored if &#39;defined_color_map&#39; is provided.</span>
<span class="sd">    defined_color_map : str, optional</span>
<span class="sd">        Key in &#39;adata.uns&#39; holding a pre-computed color dictionary.</span>
<span class="sd">        Falls back to automatic generation from &#39;annotation&#39; values.</span>
<span class="sd">    ax : matplotlib.axes.Axes, optional</span>
<span class="sd">        The matplotlib Axes containing the analysis plots.</span>
<span class="sd">        The returned ax is the passed ax or new ax created.</span>
<span class="sd">        Only works if plotting a single component. Default is None.</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        Additional arguments for seaborn figure-level functions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        {</span>
<span class="sd">            &#39;data&#39;: pd.DataFrame,  # long-form table for plotting</span>
<span class="sd">            &#39;fig&#39; : matplotlib.figure.Figure | list[Figure] | None,</span>
<span class="sd">            &#39;ax&#39;: matplotlib.axes.Axes | list[matplotlib.axes.Axes],</span>
<span class="sd">            &#39;palette&#39;: dict  # {label: &#39;#rrggbb&#39;}</span>
<span class="sd">        }</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If required parameters are invalid.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; res = visualize_nearest_neighbor(</span>
<span class="sd">    ...     adata=my_adata,</span>
<span class="sd">    ...     annotation=&#39;cell_type&#39;,</span>
<span class="sd">    ...     distance_from=&#39;Tumour&#39;,</span>
<span class="sd">    ...     distance_to=[&#39;Stroma&#39;, &#39;B cell&#39;],</span>
<span class="sd">    ...     method=&#39;numeric&#39;,</span>
<span class="sd">    ...     plot_type=&#39;box&#39;,</span>
<span class="sd">    ...     facet_plot=True,</span>
<span class="sd">    ...     stratify_by=&#39;image_id&#39;,</span>
<span class="sd">    ...     defined_color_map=&#39;pin_color_map&#39;</span>
<span class="sd">    ... )</span>
<span class="sd">    &gt;&gt;&gt; fig = res[&#39;fig&#39;]      # matplotlib.figure.Figure</span>
<span class="sd">    &gt;&gt;&gt; ax_list = res[&#39;ax&#39;]   # list[matplotlib.axes.Axes] (faceted plot)</span>
<span class="sd">    &gt;&gt;&gt; df  = res[&#39;data&#39;]     # long-form DataFrame</span>
<span class="sd">    &gt;&gt;&gt; ax_list[0].set_title(&#39;Tumour  Stroma distances&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;numeric&#39;</span><span class="p">,</span> <span class="s1">&#39;distribution&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Invalid &#39;method&#39;. Please choose &#39;numeric&#39; or &#39;distribution&#39;.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Determine plot_type if not provided</span>
    <span class="k">if</span> <span class="n">plot_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_type</span> <span class="o">=</span> <span class="s1">&#39;boxen&#39;</span> <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;numeric&#39;</span> <span class="k">else</span> <span class="s1">&#39;kde&#39;</span>

    <span class="c1"># If log=True, the column name is &#39;log_distance&#39;, else &#39;distance&#39;</span>
    <span class="n">distance_col</span> <span class="o">=</span> <span class="s1">&#39;log_distance&#39;</span> <span class="k">if</span> <span class="n">log</span> <span class="k">else</span> <span class="s1">&#39;distance&#39;</span>

    <span class="c1"># Build/fetch color palette</span>
    <span class="n">color_dict_rgb</span> <span class="o">=</span> <span class="n">get_defined_color_map</span><span class="p">(</span>
        <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
        <span class="n">defined_color_map</span><span class="o">=</span><span class="n">defined_color_map</span><span class="p">,</span>
        <span class="n">annotations</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>
        <span class="n">colorscale</span><span class="o">=</span><span class="n">annotation_colorscale</span>
    <span class="p">)</span>

    <span class="n">palette_hex</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">_css_rgb_or_hex_to_hex</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">color_dict_rgb</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;_spac_palettes&#39;</span><span class="p">,</span> <span class="p">{})[</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">defined_color_map</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">annotation</span><span class="si">}</span><span class="s2">_hex&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">palette_hex</span>

    <span class="c1"># Reshape data</span>
    <span class="n">df_long</span> <span class="o">=</span> <span class="n">_prepare_spatial_distance_data</span><span class="p">(</span>
        <span class="n">adata</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
        <span class="n">annotation</span><span class="o">=</span><span class="n">annotation</span><span class="p">,</span>
        <span class="n">stratify_by</span><span class="o">=</span><span class="n">stratify_by</span><span class="p">,</span>
        <span class="n">spatial_distance</span><span class="o">=</span><span class="n">spatial_distance</span><span class="p">,</span>
        <span class="n">distance_from</span><span class="o">=</span><span class="n">distance_from</span><span class="p">,</span>
        <span class="n">distance_to</span><span class="o">=</span><span class="n">distance_to</span><span class="p">,</span>
        <span class="n">log</span><span class="o">=</span><span class="n">log</span>
    <span class="p">)</span>

    <span class="c1"># Filter the full palette to include only the target groups present in</span>
    <span class="c1"># df_long[&#39;group&#39;]. These are the groups that will actually be used for hue</span>
    <span class="c1"># in the plot.</span>
    <span class="c1"># Derive a palette tailored to *this* figure</span>
    <span class="c1"># -----------------------------------------------------------------------------</span>
    <span class="c1"># WHAT  ``plot_specific_palette`` keeps only the colours that correspond to the</span>
    <span class="c1">#       groups actually present in the tidy DataFrame ``df_long``.</span>
    <span class="c1"># WHY   Passing the full master palette could create legend entries (and colour</span>
    <span class="c1">#       assignments) for groups that do not appear in the current subset,</span>
    <span class="c1">#       cluttering the figure.  Trimming the palette ensures a clean, accurate</span>
    <span class="c1">#       legend and avoids any mismatch between data and colour.</span>
    <span class="c1"># HOW   ``target_groups_in_plot`` is the list of unique group labels in the</span>
    <span class="c1">#       plot.  For each label we look up its HEX code in ``palette_hex``; if a</span>
    <span class="c1">#       colour exists we copy the mapping into the new dictionary.</span>
    <span class="n">target_groups_in_plot</span> <span class="o">=</span> <span class="n">df_long</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="n">plot_specific_palette</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">):</span> <span class="n">palette_hex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">target_groups_in_plot</span>
        <span class="k">if</span> <span class="n">palette_hex</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">}</span>

    <span class="c1"># Assemble kwargs &amp; dispatch</span>
    <span class="c1"># Inject the palette into the plotting dispatcher</span>
    <span class="c1"># -----------------------------------------------------------------------------</span>
    <span class="c1"># WHAT  Two keyword arguments are added/overwritten:</span>
    <span class="c1">#        ``hue_axis=&#39;group&#39;`` tells the plotting function to colour elements</span>
    <span class="c1">#           by the ``group`` column.</span>
    <span class="c1">#        ``palette=plot_specific_palette`` supplies the exact colour mapping</span>
    <span class="c1">#           we just created.</span>
    <span class="c1"># WHY   Explicitly specifying both the hue axis and its palette guarantees that</span>
    <span class="c1">#       every group is rendered with the intended colour, bypassing Seaborns</span>
    <span class="c1">#       default colour cycle and preventing accidental reordering.</span>
    <span class="c1"># HOW   ``dispatch_kwargs`` starts as a copy of any usersupplied kwargs; the</span>
    <span class="c1">#       call to ``update`` adds these paletterelated keys before control is</span>
    <span class="c1">#       handed off to the generic plotting helper.</span>

    <span class="n">dispatch_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">dispatch_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;hue_axis&#39;</span><span class="p">:</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span>
        <span class="s1">&#39;palette&#39;</span><span class="p">:</span> <span class="n">plot_specific_palette</span>
    <span class="p">})</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;numeric&#39;</span><span class="p">:</span>
        <span class="n">dispatch_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;saturation&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Set legend=False to allow for custom legend creation by the caller</span>
    <span class="c1"># The user can still override this by passing legend=True in kwargs</span>
    <span class="n">dispatch_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;legend&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">disp</span> <span class="o">=</span> <span class="n">_plot_spatial_distance_dispatch</span><span class="p">(</span>
        <span class="n">df_long</span><span class="o">=</span><span class="n">df_long</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span>
        <span class="n">stratify_by</span><span class="o">=</span><span class="n">stratify_by</span><span class="p">,</span>
        <span class="n">facet_plot</span><span class="o">=</span><span class="n">facet_plot</span><span class="p">,</span>
        <span class="n">distance_col</span><span class="o">=</span><span class="n">distance_col</span><span class="p">,</span>
        <span class="o">**</span><span class="n">dispatch_kwargs</span>
    <span class="p">)</span>

    <span class="n">returned_axes</span> <span class="o">=</span> <span class="n">disp</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span>
    <span class="n">fig_object</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialize</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">returned_axes</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">returned_axes</span><span class="p">:</span>
            <span class="c1"># Unique figures, preserved in axis order</span>
            <span class="n">unique_figs_ordered</span> <span class="o">=</span> <span class="n">_ordered_unique_figs</span><span class="p">(</span><span class="n">returned_axes</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">unique_figs_ordered</span><span class="p">:</span>     <span class="c1"># at least one valid figure</span>
                <span class="k">if</span> <span class="n">stratify_by</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">facet_plot</span><span class="p">:</span>
                    <span class="c1"># one figure per category  return the ordered list</span>
                    <span class="n">fig_object</span> <span class="o">=</span> <span class="n">unique_figs_ordered</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># single-figure layout (facet grid or no stratify)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_figs_ordered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">fig_object</span> <span class="o">=</span> <span class="n">unique_figs_ordered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># first (and usually only) figure</span>
                    <span class="k">else</span><span class="p">:</span>            <span class="c1"># defensive fallback</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Multiple figures detected in a single-figure &quot;</span>
                            <span class="s2">&quot;scenario; using the first one.&quot;</span>
                        <span class="p">)</span>
                        <span class="c1"># Return the first one</span>
                        <span class="n">fig_object</span> <span class="o">=</span> <span class="n">unique_figs_ordered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># empty list  keep fig_object = None</span>
    <span class="k">elif</span> <span class="n">returned_axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># single Axes  grab its figure</span>
        <span class="n">fig_object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">returned_axes</span><span class="p">,</span> <span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># returned_axes is None  fig_object stays None</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">disp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
        <span class="s1">&#39;fig&#39;</span><span class="p">:</span> <span class="n">fig_object</span><span class="p">,</span>
        <span class="s1">&#39;ax&#39;</span><span class="p">:</span> <span class="n">disp</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">],</span>
        <span class="s1">&#39;palette&#39;</span><span class="p">:</span> <span class="n">plot_specific_palette</span>  <span class="c1"># Return the filtered palette</span>
    <span class="p">}</span></div>


<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>


<div class="viewcode-block" id="present_summary_as_html"><a class="viewcode-back" href="../../spac.html#spac.visualization.present_summary_as_html">[docs]</a><span class="k">def</span> <span class="nf">present_summary_as_html</span><span class="p">(</span><span class="n">summary_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an HTML string that presents the summary information</span>
<span class="sd">    intuitively.</span>

<span class="sd">    For each specified column, the HTML includes:</span>
<span class="sd">      - Column name and data type</span>
<span class="sd">      - Count and list of missing indices</span>
<span class="sd">      - Summary details presented in a table (for numeric: stats;</span>
<span class="sd">        categorical: unique values and counts)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    summary_dict : dict</span>
<span class="sd">        The summary dictionary returned by summarize_dataframe.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        HTML string representing the summary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">html</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Data Summary&lt;/title&gt;&quot;</span>
        <span class="s2">&quot;&lt;style&gt;&quot;</span>
        <span class="s2">&quot;body { font-family: Arial, sans-serif; margin: 20px; }&quot;</span>
        <span class="s2">&quot;table { border-collapse: collapse; width: 100%; &quot;</span>
        <span class="s2">&quot;margin-bottom: 20px; }&quot;</span>
        <span class="s2">&quot;th, td { border: 1px solid #dddddd; text-align: left; &quot;</span>
        <span class="s2">&quot;padding: 8px; }&quot;</span>
        <span class="s2">&quot;th { background-color: #f2f2f2; }&quot;</span>
        <span class="s2">&quot;.section { margin-bottom: 40px; }&quot;</span>
        <span class="s2">&quot;&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&quot;</span>
        <span class="s2">&quot;&lt;h1&gt;Data Summary&lt;/h1&gt;&quot;</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">summary_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;div class=&#39;section&#39;&gt;&lt;h2&gt;Column: </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&lt;/h2&gt;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;strong&gt;Data Type:&lt;/strong&gt; </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;p&gt;&lt;strong&gt;Missing Indices:&lt;/strong&gt; &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;missing_indices&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (Count: &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;count_missing_indices&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&lt;/p&gt;&quot;</span>
            <span class="s2">&quot;&lt;h3&gt;Summary Details:&lt;/h3&gt;&quot;</span>
            <span class="s2">&quot;&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Metric&lt;/th&gt;&lt;th&gt;Value&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&quot;</span>
            <span class="s2">&quot;&lt;tbody&gt;&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;tr&gt;&lt;td&gt;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&lt;/td&gt;&lt;td&gt;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&lt;/td&gt;&lt;/tr&gt;&quot;</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;&quot;</span>

    <span class="n">html</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>
    <span class="k">return</span> <span class="n">html</span></div>


<div class="viewcode-block" id="present_summary_as_figure"><a class="viewcode-back" href="../../spac.html#spac.visualization.present_summary_as_figure">[docs]</a><span class="k">def</span> <span class="nf">present_summary_as_figure</span><span class="p">(</span><span class="n">summary_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a static Plotly figure (using a table) to depict the</span>
<span class="sd">    summary dictionary.</span>

<span class="sd">    The figure includes columns:</span>
<span class="sd">      - Column name</span>
<span class="sd">      - Data type</span>
<span class="sd">      - Count of missing values</span>
<span class="sd">      - Missing indices (as a string)</span>
<span class="sd">      - Summary details (formatted as JSON for readability)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    summary_dict : dict</span>
<span class="sd">        The summary dictionary returned from summarize_dataframe.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plotly.graph_objects.Figure</span>
<span class="sd">        A static Plotly table figure representing the summary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">col_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">missing_counts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">missing_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">summaries</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">summary_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">col_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">data_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;data_type&#39;</span><span class="p">])</span>
        <span class="n">missing_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;count_missing_indices&#39;</span><span class="p">])</span>
        <span class="n">missing_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;missing_indices&#39;</span><span class="p">]))</span>

        <span class="c1"># need to convert nmpy int64 and float64 to native int and float</span>
        <span class="c1"># so that I can dump them as json</span>
        <span class="n">clean_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Check if the value is a NumPy integer</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
                <span class="n">clean_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="c1"># Check if the value is a NumPy float</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">):</span>
                <span class="n">clean_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Keep the value as is if it&#39;s already a standard type</span>
                <span class="n">clean_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="n">summaries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">clean_data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
            <span class="n">header</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;Column&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Data Type&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Missing Count&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Missing Indices&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Summary&quot;</span>
                <span class="p">],</span>
                <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;paleturquoise&#39;</span><span class="p">,</span>
                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
            <span class="p">),</span>
            <span class="n">cells</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">col_names</span><span class="p">,</span>
                    <span class="n">data_types</span><span class="p">,</span>
                    <span class="n">missing_counts</span><span class="p">,</span>
                    <span class="n">missing_indices</span><span class="p">,</span>
                    <span class="n">summaries</span>
                <span class="p">],</span>
                <span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;lavender&#39;</span><span class="p">,</span>
                <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
            <span class="p">)</span>
        <span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">300</span> <span class="o">+</span> <span class="mi">50</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_names</span><span class="p">),</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Data Summary&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Fang Liu, Rui He, and George Zaki.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>